<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Financiero - Multi-Negocio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-button.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .modal { transition: opacity 0.3s ease; }
        .action-button { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 9999px; }
        .action-button:hover { background-color: #f0f0f0; }
        .auth-overlay { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="login-overlay" class="auth-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <div class="text-center mb-6">
                <i class="fas fa-store text-4xl text-indigo-600"></i>
                <h2 class="text-2xl font-bold text-gray-800 mt-4">Acceso al Sistema</h2>
                <p class="text-gray-500 text-sm">Por favor, inicie sesión.</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="sr-only">Correo Electrónico</label>
                    <input type="email" id="email" placeholder="Correo Electrónico" class="w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="sr-only">Contraseña</label>
                    <input type="password" id="password" placeholder="Contraseña" class="w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="business-selector-overlay" class="auth-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 text-center">Seleccionar Negocio</h2>
            <p class="text-gray-500 text-sm text-center mb-6">Elige el local que deseas gestionar.</p>
            <div id="business-list" class="space-y-3">
                </div>
            <div class="mt-6 text-center">
                 <button id="logout-btn-selector" class="text-sm text-gray-600 hover:text-indigo-600">Cerrar Sesión</button>
            </div>
        </div>
    </div>
    
    <div id="app-container" class="hidden">
        <div class="max-w-7xl mx-auto">
            <header class="relative text-center mb-4 no-print">
                 <h1 id="app-title" class="text-3xl md:text-4xl font-bold text-gray-800">📊 Gestión Financiera</h1>
                 <p class="text-gray-600 mt-2">Control de Flujo de Dinero, Compras, Gastos y Deudas.</p>
                 <div class="absolute top-0 right-0 flex items-center space-x-2">
                     <button id="switch-business-btn" class="hidden action-button text-gray-500 hover:text-indigo-600 text-2xl" title="Cambiar de Negocio">
                        <i class="fas fa-exchange-alt"></i>
                     </button>
                     <button id="logout-btn-main" class="action-button text-gray-500 hover:text-red-600 text-2xl" title="Cerrar Sesión">
                         <i class="fas fa-sign-out-alt"></i>
                     </button>
                 </div>
            </header>

            <div class="border-b border-gray-200 mb-6 no-print">
                <nav id="tabs-nav" class="-mb-px flex flex-wrap space-x-6" aria-label="Tabs">
                    <button data-tab="resumen" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-chart-pie mr-2"></i>Resumen</button>
                    <button data-tab="ingresos" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-dollar-sign mr-2"></i>Ingreso</button>
                    <button data-tab="compras" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-shopping-cart mr-2"></i>Compras</button>
                    <button data-tab="gastos" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-receipt mr-2"></i>Gasto Op.</button>
                    <button data-tab="retiros" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-hand-holding-dollar mr-2"></i>Retiro Jefe</button>
                    <button data-tab="deudas" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-book mr-2"></i>Deudas</button>
                    <button data-tab="vales" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-user-tag mr-2"></i>Vales</button>
                    <button data-tab="registros" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-list-ul mr-2"></i>Ver Registros</button>
                </nav>
            </div>

            <main>
                </main>
        </div>
    </div>
    
    <div id="abono-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center p-4"><div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-md bg-white"><h3 class="text-2xl font-semibold mb-6" id="abono-modal-title">Registrar Abono</h3><form id="form-abono"><input type="hidden" id="abono-deuda-id"><input type="hidden" id="abono-type"><div><label class="block text-sm font-medium">Monto a Abonar</label><input type="text" data-moneda inputmode="numeric" id="abono-monto" class="mt-1 block w-full" required></div><div><label class="block text-sm font-medium">Recibido en</label><select id="abono-metodo" class="mt-1 block w-full" required><option value="Efectivo">Efectivo</option><option value="Banco">Banco</option></select></div></form><div class="flex justify-end items-center mt-6 space-x-4"><button id="cancel-abono-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button id="save-abono-btn" class="px-4 py-2 bg-green-600 text-white rounded-md">Registrar Abono</button></div></div></div>
    <div id="notification-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center"><div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div id="notification-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full"></div><h3 id="notification-title" class="text-lg leading-6 font-medium text-gray-900"></h3><div class="mt-2 px-7 py-3"><p id="notification-message" class="text-sm text-gray-500"></p></div><div class="items-center px-4 py-3"><button id="notification-close" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full">Cerrar</button></div></div></div></div>
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center"><div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i></div><h3 id="confirm-title" class="text-lg leading-6 font-medium text-gray-900 mt-4"></h3><div id="confirm-message-container" class="mt-2 px-7 py-3"><p id="confirm-message" class="text-sm text-gray-500"></p></div><div class="flex justify-center items-center px-4 py-3 space-x-4"><button id="cancel-confirm-btn" class="px-4 py-2 bg-gray-200 rounded-md w-full">Cancelar</button><button id="confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md w-full">Confirmar</button></div></div></div></div>
    <div id="historial-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center p-4"><div class="relative mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-md bg-white"><div class="flex justify-between items-start"><div><h3 class="text-2xl font-semibold mb-2" id="historial-modal-title">Historial de Abonos</h3><p class="text-gray-600" id="historial-modal-subtitle"></p></div><button id="cancel-historial-btn" class="p-2 -mt-4 -mr-4"><i class="fas fa-times text-gray-500"></i></button></div><div class="mt-6 overflow-y-auto max-h-96"><table class="w-full text-sm"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-3">Fecha</th><th class="px-4 py-3">Hora</th><th class="px-4 py-3">Monto Abonado</th><th class="px-4 py-3">Recibido en</th></tr></thead><tbody id="historial-abonos-body"></tbody></table></div></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // =========================================================================
    // CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE
    // =========================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCm5BGh7cWX4A5fXx8zCN33ztuLvseRhAU",
        authDomain: "control-licorera.firebaseapp.com",
        databaseURL: "https://control-licorera-default-rtdb.firebaseio.com",
        projectId: "control-licorera",
        storageBucket: "control-licorera.appspot.com",
        messagingSenderId: "430925820415",
        appId: "1:430925820415:web:e1c06bc73b6863a5c3f7ca",
        measurementId: "G-86ZY48XKV4"
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const database = firebase.database();

    // =========================================================================
    // ESTADO GLOBAL Y VARIABLES
    // =========================================================================
    const { jsPDF } = window.jspdf;
    let gastosChart = null;
    let allData = {};
    let dataListeners = [];
    let confirmCallback = null;
    let currentUserProfile = null;
    let selectedBusinessId = null;
    
    const dataTypes = ['ingresos', 'compras', 'gastos', 'retiros', 'cuentasPorCobrar', 'cuentasPorPagar', 'vales'];

    // =========================================================================
    // ELEMENTOS DEL DOM
    // =========================================================================
    const loginForm = document.getElementById('login-form');
    const loginOverlay = document.getElementById('login-overlay');
    const appContainer = document.getElementById('app-container');
    const businessSelectorOverlay = document.getElementById('business-selector-overlay');

    // =========================================================================
    // LÓGICA DE AUTENTICACIÓN
    // =========================================================================
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            try {
                const userProfileRef = database.ref(`users/${user.uid}`);
                const snapshot = await userProfileRef.once('value');
                currentUserProfile = snapshot.val();

                if (!currentUserProfile) {
                    throw new Error('No se encontró el perfil de usuario. Contacte al administrador.');
                }

                loginOverlay.classList.add('hidden');
                if (currentUserProfile.role === 'owner') {
                    await showBusinessSelector();
                } else if (currentUserProfile.role === 'admin' && currentUserProfile.businessId) {
                    await selectBusiness(currentUserProfile.businessId);
                } else {
                    throw new Error('Usuario no autorizado o sin negocio asignado.');
                }
            } catch (error) {
                showNotification('Error de Autenticación', error.message, 'error');
                handleLogout();
            }
        } else {
            showLoginScreen();
        }
    });
    
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorEl = document.getElementById('login-error');
        errorEl.classList.add('hidden');

        auth.signInWithEmailAndPassword(email, password).catch(error => {
            let message = 'Error al iniciar sesión.';
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                message = 'Correo o contraseña incorrectos.';
            }
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        });
    });

    const handleLogout = () => {
        auth.signOut();
    };

    const showLoginScreen = () => {
        loginOverlay.classList.remove('hidden');
        appContainer.classList.add('hidden');
        businessSelectorOverlay.classList.add('hidden');
        detachAllListeners();
    };

    // =========================================================================
    // LÓGICA DE SELECCIÓN DE NEGOCIO
    // =========================================================================
    async function showBusinessSelector() {
        const businessRef = database.ref('businesses');
        const snapshot = await businessRef.once('value');
        const businesses = snapshot.val();
        const businessListDiv = document.getElementById('business-list');
        businessListDiv.innerHTML = '';

        if (businesses) {
            for (const businessId in businesses) {
                const business = businesses[businessId];
                const button = document.createElement('button');
                button.className = 'w-full text-left p-4 bg-gray-100 hover:bg-indigo-100 rounded-lg transition-colors';
                button.innerHTML = `<span class="font-semibold text-lg text-gray-800">${business.name}</span>`;
                button.onclick = () => selectBusiness(businessId);
                businessListDiv.appendChild(button);
            }
        }
        detachAllListeners();
        businessSelectorOverlay.classList.remove('hidden');
        appContainer.classList.add('hidden');
    }

    async function selectBusiness(businessId) {
        if (!businessId) {
            showNotification('Error', 'ID de negocio no válido.', 'error');
            handleLogout();
            return;
        }
        selectedBusinessId = businessId;
        
        const businessNameRef = database.ref(`businesses/${selectedBusinessId}/name`);
        const snapshot = await businessNameRef.once('value');
        const businessName = snapshot.val();
        document.getElementById('app-title').textContent = `📊 Gestión: ${businessName || 'Negocio sin Nombre'}`;

        const switchBtn = document.getElementById('switch-business-btn');
        if (currentUserProfile.role === 'owner') {
            switchBtn.classList.remove('hidden');
        } else {
            switchBtn.classList.add('hidden');
        }
        
        await startDataListeners();
        
        businessSelectorOverlay.classList.add('hidden');
        appContainer.classList.remove('hidden');
    }

    // =========================================================================
    // MANEJO DE DATOS Y PERIODOS
    // =========================================================================
    const detachAllListeners = () => {
        dataListeners.forEach(({ ref, listener }) => ref.off('value', listener));
        dataListeners = [];
    };

    const startDataListeners = async () => {
        detachAllListeners();
        allData = {};

        const allRefs = dataTypes.map(type => {
            const ref = database.ref(`businesses/${selectedBusinessId}/${type}`);
            const listener = ref.on('value', snapshot => {
                allData[type] = firebaseObjectToArray(snapshot);
                refreshUI();
            });
            dataListeners.push({ ref, listener });
        });
        
        const closingsRef = database.ref(`businesses/${selectedBusinessId}/closings`);
        const closingsListener = closingsRef.on('value', async (snapshot) => {
            if (!snapshot.exists()) {
                await closingsRef.child('initial').set(new Date(2000, 0, 1).toISOString());
            } else {
                allData['closings'] = snapshot.val();
            }
            initializeDates();
            refreshUI();
        });
        dataListeners.push({ ref: closingsRef, listener: closingsListener });
    };
    
    const firebaseObjectToArray = (snapshot) => {
        const data = [];
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                const item = childSnapshot.val();
                if (item.fecha) item.fecha = new Date(item.fecha); 
                if(item.abonos) {
                   item.abonos = Object.values(item.abonos).map(abono => ({...abono, fecha: new Date(abono.fecha)}));
                }
                data.push({ id: childSnapshot.key, ...item });
            });
        }
        return data;
    };
    
    // =========================================================================
    // LÓGICA DE CORTE DE MES
    // =========================================================================
    document.getElementById('close-period-btn').addEventListener('click', () => {
        const closings = allData.closings || {};
        const currentMonthKey = document.getElementById('month-filter').value;

        if (closings[currentMonthKey]) {
            showNotification('Info', 'El corte para este mes ya fue realizado.', 'error');
            return;
        }

        const now = new Date();
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const monthName = monthNames[now.getMonth()];

        showConfirm('Confirmar Corte de Mes', `¿Estás seguro de que quieres cerrar el periodo contable de ${monthName}? Esta acción no se puede deshacer.`, () => {
            const closingsRef = database.ref(`businesses/${selectedBusinessId}/closings`);
            closingsRef.child(currentMonthKey).set(now.toISOString())
                .then(() => {
                    showNotification('Éxito', `Periodo de ${monthName} cerrado. Empezando nuevo periodo.`);
                    // Cambiar al mes siguiente en el filtro
                    const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    document.getElementById('month-filter').value = `${nextMonth.getFullYear()}-${String(nextMonth.getMonth() + 1).padStart(2, '0')}`;
                    refreshUI();
                })
                .catch(err => {
                    showNotification('Error', 'No se pudo realizar el corte.', 'error');
                });
        });
    });

    // =========================================================================
    // MANEJO DE UI Y RENDERIZADO
    // =========================================================================
    const refreshUI = () => {
        if(document.getElementById('app-container').classList.contains('hidden')) return;
        filterAndRenderDashboard();
        const activeTabName = document.querySelector('.tab-button.active')?.dataset.tab;
        if (activeTabName === 'registros') renderAllTables();
        else if (activeTabName === 'deudas') { renderCuentasPorCobrar(); renderCuentasPorPagar(); }
        else if (activeTabName === 'vales') renderVales();
    };
    
    const filterAndRenderDashboard = () => {
        const closings = allData.closings || {};
        if (Object.keys(closings).length === 0) return;

        let filterValue = document.getElementById('month-filter').value;
        const [year, month] = filterValue.split('-').map(Number);
        
        // Determinar fecha de inicio del periodo
        const prevMonthDate = new Date(year, month - 2, 1);
        const prevMonthKey = `${prevMonthDate.getFullYear()}-${String(prevMonthDate.getMonth() + 1).padStart(2, '0')}`;
        const startDate = new Date(closings[prevMonthKey] || closings['initial'] || "2000-01-01T00:00:00Z");

        // Determinar fecha de fin del periodo
        const endDate = closings[filterValue] ? new Date(closings[filterValue]) : new Date();

        const periodDisplay = document.getElementById('period-display');
        periodDisplay.textContent = `Mostrando Periodo: ${startDate.toLocaleDateString()} - ${closings[filterValue] ? endDate.toLocaleDateString() : 'Presente'}`;

        const filteredData = {};
        const dataToFilter = ['ingresos', 'compras', 'gastos', 'retiros'];
        dataToFilter.forEach(key => {
            filteredData[key] = (allData[key] || []).filter(d => d.fecha >= startDate && d.fecha < endDate);
        });
        updateDashboard(filteredData.ingresos, filteredData.compras, filteredData.gastos, filteredData.retiros, allData.cuentasPorCobrar, allData.cuentasPorPagar);
    };

    const updateDashboard = (ingresos, compras, gastos, retiros, cpc, cpp) => {
        const totalIngresosMes = (ingresos || []).reduce((sum, item) => sum + (item.monto || 0), 0);
        const totalComprasMes = (compras || []).reduce((sum, item) => sum + (item.monto || 0), 0);
        const totalGastosOpMes = (gastos || []).reduce((sum, item) => sum + (item.monto || 0), 0);
        const totalRetirosMes = (retiros || []).reduce((sum, item) => sum + (item.monto || 0), 0);
        
        const totalIngresosEfectivo = (allData.ingresos || []).reduce((sum, i) => sum + (i.monto_efectivo || 0), 0);
        const totalIngresosBanco = (allData.ingresos || []).reduce((sum, i) => sum + (i.monto_tarjeta || 0), 0);
        const totalComprasEfectivo = (allData.compras || []).filter(c => c.metodo === 'Efectivo').reduce((sum, c) => sum + (c.monto || 0), 0);
        const totalComprasBanco = (allData.compras || []).filter(c => c.metodo === 'Banco').reduce((sum, c) => sum + (c.monto || 0), 0);
        const totalGastosOp = (allData.gastos || []).reduce((sum, g) => sum + (g.monto || 0), 0);
        const totalRetirosEfectivo = (allData.retiros || []).filter(r => r.metodo === 'Efectivo').reduce((sum, r) => sum + (r.monto || 0), 0);
        const totalRetirosBanco = (allData.retiros || []).filter(r => r.metodo === 'Banco').reduce((sum, r) => sum + (r.monto || 0), 0);
        
        const efectivoEnCaja = totalIngresosEfectivo - totalComprasEfectivo - totalGastosOp - totalRetirosEfectivo;
        const saldoEnBanco = totalIngresosBanco - totalComprasBanco - totalRetirosBanco;
        
        const totalCPC = (cpc || []).reduce((sum, d) => sum + ((d.monto || 0) - ((d.abonos || []).reduce((s, a) => s + (a.monto || 0), 0))), 0);
        const totalCPP = (cpp || []).filter(d => d.estado !== 'Pagada').reduce((sum, d) => sum + (d.monto || 0), 0);
        
        document.getElementById('total-ingresos').textContent = formatCurrency(totalIngresosMes);
        document.getElementById('total-compras').textContent = formatCurrency(totalComprasMes);
        document.getElementById('total-gastos-op').textContent = formatCurrency(totalGastosOpMes);
        document.getElementById('total-retiros').textContent = formatCurrency(totalRetirosMes);
        document.getElementById('efectivo-caja').textContent = formatCurrency(efectivoEnCaja);
        document.getElementById('saldo-banco').textContent = formatCurrency(saldoEnBanco);
        document.getElementById('cuentas-cobrar-total').textContent = formatCurrency(totalCPC);
        document.getElementById('cuentas-pagar-total').textContent = formatCurrency(totalCPP);

        const allMovements = [...(allData.ingresos || []), ...(allData.compras || []), ...(allData.gastos || []), ...(allData.retiros || [])].sort((a,b) => b.fecha - a.fecha).slice(0,10);
        const tbody = document.getElementById('ultimos-movimientos-body');
        tbody.innerHTML = allMovements.length === 0 ? `<tr><td colspan="3" class="text-center py-4 text-gray-500">No hay movimientos.</td></tr>` : '';
        allMovements.forEach(mov => {
            const tr = document.createElement('tr'); tr.className = 'bg-white border-b';
            const type = mov.monto_efectivo !== undefined ? 'ingreso' : (mov.proveedor !== undefined ? 'compra' : (mov.categoria !== undefined ? 'gasto' : 'retiro'));
            const desc = mov.notas || mov.descripcion || mov.proveedor || `Venta del día`;
            const montoClass = type === 'ingreso' ? 'text-green-600' : (type === 'compra' ? 'text-purple-600' : (type === 'gasto' ? 'text-red-600' : 'text-orange-500'));
            tr.innerHTML = `<td class="px-6 py-4">${mov.fecha.toLocaleDateString()}</td><td class="px-6 py-4">${desc}</td><td class="px-6 py-4 font-medium ${montoClass}">${formatCurrency(mov.monto)}</td>`;
            tbody.appendChild(tr);
        });
        updateGastosChart(gastos);
    };

    const updateGastosChart = (gastos) => {
        const ctx = document.getElementById('gastos-chart').getContext('2d');
        if (gastosChart) gastosChart.destroy();
        const dataPorCategoria = (gastos || []).reduce((acc, gasto) => { acc[gasto.categoria] = (acc[gasto.categoria] || 0) + gasto.monto; return acc; }, {});
        if (Object.keys(dataPorCategoria).length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.save(); ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = '#6b7280'; ctx.font = "16px 'Inter'"; ctx.fillText("No hay gastos para mostrar.", ctx.canvas.width / 2, ctx.canvas.height / 2); ctx.restore(); return; }
        gastosChart = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(dataPorCategoria), datasets: [{ data: Object.values(dataPorCategoria), backgroundColor: ['#ef4444', '#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#f59e0b', '#ec4899', '#6366f1', '#84cc16'], hoverOffset: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'top' }}} });
    };

    const changeTab = (tabName) => {
        setFormDatesToToday();
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(tabName).classList.remove('hidden');
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`button[data-tab="${tabName}"]`).classList.add('active');

        if (tabName === 'registros') renderAllTables();
        else if (tabName === 'deudas') { renderCuentasPorCobrar(); renderCuentasPorPagar(); }
        else if (tabName === 'vales') renderVales();
    };

    const formatCurrency = (value) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value || 0);
    const formatDateForInput = (date) => new Date(date).toISOString().split('T')[0];
    
    const formatInputAsCurrency = (e) => {
        let input = e.target;
        let value = input.value.replace(/\D/g, ''); 
        if (value) {
            const number = parseInt(value, 10);
            input.value = number.toLocaleString('es-CO');
        } else {
            input.value = '';
        }
    };

    const getNumericValue = (formattedValue) => {
        if (!formattedValue || typeof formattedValue !== 'string') return 0;
        return parseFloat(formattedValue.replace(/\./g, ''));
    };

    const addCurrencyFormatting = (container) => {
        container.querySelectorAll('[data-moneda]').forEach(input => {
            input.removeEventListener('input', formatInputAsCurrency);
            input.addEventListener('input', formatInputAsCurrency);
        });
    };

    const renderAllTables = () => {
        renderTable('ingresos', document.getElementById('tabla-ingresos'), ['Fecha', 'Efectivo', 'Tarjeta', 'Total', 'Notas', 'Acciones']);
        renderTable('compras', document.getElementById('tabla-compras'), ['Fecha', 'Proveedor', 'Descripción', 'Monto', 'Pagado con', 'Acciones']);
        renderTable('gastos', document.getElementById('tabla-gastos'), ['Fecha', 'Descripción', 'Categoría', 'Monto', 'Acciones']);
        renderTable('retiros', document.getElementById('tabla-retiros'), ['Fecha', 'Retirado de', 'Descripción', 'Monto', 'Acciones']);
    };
    
    const renderTable = (type, tableEl, headers) => {
        const data = (allData[type] || []).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        tableEl.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${headers.map(h => `<th class="px-4 py-3">${h}</th>`).join('')}</tr></thead><tbody></tbody>`;
        const tbody = tableEl.querySelector('tbody');
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">No hay registros de ${type}.</td></tr>`;
            return;
        }
        const rowsHTML = data.map(item => {
            let cellsHTML = '';
            if (type === 'ingresos') cellsHTML = `<td class="px-4 py-3">${item.fecha.toLocaleDateString()}</td><td class="px-4 py-3">${formatCurrency(item.monto_efectivo)}</td><td class="px-4 py-3">${formatCurrency(item.monto_tarjeta)}</td><td class="px-4 py-3 font-bold">${formatCurrency(item.monto)}</td><td class="px-4 py-3">${item.notas || '-'}</td>`;
            else if (type === 'compras') cellsHTML = `<td class="px-4 py-3">${item.fecha.toLocaleDateString()}</td><td class="px-4 py-3">${item.proveedor}</td><td class="px-4 py-3">${item.descripcion}</td><td class="px-4 py-3">${formatCurrency(item.monto)}</td><td class="px-4 py-3">${item.metodo}</td>`;
            else if (type === 'gastos') cellsHTML = `<td class="px-4 py-3">${item.fecha.toLocaleDateString()}</td><td class="px-4 py-3">${item.descripcion}</td><td class="px-4 py-3">${item.categoria}</td><td class="px-4 py-3">${formatCurrency(item.monto)}</td>`;
            else if (type === 'retiros') cellsHTML = `<td class="px-4 py-3">${item.fecha.toLocaleDateString()}</td><td class="px-4 py-3">${item.metodo}</td><td class="px-4 py-3">${item.descripcion}</td><td class="px-4 py-3">${formatCurrency(item.monto)}</td>`;
            cellsHTML += `<td class="px-4 py-3 flex items-center space-x-2"><button class="action-button text-red-600 delete-btn" data-type="${type}" data-id="${item.id}"><i class="fas fa-trash"></i></button></td>`;
            return `<tr class="bg-white border-b hover:bg-gray-50">${cellsHTML}</tr>`;
        }).join('');
        tbody.innerHTML = rowsHTML;
    };

    const renderCuentasPorCobrar = () => {
        const table = document.getElementById('tabla-cuentas-cobrar');
        const headers = ['Cliente', 'Total Deuda', 'Abonado', 'Restante', 'Acciones'];
        table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${headers.map(h => `<th class="px-4 py-3">${h}</th>`).join('')}</tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');
        const data = (allData.cuentasPorCobrar || []).sort((a,b) => b.fecha - a.fecha);

        if (data.length === 0) { 
            tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">No hay cuentas por cobrar.</td></tr>`; 
            return;
        }

        const rowsHTML = data.map(d => {
            const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0);
            const restante = d.monto - totalAbonado;
            const isPaid = restante <= 0;

            const rowClass = isPaid ? 'bg-gray-100 text-gray-500' : 'bg-white';
            const textStyle = isPaid ? 'line-through' : '';
            const actionButtons = isPaid 
                ? `<button class="historial-btn action-button text-blue-600" data-type="cuentasPorCobrar" data-id="${d.id}" title="Ver Historial"><i class="fas fa-history"></i></button> <span class="px-2 py-1 text-xs font-semibold leading-tight text-green-700 bg-green-100 rounded-full">Saldado</span>`
                : `<button class="historial-btn action-button text-blue-600" data-type="cuentasPorCobrar" data-id="${d.id}" title="Ver Historial"><i class="fas fa-history"></i></button>
                   <button class="abono-btn action-button text-green-600" data-type="cuentasPorCobrar" data-id="${d.id}" title="Registrar Abono"><i class="fas fa-plus-circle"></i></button>
                   <button class="delete-btn action-button text-red-600" data-type="cuentasPorCobrar" data-id="${d.id}" title="Eliminar"><i class="fas fa-trash"></i></button>`;
            
            return `<tr class="${rowClass} border-b hover:bg-gray-50">
                <td class="px-4 py-3 font-medium ${textStyle}">${d.cliente}<p class="text-xs font-normal">${d.descripcion}</p></td>
                <td class="px-4 py-3 ${textStyle}">${formatCurrency(d.monto)}</td>
                <td class="px-4 py-3 text-green-600 ${textStyle}">${formatCurrency(totalAbonado)}</td>
                <td class="px-4 py-3 font-bold ${textStyle}">${formatCurrency(restante)}</td>
                <td class="px-4 py-3 flex items-center gap-1">${actionButtons}</td>
            </tr>`;
        }).join('');
        tbody.innerHTML = rowsHTML;
    };
    
    const renderCuentasPorPagar = () => {
        const table = document.getElementById('tabla-cuentas-pagar');
        const headers = ['Proveedor', 'Concepto', 'Monto', 'Estado', 'Acciones'];
        table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${headers.map(h => `<th class="px-4 py-3">${h}</th>`).join('')}</tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');
        const data = (allData.cuentasPorPagar || []).sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

        if (data.length === 0) { 
            tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">No hay cuentas por pagar.</td></tr>`; 
            return;
        }

        const rowsHTML = data.map(d => {
            const isPaid = d.estado === 'Pagada';
            const rowClass = isPaid ? 'bg-gray-100 text-gray-500' : 'bg-white';
            const textStyle = isPaid ? 'line-through' : '';
            const statusBadge = isPaid 
                ? `<span class="px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full">Pagada</span>`
                : `<span class="px-2 py-1 font-semibold leading-tight text-red-700 bg-red-100 rounded-full">Pendiente</span>`;
            const actionButtons = isPaid 
                ? `<span class="text-xs text-gray-400">Completado</span>` 
                : `<div class="flex items-center gap-2">
                    <button class="pagar-btn bg-blue-500 text-white text-xs px-2 py-1 rounded-md hover:bg-blue-600" data-id="${d.id}">Pagar</button>
                    <button class="delete-btn action-button text-red-600" data-type="cuentasPorPagar" data-id="${d.id}"><i class="fas fa-trash"></i></button>
                   </div>`;

            return `<tr class="${rowClass} border-b">
                <td class="px-4 py-3 font-medium ${textStyle}">${d.acreedor}</td>
                <td class="px-4 py-3 ${textStyle}">${d.descripcion}</td>
                <td class="px-4 py-3 ${textStyle}">${formatCurrency(d.monto)}</td>
                <td class="px-4 py-3">${statusBadge}</td>
                <td class="px-4 py-3">${actionButtons}</td>
            </tr>`;
        }).join('');
        tbody.innerHTML = rowsHTML;
    };
    
    const renderVales = () => {
        const table = document.getElementById('tabla-vales');
        const headers = ['Persona', 'Total Vale', 'Abonado', 'Restante', 'Acciones'];
        table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${headers.map(h => `<th class="px-4 py-3">${h}</th>`).join('')}</tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');
        const data = (allData.vales || []).sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

        if (data.length === 0) { 
            tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">No hay vales registrados.</td></tr>`; 
            return;
        }

        const rowsHTML = data.map(d => {
            const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0);
            const restante = d.monto - totalAbonado;
            const isPaid = restante <= 0;

            const rowClass = isPaid ? 'bg-gray-100 text-gray-500' : 'bg-white';
            const textStyle = isPaid ? 'line-through' : '';
            const actionButtons = isPaid 
                ? `<button class="historial-btn action-button text-blue-600" data-type="vales" data-id="${d.id}" title="Ver Historial"><i class="fas fa-history"></i></button> <span class="px-2 py-1 text-xs font-semibold leading-tight text-green-700 bg-green-100 rounded-full">Saldado</span>`
                : `<button class="historial-btn action-button text-blue-600" data-type="vales" data-id="${d.id}" title="Ver Historial"><i class="fas fa-history"></i></button>
                   <button class="abono-btn action-button text-green-600" data-type="vales" data-id="${d.id}" title="Registrar Abono"><i class="fas fa-plus-circle"></i></button>
                   <button class="delete-btn action-button text-red-600" data-type="vales" data-id="${d.id}" title="Eliminar Vale"><i class="fas fa-trash"></i></button>`;
            
            return `<tr class="${rowClass} border-b hover:bg-gray-50">
                <td class="px-4 py-3 font-medium ${textStyle}">${d.persona}<p class="text-xs font-normal">${d.descripcion}</p></td>
                <td class="px-4 py-3 ${textStyle}">${formatCurrency(d.monto)}</td>
                <td class="px-4 py-3 text-green-600 ${textStyle}">${formatCurrency(totalAbonado)}</td>
                <td class="px-4 py-3 font-bold ${textStyle}">${formatCurrency(restante)}</td>
                <td class="px-4 py-3 flex items-center gap-1">${actionButtons}</td>
            </tr>`;
        }).join('');
        tbody.innerHTML = rowsHTML;
    };
    
    const getTimestampFromDateInput = (dateInputId) => {
        const dateValue = document.getElementById(dateInputId).value;
        const now = new Date();
        const [year, month, day] = dateValue.split('-').map(Number);
        return new Date(year, month - 1, day, now.getHours(), now.getMinutes(), now.getSeconds()).toISOString();
    };

    const setFormDatesToToday = () => {
        const today = formatDateForInput(new Date());
        ['ingreso-fecha', 'gasto-fecha', 'compra-fecha', 'retiro-fecha'].forEach(id => { 
            const el = document.getElementById(id);
            if (el) el.value = today;
        });
    };

    const initializeDates = () => {
        setFormDatesToToday();
        const now = new Date();
        document.getElementById('month-filter').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    };

    const getRefFor = (type) => database.ref(`businesses/${selectedBusinessId}/${type}`);

    document.getElementById('form-ingresos').addEventListener('submit', (e) => { e.preventDefault(); const ef = getNumericValue(document.getElementById('ingreso-efectivo').value); const ta = getNumericValue(document.getElementById('ingreso-tarjeta').value); const newData = { fecha: getTimestampFromDateInput('ingreso-fecha'), monto: ef + ta, monto_efectivo: ef, monto_tarjeta: ta, notas: document.getElementById('ingreso-notas').value }; getRefFor('ingresos').push(newData); showNotification('Éxito', 'Ingreso registrado.'); e.target.reset(); addCurrencyFormatting(e.target); changeTab('resumen'); });
    document.getElementById('form-compras').addEventListener('submit', (e) => { e.preventDefault(); const newData = { fecha: getTimestampFromDateInput('compra-fecha'), proveedor: document.getElementById('compra-proveedor').value, descripcion: document.getElementById('compra-descripcion').value, monto: getNumericValue(document.getElementById('compra-monto').value), metodo: document.getElementById('compra-metodo').value }; getRefFor('compras').push(newData); showNotification('Éxito', 'Compra registrada.'); e.target.reset(); addCurrencyFormatting(e.target); changeTab('resumen'); });
    document.getElementById('form-gastos').addEventListener('submit', (e) => { e.preventDefault(); const newData = { fecha: getTimestampFromDateInput('gasto-fecha'), descripcion: document.getElementById('gasto-descripcion').value, categoria: document.getElementById('gasto-categoria').value, monto: getNumericValue(document.getElementById('gasto-monto').value) }; getRefFor('gastos').push(newData); showNotification('Éxito', 'Gasto registrado.'); e.target.reset(); addCurrencyFormatting(e.target); changeTab('resumen'); });
    document.getElementById('form-retiros').addEventListener('submit', (e) => { e.preventDefault(); const newData = { fecha: getTimestampFromDateInput('retiro-fecha'), metodo: document.getElementById('retiro-metodo').value, descripcion: document.getElementById('retiro-descripcion').value, monto: getNumericValue(document.getElementById('retiro-monto').value) }; getRefFor('retiros').push(newData); showNotification('Éxito', 'Retiro registrado.'); e.target.reset(); addCurrencyFormatting(e.target); changeTab('resumen'); });
    document.getElementById('form-cuentas-cobrar').addEventListener('submit', (e) => { e.preventDefault(); const newData = { fecha: new Date().toISOString(), cliente: document.getElementById('cpc-cliente').value, descripcion: document.getElementById('cpc-descripcion').value, monto: getNumericValue(document.getElementById('cpc-monto').value), abonos: {} }; getRefFor('cuentasPorCobrar').push(newData); showNotification('Éxito', 'Deuda por cobrar registrada.'); e.target.reset(); addCurrencyFormatting(e.target); });
    document.getElementById('form-cuentas-pagar').addEventListener('submit', (e) => { e.preventDefault(); const newData = { fecha: new Date().toISOString(), acreedor: document.getElementById('cpp-acreedor').value, descripcion: document.getElementById('cpp-descripcion').value, monto: getNumericValue(document.getElementById('cpp-monto').value), estado: 'Pendiente' }; getRefFor('cuentasPorPagar').push(newData); showNotification('Éxito', 'Cuenta por pagar registrada.'); e.target.reset(); addCurrencyFormatting(e.target); });
    document.getElementById('form-vales').addEventListener('submit', (e) => { e.preventDefault(); const newData = { fecha: new Date().toISOString(), persona: document.getElementById('vale-persona').value, descripcion: document.getElementById('vale-descripcion').value, monto: getNumericValue(document.getElementById('vale-monto').value), abonos: {} }; getRefFor('vales').push(newData); showNotification('Éxito', 'Vale registrado correctamente.'); e.target.reset(); addCurrencyFormatting(e.target); });

    const handleDelete = (type, id) => {
        const item = (allData[type] || []).find(i => i.id === id);
        if (!item) return;

        if ((type === 'cuentasPorCobrar' || type === 'vales') && item.abonos && Object.keys(item.abonos).length > 0) {
            showNotification('Acción no permitida', 'No puede eliminar un registro que ya tiene abonos. Esto protege la integridad de sus registros de ingresos.', 'error');
            return;
        }

        showConfirm('Confirmar Eliminación', '¿Estás seguro? Esta acción no se puede deshacer.', () => {
            getRefFor(type).child(id).remove()
                .then(() => showNotification('Éxito', 'Registro eliminado.'))
                .catch((error) => showNotification('Error', 'No se pudo eliminar: ' + error, 'error'));
        });
    };

    const handleAbonar = (deudaId, type) => {
        document.getElementById('abono-deuda-id').value = deudaId;
        document.getElementById('abono-type').value = type;
        document.getElementById('abono-modal-title').textContent = type === 'vales' ? 'Registrar Abono a Vale' : 'Registrar Abono';
        document.getElementById('abono-modal').style.display = 'flex';
        addCurrencyFormatting(document.getElementById('abono-modal')); 
    };

    const handleHistorial = (deudaId, type) => {
        const deuda = (allData[type] || []).find(d => d.id === deudaId);
        if (!deuda) return;

        const modal = document.getElementById('historial-modal');
        const personKey = type === 'vales' ? 'persona' : 'cliente';
        document.getElementById('historial-modal-subtitle').textContent = `Detalle para: ${deuda[personKey]} | Total: ${formatCurrency(deuda.monto)}`;
        
        const tbody = document.getElementById('historial-abonos-body');
        const abonos = (deuda.abonos || []).sort((a,b) => b.fecha - a.fecha);

        if (abonos.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No se han registrado abonos.</td></tr>`;
        } else {
            tbody.innerHTML = abonos.map(abono => `
                <tr class="border-b">
                    <td class="px-4 py-3">${abono.fecha.toLocaleDateString('es-CO')}</td>
                    <td class="px-4 py-3">${abono.fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' })}</td>
                    <td class="px-4 py-3 font-medium">${formatCurrency(abono.monto)}</td>
                    <td class="px-4 py-3">${abono.metodo}</td>
                </tr>`).join('');
        }
        modal.style.display = 'flex';
    };

    document.getElementById('save-abono-btn').addEventListener('click', async () => {
        const deudaId = document.getElementById('abono-deuda-id').value;
        const type = document.getElementById('abono-type').value;
        const monto = getNumericValue(document.getElementById('abono-monto').value);
        const metodo = document.getElementById('abono-metodo').value;

        if (!deudaId || !type || monto <= 0) {
            showNotification('Error', 'Monto inválido o datos incompletos.', 'error');
            return;
        }

        try {
            const abonoData = { fecha: new Date().toISOString(), monto, metodo };
            await getRefFor(type).child(deudaId).child('abonos').push(abonoData);

            const snapshot = await getRefFor(type).child(deudaId).once('value');
            const deuda = snapshot.val();
            if (!deuda) throw new Error("Registro no encontrado.");
            
            const personKey = type === 'vales' ? 'persona' : 'cliente';
            const personName = deuda[personKey];
            
            const ingresoData = {
                fecha: new Date().toISOString(),
                monto: monto,
                monto_efectivo: metodo === 'Efectivo' ? monto : 0,
                monto_tarjeta: metodo === 'Banco' ? monto : 0,
                notas: `Abono de ${type === 'vales' ? 'vale' : 'deuda'}: ${personName}`
            };
            await getRefFor('ingresos').push(ingresoData);
            
            showNotification('Éxito', 'Abono registrado y añadido a ingresos.');
            document.getElementById('abono-modal').style.display = 'none';
            document.getElementById('form-abono').reset();
            document.getElementById('abono-monto').value = '';

        } catch (err) {
            showNotification('Error', 'No se pudo completar la operación.', 'error');
        }
    });

    const handlePagar = (deudaId) => {
        const deuda = (allData.cuentasPorPagar || []).find(d => d.id === deudaId);
        if (!deuda) return;
        showConfirm('Confirmar Pago', `¿Cómo se pagó esta cuenta de ${formatCurrency(deuda.monto)} a ${deuda.acreedor}?`, (metodo) => {
            if (metodo) {
                const compraData = {
                    fecha: new Date().toISOString(),
                    proveedor: deuda.acreedor,
                    descripcion: `Pago Cta. Pendiente: ${deuda.descripcion}`,
                    monto: deuda.monto,
                    metodo: metodo
                };
                getRefFor('compras').push(compraData);
                getRefFor('cuentasPorPagar').child(deudaId).update({ estado: 'Pagada' });
                showNotification('Éxito', `Cuenta pagada y registrada como compra.`);
            }
        }, true);
    };

    const showNotification = (title, message, type = 'success') => {
         const modal = document.getElementById('notification-modal'); document.getElementById('notification-title').textContent = title; document.getElementById('notification-message').textContent = message; document.getElementById('notification-icon').innerHTML = type === 'success' ? `<i class="fas fa-check-circle text-4xl text-green-500"></i>` : `<i class="fas fa-times-circle text-4xl text-red-500"></i>`; modal.style.display = 'flex';
    };
    const showConfirm = (title, message, callback, showOptions = false) => {
        const modal = document.getElementById('confirm-modal');
        document.getElementById('confirm-title').textContent = title;
        const msgContainer = document.getElementById('confirm-message-container');
        msgContainer.innerHTML = `<p id="confirm-message" class="text-sm text-gray-500">${message}</p>`;
        if (showOptions) {
            msgContainer.insertAdjacentHTML('beforeend', `<div class="mt-4"><select id="confirm-options" class="block w-full rounded-md border-gray-300 shadow-sm"><option value="Efectivo">Efectivo</option><option value="Banco">Banco</option></select></div>`);
        }
        confirmCallback = () => {
            const optionsEl = document.getElementById('confirm-options');
            callback(showOptions ? optionsEl.value : true);
        };
        modal.style.display = 'flex';
    };
    const cleanupConfirmModal = () => {
         const modal = document.getElementById('confirm-modal');
         const customContent = document.querySelector('#confirm-message-container > div');
         if (customContent) customContent.remove();
         modal.style.display = 'none';
         confirmCallback = null;
    };
    document.getElementById('notification-close').onclick = () => document.getElementById('notification-modal').style.display = 'none';
    document.getElementById('cancel-confirm-btn').onclick = cleanupConfirmModal;
    document.getElementById('confirm-btn').addEventListener('click', () => { if (confirmCallback) { confirmCallback(); } cleanupConfirmModal(); });
    document.getElementById('cancel-abono-btn').onclick = () => document.getElementById('abono-modal').style.display = 'none';
    document.getElementById('cancel-historial-btn').onclick = () => document.getElementById('historial-modal').style.display = 'none';
    document.getElementById('logout-btn-main').addEventListener('click', handleLogout);
    document.getElementById('logout-btn-selector').addEventListener('click', handleLogout);
    document.getElementById('switch-business-btn').addEventListener('click', showBusinessSelector);

    document.getElementById('month-filter').addEventListener('change', refreshUI);
    document.body.addEventListener('click', (e) => {
        const target = e.target;
        const deleteBtn = target.closest('.delete-btn');
        const pdfBtn = target.closest('.btn-pdf');
        const tabBtn = target.closest('.tab-button');
        const abonoBtn = target.closest('.abono-btn');
        const pagarBtn = target.closest('.pagar-btn');
        const historialBtn = target.closest('.historial-btn');
        
        if (tabBtn) changeTab(tabBtn.dataset.tab);
        else if (deleteBtn) handleDelete(deleteBtn.dataset.type, deleteBtn.dataset.id);
        else if (pdfBtn) {
            const type = pdfBtn.dataset.type;
            if (type === 'deudas-cobrar') exportDeudasPDF('cuentasPorCobrar');
            else if (type === 'deudas-pagar') exportDeudasPDF('cuentasPorPagar');
            else if (type === 'vales') exportDeudasPDF('vales');
            else exportToPDF(type);
        }
        else if (abonoBtn) handleAbonar(abonoBtn.dataset.id, abonoBtn.dataset.type);
        else if (pagarBtn) handlePagar(pagarBtn.dataset.id);
        else if (historialBtn) handleHistorial(historialBtn.dataset.id, historialBtn.dataset.type);
    });

    const exportToPDF = (type) => {
        const doc = new jsPDF();
        const data = (allData[type] || []).sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
        if(data.length === 0){ showNotification('Info', 'No hay datos para exportar.', 'error'); return; }
        
        const title = `Informe de ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        doc.setFontSize(18); doc.text(title, 14, 22);
        doc.setFontSize(11); doc.setTextColor(100); doc.text(`Generado el: ${new Date().toLocaleDateString('es-CO')}`, 14, 28);
        let startY = 35;

        if (type === 'ingresos') {
            const ingresosEfectivo = data.filter(i => i.monto_efectivo > 0);
            const ingresosTarjeta = data.filter(i => i.monto_tarjeta > 0);
            const totalEfectivo = ingresosEfectivo.reduce((sum, i) => sum + i.monto_efectivo, 0);
            const totalTarjeta = ingresosTarjeta.reduce((sum, i) => sum + i.monto_tarjeta, 0);

            doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text('Ingresos en Efectivo', 14, startY);
            doc.autoTable({ head: [['Fecha', 'Notas', 'Monto']], body: ingresosEfectivo.map(i => [i.fecha.toLocaleDateString(), i.notas || '-', formatCurrency(i.monto_efectivo)]), startY: startY + 2 });
            
            startY = doc.autoTable.previous.finalY + 5;
            doc.setFontSize(12); doc.setFont(undefined, 'bold');
            doc.text('Total Efectivo:', 14, startY);
            doc.text(formatCurrency(totalEfectivo), 200, startY, { align: 'right' });
            startY += 15;

            if (startY > 250) { doc.addPage(); startY = 20; }

            doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text('Ingresos por Tarjeta/Transferencia', 14, startY);
            doc.autoTable({ head: [['Fecha', 'Notas', 'Monto']], body: ingresosTarjeta.map(i => [i.fecha.toLocaleDateString(), i.notas || '-', formatCurrency(i.monto_tarjeta)]), startY: startY + 2 });

            startY = doc.autoTable.previous.finalY + 5;
            doc.setFontSize(12); doc.setFont(undefined, 'bold');
            doc.text('Total Tarjeta/Transf.:', 14, startY);
            doc.text(formatCurrency(totalTarjeta), 200, startY, { align: 'right' });
            startY += 15;
            
            if (startY > 250) { doc.addPage(); startY = 20; }

            doc.setLineWidth(0.5); doc.line(14, startY, 200, startY); startY += 10;
            doc.setFontSize(14); doc.setFont(undefined, 'bold');
            doc.text('CONSOLIDADO GLOBAL', 14, startY);
            doc.setFontSize(12); doc.setFont(undefined, 'normal');
            doc.text(`Total Efectivo:`, 14, startY + 7);
            doc.text(formatCurrency(totalEfectivo), 200, startY + 7, { align: 'right' });
            doc.text(`Total Tarjeta/Transf.:`, 14, startY + 14);
            doc.text(formatCurrency(totalTarjeta), 200, startY + 14, { align: 'right' });
            doc.setFont(undefined, 'bold');
            doc.text(`Venta Global:`, 14, startY + 21);
            doc.text(formatCurrency(totalEfectivo + totalTarjeta), 200, startY + 21, { align: 'right' });

        } else if (type === 'retiros') {
            const head = [['Fecha', 'Hora', 'Retirado de', 'Descripción', 'Monto']];
            const body = data.map(r => [
                r.fecha.toLocaleDateString('es-CO'),
                r.fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' }),
                r.metodo,
                r.descripcion,
                formatCurrency(r.monto)
            ]);
            doc.autoTable({ head, body, startY: 35 });

            const grandTotal = data.reduce((sum, r) => sum + r.monto, 0);
            let finalY = doc.autoTable.previous.finalY;

            doc.setLineWidth(0.5);
            doc.line(14, finalY + 8, 200, finalY + 8);
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Gran Total de Retiros:', 14, finalY + 15);
            doc.text(formatCurrency(grandTotal), 200, finalY + 15, { align: 'right' });
        
        } else { // Gastos y Compras
            const groupKey = type === 'gastos' ? 'categoria' : 'proveedor';
            const groupedData = data.reduce((acc, item) => {
                const key = item[groupKey];
                if (!acc[key]) acc[key] = [];
                acc[key].push(item);
                return acc;
            }, {});

            let grandTotal = 0;
            for (const groupName in groupedData) {
                if (startY > 250) { doc.addPage(); startY = 20; }
                const items = groupedData[groupName];
                const subTotal = items.reduce((sum, item) => sum + item.monto, 0);
                grandTotal += subTotal;
                doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text(groupName, 14, startY);
                const head = type === 'gastos' ? [['Fecha', 'Descripción', 'Monto']] : [['Fecha', 'Descripción', 'Pagado con', 'Monto']];
                const body = items.map(item => type === 'gastos' ? [item.fecha.toLocaleDateString(), item.descripcion, formatCurrency(item.monto)] : [item.fecha.toLocaleDateString(), item.descripcion, item.metodo, formatCurrency(item.monto)]);
                doc.autoTable({ head, body, startY: startY + 2, theme: 'striped', headStyles: { fillColor: [52, 73, 94] } });
                startY = doc.autoTable.previous.finalY + 2;
                doc.setFontSize(10); doc.setFont(undefined, 'bold');
                doc.text(`Subtotal ${groupName}: ${formatCurrency(subTotal)}`, 196, startY, { align: 'right' });
                startY += 10;
            }
            
            doc.setLineWidth(0.5); doc.line(14, startY, 200, startY); startY += 8;
            doc.setFontSize(16); doc.setFont(undefined, 'bold');
            doc.text('GRAN TOTAL:', 14, startY);
            doc.text(formatCurrency(grandTotal), 200, startY, { align: 'right' });
        }
        doc.save(`Informe_${type}_${formatDateForInput(new Date())}.pdf`);
    };

    const exportDeudasPDF = (type) => {
        const doc = new jsPDF();
        const genDate = `Generado el: ${new Date().toLocaleDateString('es-CO')}`;
        const data = allData[type];
        if(!data || data.length === 0){ showNotification('Info', 'No hay datos para exportar.', 'error'); return; }

        if (type === 'cuentasPorCobrar') {
            doc.setFontSize(18); doc.text('Reporte de Cuentas por Cobrar', 14, 22);
            doc.setFontSize(11); doc.setTextColor(100); doc.text(genDate, 14, 28);
            const head = [['Cliente', 'Descripción', 'Deuda Total', 'Total Abonado', 'Saldo Pendiente']];
            const body = data.map(d => {
                const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0);
                return [d.cliente, d.descripcion, formatCurrency(d.monto), formatCurrency(totalAbonado), formatCurrency(d.monto - totalAbonado)];
            });
            const saldoTotal = data.reduce((sum, d) => sum + (d.monto - (d.abonos || []).reduce((s, a) => s + a.monto, 0)), 0);
            doc.autoTable({ head, body, startY: 35 });
            doc.setFontSize(12); doc.setFont(undefined, 'bold');
            doc.text(`Saldo Total por Cobrar:`, 14, doc.autoTable.previous.finalY + 10);
            doc.text(formatCurrency(saldoTotal), 200, doc.autoTable.previous.finalY + 10, { align: 'right' });
            doc.save(`Reporte_Cuentas_por_Cobrar_${formatDateForInput(new Date())}.pdf`);

        } else if (type === 'vales') {
            doc.setFontSize(18); doc.text('Reporte de Vales de Personal', 14, 22);
            doc.setFontSize(11); doc.setTextColor(100); doc.text(genDate, 14, 28);
            const head = [['Persona', 'Descripción', 'Monto Total', 'Total Abonado', 'Saldo Pendiente']];
            const body = data.map(d => {
                const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0);
                return [d.persona, d.descripcion, formatCurrency(d.monto), formatCurrency(totalAbonado), formatCurrency(d.monto - totalAbonado)];
            });
            const saldoTotal = data.reduce((sum, d) => sum + (d.monto - (d.abonos || []).reduce((s, a) => s + a.monto, 0)), 0);
            doc.autoTable({ head, body, startY: 35 });
            doc.setFontSize(12); doc.setFont(undefined, 'bold');
            doc.text(`Saldo Total Pendiente en Vales:`, 14, doc.autoTable.previous.finalY + 10);
            doc.text(formatCurrency(saldoTotal), 200, doc.autoTable.previous.finalY + 10, { align: 'right' });
            doc.save(`Reporte_Vales_${formatDateForInput(new Date())}.pdf`);

        } else if (type === 'cuentasPorPagar') {
            doc.setFontSize(18); doc.text('Reporte de Cuentas por Pagar', 14, 22);
            doc.setFontSize(11); doc.setTextColor(100); doc.text(genDate, 14, 28);
            
            const head = [['Proveedor', 'Concepto', 'Monto Total', 'Estado']];
            const body = data.map(d => [d.acreedor, d.descripcion, formatCurrency(d.monto), d.estado]);
            doc.autoTable({ head, body, startY: 35 });

            const now = new Date();
            const pagosDeDeudasEsteMes = allData.compras.filter(compra => 
                compra.descripcion.startsWith('Pago Cta. Pendiente:') &&
                compra.fecha.getFullYear() === now.getFullYear() &&
                compra.fecha.getMonth() === now.getMonth()
            );
            const grandTotalPagadoEsteMes = pagosDeDeudasEsteMes.reduce((sum, c) => sum + c.monto, 0);
            const grandTotalDeudaPendiente = data.filter(d => d.estado !== 'Pagada').reduce((sum, d) => sum + d.monto, 0);
            
            let finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text('GRANDES TOTALES', 14, finalY + 15);
            doc.setFontSize(12); doc.setFont(undefined, 'normal');
            doc.text(`Total Pagado de Deudas (Este Mes):`, 14, finalY + 22);
            doc.text(formatCurrency(grandTotalPagadoEsteMes), 200, finalY + 22, { align: 'right' });
            doc.text(`Total de Dinero Pendiente por Pagar:`, 14, finalY + 29);
            doc.setFont(undefined, 'bold');
            doc.text(formatCurrency(grandTotalDeudaPendiente), 200, finalY + 29, { align: 'right' });

            doc.save(`Reporte_Cuentas_por_Pagar_${formatDateForInput(new Date())}.pdf`);
        }
    };
});
</script>
</body>
</html>
