<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Financiero - Licorera (En la Nube)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Estilos CSS de la aplicaci贸n */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-button.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .modal { transition: opacity 0.3s ease; }
        .action-button { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 9999px; }
        .action-button:hover { background-color: #f0f0f0; }
        #login-overlay { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        </div>
    
    <div id="app-container" class="hidden">
        <div class="max-w-7xl mx-auto">
            <header class="relative text-center mb-4 no-print">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800"> Gesti贸n Financiera Total</h1>
                <p class="text-gray-600 mt-2">Control de Flujo de Dinero, Compras, Gastos y Deudas.</p>
                <button id="settings-btn" class="absolute top-0 right-0 action-button text-gray-500 hover:text-indigo-600 text-2xl" title="Configuraci贸n">
                    <i class="fas fa-cog"></i>
                </button>
            </header>

            <div class="border-b border-gray-200 mb-6 no-print">
                </div>
            <main>
                </main>
        </div>
    </div>
    
    <div id="abono-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center p-4"> </div>
    <div id="notification-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center"> </div>
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center"> </div>
    <div id="edit-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center overflow-y-auto p-4"> </div>

    <div id="password-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center p-4">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 class="text-2xl font-semibold mb-6 text-gray-800">Establecer Nueva Contrase帽a</h3>
            <form id="form-password" class="space-y-4">
                
                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700">Nueva Contrase帽a</label>
                    <div class="relative mt-1">
                        <input type="password" id="new-password" class="block w-full rounded-md border-gray-300 shadow-sm pr-10" required>
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer toggle-password">
                            <i class="fas fa-eye text-gray-400"></i>
                        </span>
                    </div>
                </div>
                <div>
                    <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contrase帽a</label>
                    <div class="relative mt-1">
                        <input type="password" id="confirm-password" class="block w-full rounded-md border-gray-300 shadow-sm pr-10" required>
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer toggle-password">
                             <i class="fas fa-eye text-gray-400"></i>
                        </span>
                    </div>
                </div>
                <p id="password-error" class="text-red-500 text-sm hidden"></p>
            </form>
            <div class="flex justify-end items-center mt-6 space-x-4">
                <button id="cancel-password-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="save-password-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Guardar Cambios</button>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // ... Configuraci贸n de Firebase y referencias no cambian ...
        const firebaseConfig = {
 apiKey: "AIzaSyCm5BGh7cWX4A5fXx8zCN33ztuLvseRhAU",
 authDomain: "control-licorera.firebaseapp.com",
 databaseURL: "https://control-licorera-default-rtdb.firebaseio.com",
 projectId: "control-licorera",
 storageBucket: "control-licorera.appspot.com",
 messagingSenderId: "430925820415",
 appId: "1:430925820415:web:e1c06bc73b6863a5c3f7ca",
 measurementId: "G-86ZY48XKV4"
};
        // ... Variables globales y funciones de UI/Datos sin cambios ...
        
        // ... MANEJO DE MODALES ...
        // ... Otras funciones de modales sin cambios ...
        document.getElementById('cancel-password-btn').onclick = () => document.getElementById('password-modal').style.display = 'none';

        // --- INICIALIZACIN Y EVENT LISTENERS GLOBALES ---
        const initApp = () => {
            // ... Sin cambios en initApp ...
        };

        // ***** AADIDO: LGICA PARA EL "OJO" DE MOSTRAR/OCULTAR CONTRASEA *****
        const togglePasswordVisibility = (e) => {
            const icon = e.currentTarget.querySelector('i');
            const input = e.currentTarget.previousElementSibling;

            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = "password";
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        };

        document.querySelectorAll('.toggle-password').forEach(el => {
            el.addEventListener('click', togglePasswordVisibility);
        });
        // ***** FIN DE LA ADICIN *****


        // ***** MODIFICADO: LGICA SIMPLIFICADA PARA CAMBIAR CONTRASEA *****
        document.getElementById('save-password-btn').addEventListener('click', () => {
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            const errorEl = document.getElementById('password-error');
            
            // Ocultar error anterior
            errorEl.classList.add('hidden');

            if (!newPass || !confirmPass) {
                errorEl.textContent = 'Ambos campos son obligatorios.';
                errorEl.classList.remove('hidden');
                return;
            }

            if (newPass !== confirmPass) {
                errorEl.textContent = 'Las contrase帽as no coinciden.';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (newPass.length < 4) {
                errorEl.textContent = 'La nueva contrase帽a debe tener al menos 4 caracteres.';
                errorEl.classList.remove('hidden');
                return;
            }

            // Directamente guardar la nueva contrase帽a en Firebase
            dataRefs.password.set(newPass)
                .then(() => {
                    showNotification('xito', 'La contrase帽a se ha cambiado correctamente.');
                    document.getElementById('password-modal').style.display = 'none';
                })
                .catch(err => {
                    showNotification('Error', 'No se pudo guardar la nueva contrase帽a.', 'error');
                });
        });
        // ***** FIN DE LA MODIFICACIN *****


        // --- LGICA DE LOGIN ---
        // ... La l贸gica de login y de sesi贸n no cambia ...
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const passwordInput = document.getElementById('password');
            const errorEl = document.getElementById('login-error');
            
            dataRefs.password.once('value', (snapshot) => {
                const correctPassword = snapshot.val();
                if (correctPassword === null) {
                    errorEl.innerHTML = 'Error de configuraci贸n: No se encontr贸 la contrase帽a en la base de datos. Por favor, config煤rela en Firebase en la ruta `config/password`.';
                    errorEl.classList.remove('hidden');
                    return;
                }
                if (passwordInput.value === correctPassword) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    document.getElementById('login-overlay').classList.add('hidden');
                    initApp();
                } else {
                    errorEl.textContent = 'Contrase帽a incorrecta. Intente de nuevo.';
                    errorEl.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }).catch(error => {
                errorEl.innerHTML = 'Error al conectar con la base de datos. Verifique la conexi贸n y la configuraci贸n de Firebase.';
                errorEl.classList.remove('hidden');
            });
        });
        
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            document.getElementById('login-overlay').classList.add('hidden');
            initApp();
        } else {
            document.getElementById('login-overlay').classList.remove('hidden');
        }
    });
    </script>
</body>
</html>
