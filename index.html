<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Financiero - Multi-Negocio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-button.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .modal { transition: opacity 0.3s ease; }
        .action-button { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 9999px; }
        .action-button:hover { background-color: #f0f0f0; }
        .auth-overlay { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        .period-locked { background: linear-gradient(135deg, #fee2e2, #fef3c7); border: 2px solid #f59e0b; }
        .locked-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-in { animation: slideIn 0.5s ease-out; }
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } .no-print { display: none; } }
        
        /* Responsive Navigation */
        @media (max-width: 640px) {
            .tab-button { font-size: 0.75rem; padding: 0.75rem 0.25rem; }
            .tab-button i { margin-right: 0.25rem; }
        }
        
        @media (max-width: 480px) {
            .tab-button { padding: 0.75rem 0.125rem; }
            .tab-button .tab-text { display: none; }
            .tab-button i { margin-right: 0; font-size: 1rem; }
        }
        
        @media (max-width: 360px) {
            .tab-button i { display: none; }
            .tab-button::after { content: attr(data-emoji); font-size: 1.2rem; }
        }
    </style>
</head>
<body class="p-2 sm:p-4 md:p-8">

    <div id="login-overlay" class="auth-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-2xl w-full max-w-sm mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-store text-4xl text-indigo-600"></i>
                <h2 class="text-2xl font-bold text-gray-800 mt-4">Acceso al Sistema</h2>
                <p class="text-gray-500 text-sm">Por favor, inicie sesi√≥n.</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="sr-only">Correo Electr√≥nico</label>
                    <input type="email" id="email" placeholder="Correo Electr√≥nico" class="w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="sr-only">Contrase√±a</label>
                    <input type="password" id="password" placeholder="Contrase√±a" class="w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="business-selector-overlay" class="auth-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-40 flex items-center justify-center p-4">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 text-center">Seleccionar Negocio</h2>
            <p class="text-gray-500 text-sm text-center mb-6">Elige el local que deseas gestionar.</p>
            <div id="business-list" class="space-y-3">
                </div>
            <div class="mt-6 text-center">
                 <button id="logout-btn-selector" class="text-sm text-gray-600 hover:text-indigo-600">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </div>
    
    <div id="app-container" class="hidden">
        <div class="max-w-7xl mx-auto">
            <header class="relative text-center mb-4 no-print">
                <h1 id="app-title" class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800">üìä Gesti√≥n Financiera</h1>
                <p class="text-gray-600 mt-2 text-sm sm:text-base">Control de Flujo de Dinero, Compras, Gastos y Deudas.</p>
                <div class="absolute top-0 right-0 flex items-center space-x-2">
                    <button id="switch-business-btn" class="hidden action-button text-gray-500 hover:text-indigo-600 text-xl sm:text-2xl" title="Cambiar de Negocio">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <button id="logout-btn-main" class="action-button text-gray-500 hover:text-red-600 text-xl sm:text-2xl" title="Cerrar Sesi√≥n">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <div class="border-b border-gray-200 mb-4 sm:mb-6 no-print overflow-x-auto">
                <nav id="tabs-nav" class="-mb-px flex space-x-2 sm:space-x-6 min-w-max" aria-label="Tabs">
                    <button data-tab="resumen" data-emoji="üìä" class="tab-button active whitespace-nowrap py-3 sm:py-4 px-1 sm:px-2 border-b-2 font-medium text-xs sm:text-sm">
                        <i class="fas fa-chart-pie mr-1 sm:mr-2"></i><span class="tab-text">Resumen</span>
                    </button>
                    <button data-tab="ingresos" data-emoji="üí∞" class="tab-button whitespace-nowrap py-3 sm:py-4 px-1 sm:px-2 border-b-2 font-medium text-xs sm:text-sm">
                        <i class="fas fa-dollar-sign mr-1 sm:mr-2"></i><span class="tab-text">Ingreso</span>
                    </button>
                    <button data-tab="compras" data-emoji="üõí" class="tab-button whitespace-nowrap py-3 sm:py-4 px-1 sm:px-2 border-b-2 font-medium text-xs sm:text-sm">
                        <i class="fas fa-shopping-cart mr-1 sm:mr-2"></i><span class="tab-text">Compras</span>
                    </button>
                    <button data-tab="gastos" data-emoji="üßæ" class="tab-button whitespace-nowrap py-3 sm:py-4 px-1 sm:px-2 border-b-2 font-medium text-xs sm:text-sm">
                        <i class="fas fa-receipt mr-1 sm:mr-2"></i><span class="tab-text">Gasto Op.</span>
                    </button>
                    <button data-tab="retiros" data-emoji="üí∏" class="tab-button whitespace-nowrap py-3 sm:py-4 px-1 sm:px-2 border-b-2 font-medium text-xs sm:text-sm">
                        <i class="fas fa-hand-holding-dollar mr-1 sm:mr-2"></i><span class="tab-text">Retiro Jefe</span>
                    </button>
                    <button data-tab="deudas" data-emoji="üìö" class="tab-button whitespace-nowrap py-3 sm:py-4 px-1 sm:px-2 border-b-2 font-medium text-xs sm:text-sm">
                        <i class="fas fa-book mr-1 sm:mr-2"></i><span class="tab-text">Deudas</span>
                    </button>
                    <button data-tab="vales" data-emoji="üè∑Ô∏è" class="tab-button whitespace-nowrap py-3 sm:py-4 px-1 sm:px-2 border-b-2 font-medium text-xs sm:text-sm">
                        <i class="fas fa-user-tag mr-1 sm:mr-2"></i><span class="tab-text">Vales</span>
                    </button>
                    <button data-tab="registros" data-emoji="üìã" class="tab-button whitespace-nowrap py-3 sm:py-4 px-1 sm:px-2 border-b-2 font-medium text-xs sm:text-sm">
                        <i class="fas fa-list-ul mr-1 sm:mr-2"></i><span class="tab-text">Ver Registros</span>
                    </button>
                </nav>
            </div>

            <main>
                <div id="resumen" class="tab-content">
                         <div id="print-area">
                             <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-4">
                                 <div>
                                     <h2 class="text-xl sm:text-2xl font-semibold text-gray-700">Resumen del Periodo</h2>
                                     <p id="period-display" class="text-xs sm:text-sm text-gray-500 mt-1">Calculando periodo...</p>
                                     <div id="period-status" class="hidden mt-2 px-3 py-1 rounded-full text-xs sm:text-sm font-medium">
                                         <i class="fas fa-lock mr-1"></i>üîí PER√çODO CERRADO - Solo consulta
                                     </div>
                                 </div>
                                 <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto no-print">
                                     <input type="month" id="month-filter" class="p-2 border border-gray-300 rounded-md text-sm">
                                     <button id="close-period-btn" class="bg-indigo-600 text-white font-semibold px-3 sm:px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-xs sm:text-sm">
                                         <i class="fas fa-calendar-check mr-1 sm:mr-2"></i><span class="hidden sm:inline">Realizar </span>Corte de Mes
                                     </button>
                                 </div>
                             </div>
                             <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
                                 <div class="card p-3 sm:p-5"><h3 class="text-gray-500 text-xs sm:text-sm font-medium">Ingresos Totales (Periodo)</h3><p id="total-ingresos" class="text-lg sm:text-2xl font-semibold text-green-600 mt-1">$0</p></div>
                                 <div class="card p-3 sm:p-5"><h3 class="text-gray-500 text-xs sm:text-sm font-medium">Compras Totales (Periodo)</h3><p id="total-compras" class="text-lg sm:text-2xl font-semibold text-purple-600 mt-1">$0</p></div>
                                 <div class="card p-3 sm:p-5"><h3 class="text-gray-500 text-xs sm:text-sm font-medium">Gastos Op. Totales (Periodo)</h3><p id="total-gastos-op" class="text-lg sm:text-2xl font-semibold text-red-600 mt-1">$0</p></div>
                                 <div class="card p-3 sm:p-5 bg-blue-50 border-blue-200 border"><h3 class="text-blue-800 text-xs sm:text-sm font-medium">Efectivo en Caja (Actual)</h3><p id="efectivo-caja" class="text-lg sm:text-2xl font-semibold text-blue-700 mt-1">$0</p></div>
                                 <div class="card p-3 sm:p-5 bg-green-50 border-green-200 border"><h3 class="text-green-800 text-xs sm:text-sm font-medium">Saldo en Banco (Actual)</h3><p id="saldo-banco" class="text-lg sm:text-2xl font-semibold text-green-700 mt-1">$0</p></div>
                                 <div class="card p-3 sm:p-5 bg-yellow-50 border-yellow-200 border"><h3 class="text-yellow-800 text-xs sm:text-sm font-medium">Cuentas por Cobrar</h3><p id="cuentas-cobrar-total" class="text-lg sm:text-2xl font-semibold text-yellow-700 mt-1">$0</p></div>
                                 <div class="card p-3 sm:p-5 bg-red-50 border-red-200 border"><h3 class="text-red-800 text-xs sm:text-sm font-medium">Cuentas por Pagar</h3><p id="cuentas-pagar-total" class="text-lg sm:text-2xl font-semibold text-red-700 mt-1">$0</p></div>
                                 <div class="card p-3 sm:p-5"><h3 class="text-gray-500 text-xs sm:text-sm font-medium">Retiros del Jefe (Periodo)</h3><p id="total-retiros" class="text-lg sm:text-2xl font-semibold text-orange-500 mt-1">$0</p></div>
                                 </div>
                             <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 sm:gap-8">
                                 <div class="lg:col-span-2 card p-4 sm:p-6"><h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-4">Distribuci√≥n de Gastos (Periodo)</h3><canvas id="gastos-chart"></canvas></div>
                                 <div class="lg:col-span-3 card p-4 sm:p-6"><h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-4">√öltimos Movimientos (Global)</h3><div class="overflow-x-auto"><table class="w-full text-xs sm:text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-3 sm:px-6 py-3">Fecha</th><th class="px-3 sm:px-6 py-3">Descripci√≥n</th><th class="px-3 sm:px-6 py-3">Monto</th></tr></thead><tbody id="ultimos-movimientos-body"></tbody></table></div></div>
                             </div>
                         </div>
                </div>
                <div id="ingresos" class="tab-content hidden"><div class="max-w-xl mx-auto card p-6 sm:p-8"><h2 class="text-xl sm:text-2xl font-semibold">Registrar Venta</h2><form id="form-ingresos" class="space-y-4 sm:space-y-6"><div><label for="ingreso-fecha" class="block text-sm font-medium">Fecha</label><input type="date" id="ingreso-fecha" class="mt-1 block w-full rounded-md" required></div><div><label for="ingreso-efectivo" class="block text-sm font-medium">Ventas en Efectivo</label><input type="text" data-moneda inputmode="numeric" id="ingreso-efectivo" value="0" class="mt-1 block w-full" required></div><div><label for="ingreso-tarjeta" class="block text-sm font-medium">Ventas Tarjeta/Transf.</label><input type="text" data-moneda inputmode="numeric" id="ingreso-tarjeta" value="0" class="mt-1 block w-full" required></div><div><label for="ingreso-notas" class="block text-sm font-medium">Notas</label><textarea id="ingreso-notas" rows="3" class="mt-1 block w-full"></textarea></div><button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold">A√±adir Ingreso</button></form></div></div>
                <div id="compras" class="tab-content hidden"><div class="max-w-xl mx-auto card p-6 sm:p-8"><h2 class="text-xl sm:text-2xl font-semibold">Registrar Compra</h2><form id="form-compras" class="space-y-4 sm:space-y-6"><div><label for="compra-fecha" class="block text-sm font-medium">Fecha</label><input type="date" id="compra-fecha" class="mt-1 block w-full" required></div><div><label for="compra-proveedor" class="block text-sm font-medium">Proveedor</label><input type="text" id="compra-proveedor" class="mt-1 block w-full" required></div><div><label for="compra-descripcion" class="block text-sm font-medium">Descripci√≥n</label><input type="text" id="compra-descripcion" class="mt-1 block w-full" required></div><div><label for="compra-monto" class="block text-sm font-medium">Monto</label><input type="text" data-moneda inputmode="numeric" id="compra-monto" class="mt-1 block w-full" required></div><div><label for="compra-metodo" class="block text-sm font-medium">Pagado con</label><select id="compra-metodo" class="mt-1 block w-full" required><option value="Efectivo">Efectivo</option><option value="Banco">Banco</option></select></div><button type="submit" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold">A√±adir Compra</button></form></div></div>
                <div id="gastos" class="tab-content hidden"><div class="max-w-xl mx-auto card p-6 sm:p-8"><h2 class="text-xl sm:text-2xl font-semibold">Registrar Gasto Op. (del Efectivo)</h2><form id="form-gastos" class="space-y-4 sm:space-y-6"><div><label for="gasto-fecha" class="block text-sm font-medium">Fecha</label><input type="date" id="gasto-fecha" class="mt-1 block w-full" required></div><div><label for="gasto-descripcion" class="block text-sm font-medium">Descripci√≥n</label><input type="text" id="gasto-descripcion" class="mt-1 block w-full" required></div><div><label for="gasto-categoria" class="block text-sm font-medium">Categor√≠a</label><select id="gasto-categoria" class="mt-1 block w-full" required><option>Arriendo</option><option>Servicios</option><option>N√≥mina</option><option>Marketing</option><option>Mantenimiento</option><option>Impuestos</option><option>Insumos</option><option>Otro</option></select></div><div><label for="gasto-monto" class="block text-sm font-medium">Monto</label><input type="text" data-moneda inputmode="numeric" id="gasto-monto" class="mt-1 block w-full" required></div><button type="submit" class="w-full bg-red-600 text-white py-3 px-4 rounded-lg font-semibold">A√±adir Gasto</button></form></div></div>
                <div id="retiros" class="tab-content hidden"><div class="max-w-xl mx-auto card p-6 sm:p-8"><h2 class="text-xl sm:text-2xl font-semibold">Registrar Retiro Jefe</h2><form id="form-retiros" class="space-y-4 sm:space-y-6"><div><label for="retiro-fecha" class="block text-sm font-medium">Fecha</label><input type="date" id="retiro-fecha" class="mt-1 block w-full" required></div><div><label for="retiro-metodo" class="block text-sm font-medium">Retirar de</label><select id="retiro-metodo" class="mt-1 block w-full" required><option value="Efectivo">Efectivo (Caja)</option><option value="Banco">Banco (Transferencia)</option></select></div><div><label for="retiro-descripcion" class="block text-sm font-medium">Descripci√≥n</label><input type="text" id="retiro-descripcion" class="mt-1 block w-full" required></div><div><label for="retiro-monto" class="block text-sm font-medium">Monto</label><input type="text" data-moneda inputmode="numeric" id="retiro-monto" class="mt-1 block w-full" required></div><button type="submit" class="w-full bg-orange-500 text-white py-3 px-4 rounded-lg font-semibold">A√±adir Retiro</button></form></div></div>
                <div id="deudas" class="tab-content hidden grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                    <div class="space-y-4 sm:space-y-6"><h2 class="text-xl sm:text-2xl font-semibold">Cuentas por Cobrar (Fiado)</h2><div class="card p-4 sm:p-6"><form id="form-cuentas-cobrar" class="space-y-4"><div><label for="cpc-cliente" class="block text-sm font-medium">Nombre Cliente</label><input type="text" id="cpc-cliente" class="mt-1 block w-full" required></div><div><label for="cpc-descripcion" class="block text-sm font-medium">Descripci√≥n</label><input type="text" id="cpc-descripcion" class="mt-1 block w-full" required></div><div><label for="cpc-monto" class="block text-sm font-medium">Monto</label><input type="text" data-moneda inputmode="numeric" id="cpc-monto" class="mt-1 block w-full" required></div><button type="submit" class="w-full bg-yellow-500 text-white py-2 rounded-lg font-semibold">A√±adir Deuda</button></form></div><div class="card p-3 sm:p-4 overflow-x-auto"><table class="w-full text-xs sm:text-sm" id="tabla-cuentas-cobrar"></table></div></div>
                    <div class="space-y-4 sm:space-y-6"><h2 class="text-xl sm:text-2xl font-semibold">Cuentas por Pagar</h2><div class="card p-4 sm:p-6"><form id="form-cuentas-pagar" class="space-y-4"><div><label for="cpp-acreedor" class="block text-sm font-medium">Proveedor/Acreedor</label><input type="text" id="cpp-acreedor" class="mt-1 block w-full" required></div><div><label for="cpp-descripcion" class="block text-sm font-medium">Concepto</label><input type="text" id="cpp-descripcion" class="mt-1 block w-full" required></div><div><label for="cpp-monto" class="block text-sm font-medium">Monto</label><input type="text" data-moneda inputmode="numeric" id="cpp-monto" class="mt-1 block w-full" required></div><button type="submit" class="w-full bg-red-500 text-white py-2 rounded-lg font-semibold">A√±adir Cuenta por Pagar</button></form></div><div class="card p-3 sm:p-4 overflow-x-auto"><table class="w-full text-xs sm:text-sm" id="tabla-cuentas-pagar"></table></div></div>
                </div>

                <div id="vales" class="tab-content hidden">
                    <div class="max-w-4xl mx-auto">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6">Control de Vales (Personal y Due√±o)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-8">
                            <div class="md:col-span-1 space-y-4 sm:space-y-6">
                                <div class="card p-4 sm:p-6">
                                    <h3 class="text-base sm:text-lg font-semibold mb-4">Registrar Nuevo Vale</h3>
                                    <form id="form-vales" class="space-y-4">
                                        <div>
                                            <label for="vale-persona" class="block text-sm font-medium">Nombre Persona</label>
                                            <input type="text" id="vale-persona" class="mt-1 block w-full" required>
                                        </div>
                                        <div>
                                            <label for="vale-descripcion" class="block text-sm font-medium">Descripci√≥n</label>
                                            <input type="text" id="vale-descripcion" class="mt-1 block w-full" required>
                                        </div>
                                        <div>
                                            <label for="vale-monto" class="block text-sm font-medium">Monto</label>
                                            <input type="text" data-moneda inputmode="numeric" id="vale-monto" class="mt-1 block w-full" required>
                                        </div>
                                        <button type="submit" class="w-full bg-cyan-600 text-white py-2 rounded-lg font-semibold hover:bg-cyan-700">A√±adir Vale</button>
                                    </form>
                                </div>
                            </div>
                            <div class="md:col-span-2 card p-3 sm:p-4 overflow-x-auto">
                                <h3 class="text-base sm:text-lg font-semibold mb-4 px-2">Historial de Vales</h3>
                                <table class="w-full text-xs sm:text-sm" id="tabla-vales"></table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="registros" class="tab-content hidden space-y-6 sm:space-y-8">
                    <div><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2"><h2 class="text-xl sm:text-2xl font-semibold">Todos los Ingresos</h2><button data-type="ingresos" class="btn-pdf bg-gray-700 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm"><i class="fas fa-file-pdf mr-1 sm:mr-2"></i>PDF</button></div><div class="card p-3 sm:p-4 overflow-x-auto"><table class="w-full text-xs sm:text-sm" id="tabla-ingresos"></table></div></div>
                    <div><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2"><h2 class="text-xl sm:text-2xl font-semibold">Todas las Compras</h2><button data-type="compras" class="btn-pdf bg-gray-700 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm"><i class="fas fa-file-pdf mr-1 sm:mr-2"></i>PDF</button></div><div class="card p-3 sm:p-4 overflow-x-auto"><table class="w-full text-xs sm:text-sm" id="tabla-compras"></table></div></div>
                    <div><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2"><h2 class="text-xl sm:text-2xl font-semibold">Todos los Gastos Op.</h2><button data-type="gastos" class="btn-pdf bg-gray-700 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm"><i class="fas fa-file-pdf mr-1 sm:mr-2"></i>PDF</button></div><div class="card p-3 sm:p-4 overflow-x-auto"><table class="w-full text-xs sm:text-sm" id="tabla-gastos"></table></div></div>
                    <div><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2"><h2 class="text-xl sm:text-2xl font-semibold">Todos los Retiros</h2><button data-type="retiros" class="btn-pdf bg-gray-700 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm"><i class="fas fa-file-pdf mr-1 sm:mr-2"></i>PDF</button></div><div class="card p-3 sm:p-4 overflow-x-auto"><table class="w-full text-xs sm:text-sm" id="tabla-retiros"></table></div></div>

                    <div class="pt-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl sm:text-2xl font-semibold">Reportes Avanzados</h2>
                        </div>
                        <div class="card p-4 sm:p-6 space-y-4">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 gap-2">
                                <div>
                                    <p class="font-medium text-gray-800">Resumen de Cuentas por Cobrar</p>
                                    <p class="text-xs sm:text-sm text-gray-500">Genera un PDF con el detalle de lo que te deben los clientes.</p>
                                </div>
                                <button data-type="deudas-cobrar" class="btn-pdf bg-yellow-500 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm flex-shrink-0"><i class="fas fa-download mr-1 sm:mr-2"></i>Descargar PDF</button>
                            </div>
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 gap-2">
                                <div>
                                    <p class="font-medium text-gray-800">Resumen de Vales de Personal</p>
                                    <p class="text-xs sm:text-sm text-gray-500">Genera un PDF con el detalle de los vales de consumo interno.</p>
                                </div>
                                <button data-type="vales" class="btn-pdf bg-cyan-600 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm flex-shrink-0"><i class="fas fa-download mr-1 sm:mr-2"></i>Descargar PDF</button>
                            </div>
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                                <div>
                                    <p class="font-medium text-gray-800">Resumen de Cuentas por Pagar</p>
                                    <p class="text-xs sm:text-sm text-gray-500">Genera un PDF con el detalle de tus deudas a proveedores.</p>
                                </div>
                                <button data-type="deudas-pagar" class="btn-pdf bg-red-500 text-white px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm flex-shrink-0"><i class="fas fa-download mr-1 sm:mr-2"></i>Descargar PDF</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modal de Corte de Mes -->
    <div id="corte-mes-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 h-full w-full hidden z-50 flex items-center justify-center p-2 sm:p-4">
        <div class="relative mx-auto border w-full max-w-4xl shadow-2xl rounded-lg bg-white overflow-hidden max-h-screen overflow-y-auto">
            <!-- Header del Modal -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-4 sm:px-8 py-4 sm:py-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2 sm:space-x-3">
                        <i class="fas fa-calendar-check text-xl sm:text-2xl"></i>
                        <h3 class="text-lg sm:text-2xl font-bold">Corte de Mes</h3>
                    </div>
                    <button id="close-corte-modal" class="text-white hover:text-gray-200 text-xl sm:text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="mt-2 text-indigo-100 text-sm">Cierre contable del per√≠odo actual</p>
            </div>

            <!-- Contenido del Modal -->
            <div class="p-4 sm:p-8">
                <!-- Paso 1: Configuraci√≥n -->
                <div id="corte-step-1" class="corte-step">
                    <div class="text-center mb-6 sm:mb-8">
                        <div class="inline-flex items-center justify-center w-12 sm:w-16 h-12 sm:h-16 bg-indigo-100 rounded-full mb-4">
                            <i class="fas fa-cog text-indigo-600 text-xl sm:text-2xl"></i>
                        </div>
                        <h4 class="text-lg sm:text-xl font-semibold text-gray-800">Configuraci√≥n del Corte</h4>
                        <p class="text-gray-600 mt-2 text-sm">Define los par√°metros para el cierre del per√≠odo</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo a Cerrar</label>
                                <input type="month" id="corte-periodo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Corte</label>
                                <input type="date" id="corte-fecha" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notas del Corte</label>
                            <textarea id="corte-notas" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Observaciones sobre el cierre del per√≠odo..."></textarea>
                        </div>
                    </div>

                    <div class="mt-6 sm:mt-8 flex justify-end">
                        <button id="corte-next-step1" class="bg-indigo-600 text-white px-4 sm:px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors text-sm sm:text-base">
                            Continuar <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Paso 2: Vista Previa -->
                <div id="corte-step-2" class="corte-step hidden">
                    <div class="text-center mb-6 sm:mb-8">
                        <div class="inline-flex items-center justify-center w-12 sm:w-16 h-12 sm:h-16 bg-yellow-100 rounded-full mb-4">
                            <i class="fas fa-eye text-yellow-600 text-xl sm:text-2xl"></i>
                        </div>
                        <h4 class="text-lg sm:text-xl font-semibold text-gray-800">Vista Previa del Corte</h4>
                        <p class="text-gray-600 mt-2 text-sm">Revisa los datos antes de proceder</p>
                    </div>

                    <div id="corte-preview-content" class="mb-6 sm:mb-8">
                        <!-- Contenido generado din√°micamente -->
                    </div>

                    <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <button id="corte-back-step2" class="bg-gray-500 text-white px-4 sm:px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors text-sm sm:text-base">
                            <i class="fas fa-arrow-left mr-2"></i>Volver
                        </button>
                        <button id="corte-confirm" class="bg-red-600 text-white px-4 sm:px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition-colors text-sm sm:text-base">
                            <i class="fas fa-check mr-2"></i>Confirmar Corte
                        </button>
                    </div>
                </div>

                <!-- Paso 3: Procesando -->
                <div id="corte-step-3" class="corte-step hidden">
                    <div class="text-center mb-6 sm:mb-8">
                        <div class="inline-flex items-center justify-center w-12 sm:w-16 h-12 sm:h-16 bg-blue-100 rounded-full mb-4">
                            <i class="fas fa-cogs text-blue-600 text-xl sm:text-2xl animate-spin"></i>
                        </div>
                        <h4 class="text-lg sm:text-xl font-semibold text-gray-800">Procesando Corte</h4>
                        <p class="text-gray-600 mt-2 text-sm">Por favor espera mientras se completa el proceso</p>
                    </div>

                    <div class="mb-6">
                        <div class="bg-gray-200 rounded-full h-3 mb-4">
                            <div id="corte-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="corte-progress-text" class="text-center text-sm text-gray-600">Iniciando proceso...</p>
                    </div>

                    <div id="corte-steps-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Pasos se agregan din√°micamente -->
                    </div>
                </div>

                <!-- Paso 4: Completado -->
                <div id="corte-step-4" class="corte-step hidden">
                    <div class="text-center mb-6 sm:mb-8">
                        <div class="inline-flex items-center justify-center w-12 sm:w-16 h-12 sm:h-16 bg-green-100 rounded-full mb-4">
                            <i class="fas fa-check-circle text-green-600 text-xl sm:text-2xl"></i>
                        </div>
                        <h4 class="text-lg sm:text-xl font-semibold text-gray-800">Corte Completado</h4>
                        <p class="text-gray-600 mt-2 text-sm">El proceso se ha ejecutado exitosamente</p>
                    </div>

                    <div id="corte-summary" class="mb-6 sm:mb-8 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <!-- Resumen generado din√°micamente -->
                    </div>

                    <div class="flex flex-col sm:flex-row justify-center items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <button id="corte-download-report" class="bg-blue-600 text-white px-4 sm:px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-sm sm:text-base">
                            <i class="fas fa-download mr-2"></i>Descargar Reporte
                        </button>
                        <button id="corte-close-modal" class="bg-gray-600 text-white px-4 sm:px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors text-sm sm:text-base">
                            <i class="fas fa-times mr-2"></i>Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="abono-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4"><div class="relative mx-auto p-6 sm:p-8 border w-full max-w-md shadow-lg rounded-md bg-white"><h3 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6" id="abono-modal-title">Registrar Abono</h3><form id="form-abono"><input type="hidden" id="abono-deuda-id"><input type="hidden" id="abono-type"><div class="mb-4"><label class="block text-sm font-medium">Monto a Abonar</label><input type="text" data-moneda inputmode="numeric" id="abono-monto" class="mt-1 block w-full" required></div><div class="mb-4"><label class="block text-sm font-medium">Recibido en</label><select id="abono-metodo" class="mt-1 block w-full" required><option value="Efectivo">Efectivo</option><option value="Banco">Banco</option></select></div></form><div class="flex flex-col sm:flex-row justify-end items-stretch sm:items-center mt-4 sm:mt-6 space-y-2 sm:space-y-0 sm:space-x-4"><button id="cancel-abono-btn" class="px-4 py-2 bg-gray-200 rounded-md text-sm sm:text-base">Cancelar</button><button id="save-abono-btn" class="px-4 py-2 bg-green-600 text-white rounded-md text-sm sm:text-base">Registrar Abono</button></div></div></div>
    <div id="notification-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4"><div class="relative mx-auto p-4 sm:p-5 border w-full max-w-sm sm:max-w-md shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div id="notification-icon" class="mx-auto flex items-center justify-center h-10 sm:h-12 w-10 sm:w-12 rounded-full"></div><h3 id="notification-title" class="text-base sm:text-lg leading-6 font-medium text-gray-900 mt-2"></h3><div class="mt-2 px-4 sm:px-7 py-3"><p id="notification-message" class="text-xs sm:text-sm text-gray-500"></p></div><div class="items-center px-4 py-3"><button id="notification-close" class="px-4 py-2 bg-indigo-500 text-white text-sm sm:text-base font-medium rounded-md w-full">Cerrar</button></div></div></div></div>
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4"><div class="relative mx-auto p-4 sm:p-5 border w-full max-w-sm sm:max-w-md shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div class="mx-auto flex items-center justify-center h-10 sm:h-12 w-10 sm:w-12 rounded-full bg-red-100"><i class="fas fa-exclamation-triangle text-red-600 text-lg sm:text-2xl"></i></div><h3 id="confirm-title" class="text-base sm:text-lg leading-6 font-medium text-gray-900 mt-4"></h3><div id="confirm-message-container" class="mt-2 px-4 sm:px-7 py-3"><p id="confirm-message" class="text-xs sm:text-sm text-gray-500"></p></div><div class="flex flex-col sm:flex-row justify-center items-stretch sm:items-center px-4 py-3 space-y-2 sm:space-y-0 sm:space-x-4"><button id="cancel-confirm-btn" class="px-4 py-2 bg-gray-200 rounded-md text-sm sm:text-base">Cancelar</button><button id="confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md text-sm sm:text-base">Confirmar</button></div></div></div></div>
    <div id="edit-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center overflow-y-auto p-4"><div class="relative mx-auto p-6 sm:p-8 border w-full max-w-xl shadow-lg rounded-md bg-white"><h3 id="edit-modal-title" class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6"></h3><form id="edit-form" class="space-y-4"></form><div class="flex flex-col sm:flex-row justify-end items-stretch sm:items-center mt-4 sm:mt-6 space-y-2 sm:space-y-0 sm:space-x-4"><button id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 rounded-md text-sm sm:text-base">Cancelar</button><button id="save-edit-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm sm:text-base">Guardar Cambios</button></div></div></div>
    <div id="historial-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4"><div class="relative mx-auto p-6 sm:p-8 border w-full max-w-2xl shadow-lg rounded-md bg-white max-h-screen overflow-y-auto"><div class="flex justify-between items-start"><div><h3 class="text-xl sm:text-2xl font-semibold mb-2" id="historial-modal-title">Historial de Abonos</h3><p class="text-gray-600 text-sm" id="historial-modal-subtitle"></p></div><button id="cancel-historial-btn" class="p-2 -mt-4 -mr-4"><i class="fas fa-times text-gray-500"></i></button></div><div class="mt-4 sm:mt-6 overflow-y-auto max-h-96"><table class="w-full text-xs sm:text-sm"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-3 sm:px-4 py-3">Fecha</th><th class="px-3 sm:px-4 py-3">Hora</th><th class="px-3 sm:px-4 py-3">Monto Abonado</th><th class="px-3 sm:px-4 py-3">Recibido en</th></tr></thead><tbody id="historial-abonos-body"></tbody></table></div></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // =========================================================================
    // CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE
    // =========================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCm5BGh7cWX4A5fXx8zCN33ztuLvseRhAU",
        authDomain: "control-licorera.firebaseapp.com",
        databaseURL: "https://control-licorera-default-rtdb.firebaseio.com",
        projectId: "control-licorera",
        storageBucket: "control-licorera.appspot.com",
        messagingSenderId: "430925820415",
        appId: "1:430925820415:web:e1c06bc73b6863a5c3f7ca",
        measurementId: "G-86ZY48XKV4"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // =========================================================================
    // ESTADO GLOBAL Y VARIABLES
    // =========================================================================
    const { jsPDF } = window.jspdf;
    let gastosChart = null;
    let allData = {};
    let dataListeners = [];
    let confirmCallback = null;
    let currentUserProfile = null;
    let selectedBusinessId = null;
    let periods = [];
    let currentPeriod = null;

    const dataTypes = ['ingresos', 'compras', 'gastos', 'retiros', 'cuentasPorCobrar', 'cuentasPorPagar', 'vales'];

    // =========================================================================
    // L√ìGICA DE AUTENTICACI√ìN Y SELECCI√ìN DE NEGOCIO
    // =========================================================================
    auth.onAuthStateChanged(async user => {
        if (user) {
            const userProfileRef = database.ref(`users/${user.uid}`);
            const snapshot = await userProfileRef.once('value');
            currentUserProfile = snapshot.val();

            if (!currentUserProfile) {
                console.error("No se encontr√≥ el perfil del usuario.");
                handleLogout();
                return;
            }

            if (currentUserProfile.role === 'owner') {
                showBusinessSelector();
            } else if (currentUserProfile.role === 'admin' && currentUserProfile.businessId) {
                await selectBusiness(currentUserProfile.businessId);
            } else {
                console.error("Rol de usuario o ID de negocio no definido.");
                showLoginScreen();
            }
            document.getElementById('login-overlay').classList.add('hidden');
        } else {
            showLoginScreen();
        }
    });

    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorEl = document.getElementById('login-error');
        
        errorEl.classList.add('hidden');
        auth.signInWithEmailAndPassword(email, password)
            .catch(error => {
                errorEl.textContent = 'Correo o contrase√±a incorrectos.';
                errorEl.classList.remove('hidden');
            });
    });

    const handleLogout = () => { auth.signOut(); };

    const showLoginScreen = () => {
        document.getElementById('login-overlay').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
        document.getElementById('business-selector-overlay').classList.add('hidden');
        detachAllListeners();
    };
    
    const showBusinessSelector = async () => {
        const businessRef = database.ref('businesses');
        const snapshot = await businessRef.once('value');
        const businesses = snapshot.val();
        const businessListDiv = document.getElementById('business-list');
        businessListDiv.innerHTML = '';

        if (businesses) {
            for (const businessId in businesses) {
                const business = businesses[businessId];
                const button = document.createElement('button');
                button.className = 'w-full text-left p-4 bg-gray-100 hover:bg-indigo-100 rounded-lg transition-colors';
                button.innerHTML = `<span class="font-semibold text-lg text-gray-800">${business.name}</span>`;
                button.onclick = () => selectBusiness(businessId);
                businessListDiv.appendChild(button);
            }
        }

        document.getElementById('business-selector-overlay').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
        document.getElementById('login-overlay').classList.add('hidden');
    };

    const selectBusiness = async (businessId) => {
        selectedBusinessId = businessId;
        
        const businessNameRef = database.ref(`businesses/${businessId}/name`);
        const snapshot = await businessNameRef.once('value');
        const businessName = snapshot.val() || 'Negocio Sin Nombre';
        document.getElementById('app-title').textContent = `üìä Gesti√≥n: ${businessName}`;

        const switchBtn = document.getElementById('switch-business-btn');
        if (currentUserProfile.role === 'owner') {
            switchBtn.classList.remove('hidden');
        } else {
            switchBtn.classList.add('hidden');
        }
        
        startDataListeners();
        
        document.getElementById('business-selector-overlay').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        initializeDates();
        addCurrencyFormatting(document.body);
        changeTab('resumen');
    };

    // =========================================================================
    // MANEJO DE DATOS Y PER√çODOS
    // =========================================================================
    const detachAllListeners = () => {
        dataListeners.forEach(({ ref, listener }) => ref.off('value', listener));
        dataListeners = [];
    };

    const startDataListeners = () => {
        detachAllListeners();
        allData = {};
        
        // Listener para per√≠odos
        const periodsRef = database.ref(`businesses/${selectedBusinessId}/periods`);
        const periodsListener = periodsRef.on('value', async (snapshot) => {
            if (!snapshot.exists()) {
                const initialPeriod = { 
                    startDate: new Date(2000, 0, 1).toISOString(), 
                    endDate: null, 
                    monthKey: new Date().toISOString().slice(0, 7),
                    isClosed: false
                };
                await periodsRef.push(initialPeriod);
            } else {
                periods = firebaseObjectToArray(snapshot);
                updateCurrentPeriod();
            }
        });
        dataListeners.push({ ref: periodsRef, listener: periodsListener });

        dataTypes.forEach(type => {
            const ref = database.ref(`businesses/${selectedBusinessId}/${type}`);
            const listener = ref.on('value', snapshot => {
                allData[type] = firebaseObjectToArray(snapshot);
                refreshUI();
            });
            dataListeners.push({ ref, listener });
        });
    };

    const updateCurrentPeriod = () => {
        const filterValue = document.getElementById('month-filter').value;
        if (!filterValue) return;

        currentPeriod = periods.find(p => p.monthKey === filterValue);
        updatePeriodStatus();
    };

    const updatePeriodStatus = () => {
        const statusEl = document.getElementById('period-status');
        const closePeriodBtn = document.getElementById('close-period-btn');
        
        if (currentPeriod && currentPeriod.isClosed) {
            statusEl.classList.remove('hidden');
            statusEl.className = 'mt-2 px-3 py-1 rounded-full text-xs sm:text-sm font-medium bg-red-100 text-red-800 locked-indicator';
            closePeriodBtn.disabled = true;
            closePeriodBtn.classList.add('opacity-50', 'cursor-not-allowed');
            closePeriodBtn.innerHTML = '<i class="fas fa-lock mr-1 sm:mr-2"></i>Per√≠odo Cerrado';
        } else {
            statusEl.classList.add('hidden');
            closePeriodBtn.disabled = false;
            closePeriodBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            closePeriodBtn.innerHTML = '<i class="fas fa-calendar-check mr-1 sm:mr-2"></i><span class="hidden sm:inline">Realizar </span>Corte de Mes';
        }
    };

    const isPeriodClosed = () => {
        return currentPeriod && currentPeriod.isClosed;
    };

    const validatePeriodAccess = () => {
        if (isPeriodClosed()) {
            showNotification('Per√≠odo Cerrado', 'No se pueden realizar modificaciones en un per√≠odo cerrado.', 'error');
            return false;
        }
        return true;
    };
    
    const firebaseObjectToArray = (snapshot) => {
        const data = [];
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                const item = childSnapshot.val();
                if (typeof item !== 'object' || item === null) return;
                if (item.fecha && typeof item.fecha === 'string') item.fecha = new Date(item.fecha);
                if(item.abonos && typeof item.abonos === 'object') {
                    item.abonos = Object.values(item.abonos).map(abono => {
                        if (abono.fecha && typeof abono.fecha === 'string') return {...abono, fecha: new Date(abono.fecha)};
                        return abono;
                    });
                }
                data.push({ id: childSnapshot.key, ...item });
            });
        }
        return data;
    };

    const formatCurrency = (value) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value || 0);

    const refreshUI = () => { 
        filterAndRenderDashboard(); 
        const activeTabName = document.querySelector('.tab-button.active')?.dataset.tab;
        if (activeTabName === 'registros') renderAllTables();
        else if (activeTabName === 'deudas') { renderCuentasPorCobrar(); renderCuentasPorPagar(); }
        else if (activeTabName === 'vales') renderVales();
    };
    
    const filterAndRenderDashboard = () => {
        const filterValue = document.getElementById('month-filter').value;
        if (!filterValue || Object.keys(allData).length === 0) { updateDashboard({}, {}); return; }
        const [year, month] = filterValue.split('-').map(Number);
        const startDate = new Date(year, month - 1, 1);
        startDate.setHours(0, 0, 0, 0);
        const endDate = new Date(year, month, 1);
        endDate.setHours(0, 0, 0, 0);
        document.getElementById('period-display').textContent = `Mostrando datos para: ${startDate.toLocaleDateString('es-CO', { month: 'long', year: 'numeric' })}`;
        
        updateCurrentPeriod();
        
        const periodData = {};
        ['ingresos', 'compras', 'gastos', 'retiros'].forEach(key => {
            periodData[key] = (allData[key] || []).filter(d => d.fecha && d.fecha >= startDate && d.fecha < endDate);
        });
        updateDashboard(periodData, allData);
    };

    const updateDashboard = (periodData, globalData) => {
        const totalIngresosMes = (periodData.ingresos || []).reduce((sum, item) => sum + item.monto, 0);
        const totalComprasMes = (periodData.compras || []).reduce((sum, item) => sum + item.monto, 0);
        const totalGastosOpMes = (periodData.gastos || []).reduce((sum, item) => sum + item.monto, 0);
        const totalRetirosMes = (periodData.retiros || []).reduce((sum, item) => sum + item.monto, 0);

        const { efectivo, banco } = calculateCurrentBalances();
        
        const totalCPC = (globalData.cuentasPorCobrar || []).reduce((sum, d) => sum + (d.monto - ((d.abonos || []).reduce((s, a) => s + a.monto, 0))), 0);
        const totalCPP = (globalData.cuentasPorPagar || []).filter(d => d.estado !== 'Pagada').reduce((sum, d) => sum + d.monto - ((d.abonos || []).reduce((s, a) => s + a.monto, 0)), 0);
        
        document.getElementById('total-ingresos').textContent = formatCurrency(totalIngresosMes);
        document.getElementById('total-compras').textContent = formatCurrency(totalComprasMes);
        document.getElementById('total-gastos-op').textContent = formatCurrency(totalGastosOpMes);
        document.getElementById('total-retiros').textContent = formatCurrency(totalRetirosMes);
        document.getElementById('efectivo-caja').textContent = formatCurrency(efectivo);
        document.getElementById('saldo-banco').textContent = formatCurrency(banco);
        document.getElementById('cuentas-cobrar-total').textContent = formatCurrency(totalCPC);
        document.getElementById('cuentas-pagar-total').textContent = formatCurrency(totalCPP);

        const allMovements = [...(globalData.ingresos || []), ...(globalData.compras || []), ...(globalData.gastos || []), ...(globalData.retiros || [])].filter(mov => mov.fecha instanceof Date).sort((a,b) => b.fecha - a.fecha).slice(0, 10);
        const tbody = document.getElementById('ultimos-movimientos-body');
        tbody.innerHTML = allMovements.length === 0 ? `<tr><td colspan="3" class="text-center py-4 text-gray-500">No hay movimientos.</td></tr>` : '';
        allMovements.forEach(mov => {
            const tr = document.createElement('tr'); tr.className = 'bg-white border-b';
            const type = mov.monto_efectivo !== undefined ? 'ingreso' : (mov.proveedor !== undefined ? 'compra' : (mov.categoria !== undefined ? 'gasto' : 'retiro'));
            const desc = mov.notas || mov.descripcion || mov.proveedor || `Venta del d√≠a`;
            const montoClass = type === 'ingreso' ? 'text-green-600' : (type === 'compra' ? 'text-purple-600' : (type === 'gasto' ? 'text-red-600' : 'text-orange-500'));
            tr.innerHTML = `<td class="px-3 sm:px-6 py-4">${mov.fecha.toLocaleDateString()}</td><td class="px-3 sm:px-6 py-4">${desc}</td><td class="px-3 sm:px-6 py-4 font-medium ${montoClass}">${formatCurrency(mov.monto)}</td>`;
            tbody.appendChild(tr);
        });
        updateGastosChart(periodData.gastos);
    };

    const updateGastosChart = (gastos) => {
        const ctx = document.getElementById('gastos-chart').getContext('2d');
        if (gastosChart) gastosChart.destroy();
        const dataPorCategoria = (gastos || []).reduce((acc, gasto) => { acc[gasto.categoria] = (acc[gasto.categoria] || 0) + gasto.monto; return acc; }, {});
        if (Object.keys(dataPorCategoria).length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.save(); ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = '#6b7280'; ctx.font = "16px 'Inter'"; ctx.fillText("No hay gastos para mostrar.", ctx.canvas.width / 2, ctx.canvas.height / 2); ctx.restore(); return; }
        gastosChart = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(dataPorCategoria), datasets: [{ data: Object.values(dataPorCategoria), backgroundColor: ['#ef4444', '#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#f59e0b', '#ec4899', '#6366f1', '#84cc16'], hoverOffset: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'top' }}} });
    };

    // =========================================================================
    // FUNCIONES DE CORTE DE MES
    // =========================================================================
    const initializeCorteModal = () => {
        const today = new Date();
        const currentMonth = today.toISOString().slice(0, 7);
        
        document.getElementById('corte-periodo').value = currentMonth;
        document.getElementById('corte-fecha').value = today.toISOString().slice(0, 10);
        
        showCorteStep(1);
    };

    const showCorteStep = (step) => {
        document.querySelectorAll('.corte-step').forEach(el => el.classList.add('hidden'));
        document.getElementById(`corte-step-${step}`).classList.remove('hidden');
    };

    const generateCortePreview = () => {
        const periodo = document.getElementById('corte-periodo').value;
        const [year, month] = periodo.split('-').map(Number);
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 1);

        // Filtrar datos del per√≠odo
        const periodData = {};
        dataTypes.forEach(type => {
            periodData[type] = (allData[type] || []).filter(d => 
                d.fecha && d.fecha >= startDate && d.fecha < endDate
            );
        });

        // Calcular totales
        const totales = {
            ingresos: periodData.ingresos.reduce((sum, item) => sum + item.monto, 0),
            compras: periodData.compras.reduce((sum, item) => sum + item.monto, 0),
            gastos: periodData.gastos.reduce((sum, item) => sum + item.monto, 0),
            retiros: periodData.retiros.reduce((sum, item) => sum + item.monto, 0)
        };

        // Calcular saldos actuales
        const saldos = calculateCurrentBalances();

        // Cuentas pendientes a transferir
        const cuentasPendientes = {
            porCobrar: (allData.cuentasPorCobrar || []).filter(d => {
                const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0);
                return d.monto > totalAbonado;
            }),
            porPagar: (allData.cuentasPorPagar || []).filter(d => d.estado !== 'Pagada'),
            vales: (allData.vales || []).filter(d => {
                const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0);
                return d.monto > totalAbonado;
            })
        };

        const previewContent = document.getElementById('corte-preview-content');
        previewContent.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                <div class="space-y-4">
                    <h5 class="font-semibold text-gray-800 border-b pb-2">Resumen del Per√≠odo</h5>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Total Ingresos:</span>
                            <span class="font-medium text-green-600">${formatCurrency(totales.ingresos)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Total Compras:</span>
                            <span class="font-medium text-purple-600">${formatCurrency(totales.compras)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Total Gastos:</span>
                            <span class="font-medium text-red-600">${formatCurrency(totales.gastos)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Total Retiros:</span>
                            <span class="font-medium text-orange-600">${formatCurrency(totales.retiros)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <h5 class="font-semibold text-gray-800 border-b pb-2">Saldos Actuales</h5>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Efectivo en Caja:</span>
                            <span class="font-medium text-blue-600">${formatCurrency(saldos.efectivo)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Saldo en Banco:</span>
                            <span class="font-medium text-green-600">${formatCurrency(saldos.banco)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Cuentas por Cobrar:</span>
                            <span class="font-medium">${cuentasPendientes.porCobrar.length} registros</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Cuentas por Pagar:</span>
                            <span class="font-medium">${cuentasPendientes.porPagar.length} registros</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Vales Pendientes:</span>
                            <span class="font-medium">${cuentasPendientes.vales.length} registros</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 sm:mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                <h5 class="font-semibold text-yellow-800 mb-2">¬°Atenci√≥n! ¬øQu√© suceder√° despu√©s del corte?</h5>
                <ul class="text-sm text-yellow-700 space-y-1 list-disc list-inside">
                    <li>El per√≠odo <strong>${periodo}</strong> se marcar√° como <strong>CERRADO</strong> y no podr√° ser modificado.</li>
                    <li>Se crear√°n retiros autom√°ticos por el total de caja y banco para dejar los saldos en cero.</li>
                    <li>Las <strong>cuentas pendientes</strong> (por cobrar, por pagar, vales) ser√°n <strong>transferidas</strong> al nuevo per√≠odo con su <strong>saldo restante</strong>.</li>
                    <li>Los <strong>registros originales</strong> de estas cuentas pendientes ser√°n <strong>eliminados</strong> para evitar duplicados.</li>
                    <li>Los registros de <strong>ingresos, compras y gastos</strong> del per√≠odo cerrado ser√°n eliminados.</li>
                </ul>
            </div>
        `;
    };

    // =========================================================================
    // ========= CAMBIO #1: CALCULAR SALDOS SIN ABONOS DIRECTOS =========
    // Se simplifica la funci√≥n. Los abonos ya se registran como ingresos,
    // por lo que no es necesario sumarlos aqu√≠ de nuevo.
    // =========================================================================
    const calculateCurrentBalances = () => {
        const totalIngresosEfectivo = (allData.ingresos || []).reduce((sum, i) => sum + (i.monto_efectivo || 0), 0);
        const totalIngresosBanco = (allData.ingresos || []).reduce((sum, i) => sum + (i.monto_tarjeta || 0), 0);
        const totalComprasEfectivo = (allData.compras || []).filter(c => c.metodo === 'Efectivo').reduce((sum, c) => sum + c.monto, 0);
        const totalComprasBanco = (allData.compras || []).filter(c => c.metodo === 'Banco').reduce((sum, c) => sum + c.monto, 0);
        const totalGastosOp = (allData.gastos || []).reduce((sum, g) => sum + g.monto, 0);
        const totalRetirosEfectivo = (allData.retiros || []).filter(r => r.metodo === 'Efectivo').reduce((sum, r) => sum + r.monto, 0);
        const totalRetirosBanco = (allData.retiros || []).filter(r => r.metodo === 'Banco').reduce((sum, r) => sum + r.monto, 0);
        
        return {
            efectivo: totalIngresosEfectivo - totalComprasEfectivo - totalGastosOp - totalRetirosEfectivo,
            banco: totalIngresosBanco - totalComprasBanco - totalRetirosBanco
        };
    };

    const executeCorte = async () => {
        const periodo = document.getElementById('corte-periodo').value;
        const fechaCorte = document.getElementById('corte-fecha').value;
        const notas = document.getElementById('corte-notas').value;

        showCorteStep(3);

        const steps = [
            'Validando per√≠odo...',
            'Calculando saldos actuales...',
            'Creando retiros autom√°ticos de cierre...',
            'Transfiriendo cuentas pendientes (cobrar, pagar, vales)...',
            'Eliminando registros transaccionales del per√≠odo cerrado...',
            'Cerrando per√≠odo actual y creando el nuevo...',
            'Finalizando proceso...'
        ];

        const stepsList = document.getElementById('corte-steps-list');
        const progressBar = document.getElementById('corte-progress-bar');
        const progressText = document.getElementById('corte-progress-text');
        stepsList.innerHTML = '';

        try {
            for (let i = 0; i < steps.length; i++) {
                const stepEl = document.createElement('div');
                stepEl.className = 'flex items-center text-sm slide-in text-gray-500';
                stepEl.innerHTML = `
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    <span>${steps[i]}</span>
                `;
                stepsList.appendChild(stepEl);

                progressText.textContent = `Paso ${i + 1} de ${steps.length}: ${steps[i]}`;
                
                // Ejecutar la l√≥gica real seg√∫n el paso
                switch(i) {
                    case 0: // Validando
                        await new Promise(res => setTimeout(res, 200));
                        break;
                    case 1: // Calculando
                        await new Promise(res => setTimeout(res, 200));
                        break;
                    case 2: // Crear retiros autom√°ticos
                        await createAutomaticWithdrawals(fechaCorte);
                        break;
                    case 3: // Transferir cuentas
                        await transferPendingAccounts('cuentasPorCobrar', periodo);
                        await transferPendingAccounts('cuentasPorPagar', periodo);
                        await transferPendingAccounts('vales', periodo);
                        break;
                    case 4: // Eliminar registros del per√≠odo
                        await deleteClosedPeriodRecords(periodo);
                        break;
                    case 5: // Cerrar y crear per√≠odo
                        await closePeriod(periodo, fechaCorte, notas);
                        await createNewPeriod(periodo);
                        break;
                    case 6: // Finalizando
                        await new Promise(res => setTimeout(res, 200));
                        break;
                }
                
                stepEl.innerHTML = `
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    <span class="text-gray-800">${steps[i]}</span>
                `;
                progressBar.style.width = `${((i + 1) / steps.length) * 100}%`;
            }

            showCorteStep(4);
            generateCorteSummary();

        } catch (error) {
            console.error('Error en el corte:', error);
            showNotification('Error', 'Ocurri√≥ un error durante el corte de mes: ' + error.message, 'error');
            // Opcional: volver al paso 1 o cerrar modal
            showCorteStep(1);
        }
    };

    const createAutomaticWithdrawals = async (fechaCorte) => {
        const saldos = calculateCurrentBalances();
        const updates = {};
        
        if (saldos.efectivo > 0) {
            const retiroEfectivo = {
                fecha: fechaCorte,
                metodo: 'Efectivo',
                descripcion: 'Retiro autom√°tico - Cierre de mes',
                monto: saldos.efectivo
            };
            const newKey = database.ref(`businesses/${selectedBusinessId}/retiros`).push().key;
            updates[`/retiros/${newKey}`] = retiroEfectivo;
        }

        if (saldos.banco > 0) {
            const retiroBanco = {
                fecha: fechaCorte,
                metodo: 'Banco',
                descripcion: 'Retiro autom√°tico - Cierre de mes',
                monto: saldos.banco
            };
            const newKey = database.ref(`businesses/${selectedBusinessId}/retiros`).push().key;
            updates[`/retiros/${newKey}`] = retiroBanco;
        }

        if (Object.keys(updates).length > 0) {
            await database.ref(`businesses/${selectedBusinessId}`).update(updates);
        }
    };

    const closePeriod = async (periodo, fechaCorte, notas) => {
        const periodToClose = periods.find(p => p.monthKey === periodo);
        if (periodToClose) {
            await database.ref(`businesses/${selectedBusinessId}/periods/${periodToClose.id}`).update({
                isClosed: true,
                endDate: fechaCorte,
                closedDate: fechaCorte,
                notes: notas
            });
        }
    };

    const transferPendingAccounts = async (type, fromPeriod) => {
        const accountsRef = database.ref(`businesses/${selectedBusinessId}/${type}`);
        const snapshot = await accountsRef.once('value');
        const accounts = firebaseObjectToArray(snapshot);

        const updates = {};

        for (const account of accounts) {
            const totalAbonado = (account.abonos || []).reduce((sum, a) => sum + a.monto, 0);
            const balance = account.monto - totalAbonado;

            let shouldTransfer = false;
            if (type === 'cuentasPorPagar') {
                shouldTransfer = account.estado !== 'Pagada' && balance > 0;
            } else { // Para cuentasPorCobrar y vales
                shouldTransfer = balance > 0;
            }
            
            if (shouldTransfer) {
                updates[`/${type}/${account.id}`] = null;

                const newId = accountsRef.push().key;
                const transferData = {
                    fecha: new Date().toISOString(),
                    monto: balance,
                    abonos: {},
                    transferredFrom: account.id,
                    originalPeriod: fromPeriod,
                    ...(type === 'cuentasPorCobrar' && {
                        cliente: account.cliente,
                        descripcion: `${account.descripcion} (Saldo anterior)`
                    }),
                    ...(type === 'cuentasPorPagar' && {
                        acreedor: account.acreedor,
                        descripcion: `${account.descripcion} (Saldo anterior)`,
                        estado: 'Pendiente'
                    }),
                    ...(type === 'vales' && {
                        persona: account.persona,
                        descripcion: `${account.descripcion} (Saldo anterior)`
                    }),
                };
                
                updates[`/${type}/${newId}`] = transferData;
            }
        }

        if (Object.keys(updates).length > 0) {
            await database.ref(`businesses/${selectedBusinessId}`).update(updates);
        }
    };


    const deleteClosedPeriodRecords = async (periodo) => {
        const [year, month] = periodo.split('-').map(Number);
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 1);

        const updates = {};
        const typesToDelete = ['ingresos', 'compras', 'gastos', 'retiros'];
        
        for (const type of typesToDelete) {
            const records = allData[type] || [];
            const recordsToDelete = records.filter(record => 
                record.fecha && record.fecha >= startDate && record.fecha < endDate && !record.descripcion?.includes('Retiro autom√°tico')
            );

            for (const record of recordsToDelete) {
                updates[`/${type}/${record.id}`] = null;
            }
        }

        if (Object.keys(updates).length > 0) {
            await database.ref(`businesses/${selectedBusinessId}`).update(updates);
        }
    };

    const createNewPeriod = async (currentPeriod) => {
        const nextMonth = getNextMonth(currentPeriod);
        const [year, month] = nextMonth.split('-').map(Number);
        
        const newPeriod = {
            startDate: new Date(year, month - 1, 1).toISOString(),
            endDate: null,
            monthKey: nextMonth,
            isClosed: false,
            createdFrom: currentPeriod
        };

        await database.ref(`businesses/${selectedBusinessId}/periods`).push(newPeriod);
        
        // Cambiar autom√°ticamente al nuevo per√≠odo
        document.getElementById('month-filter').value = nextMonth;
        updateCurrentPeriod();
        refreshUI();
    };

    const getNextMonth = (currentMonth) => {
        const [year, month] = currentMonth.split('-').map(Number);
        const nextDate = new Date(year, month, 1);
        return nextDate.toISOString().slice(0, 7);
    };

    const generateCorteSummary = () => {
        const periodo = document.getElementById('corte-periodo').value;
        const summaryEl = document.getElementById('corte-summary');
        
        summaryEl.innerHTML = `
            <div class="text-center">
                <h5 class="font-semibold text-green-800 mb-4">Corte de Mes Completado</h5>
                <div class="space-y-2 text-sm">
                    <p><strong>Per√≠odo cerrado:</strong> ${periodo}</p>
                    <p><strong>Fecha de corte:</strong> ${document.getElementById('corte-fecha').value}</p>
                    <p><strong>Nuevo per√≠odo activo:</strong> ${getNextMonth(periodo)}</p>
                    <p class="text-green-700 font-medium mt-4">‚úÖ Las cuentas pendientes se transfirieron correctamente.</p>
                </div>
            </div>
        `;
    };

    const generateCorteReport = () => {
        const doc = new jsPDF();
        const businessName = document.getElementById('app-title').textContent.replace('üìä Gesti√≥n: ', '');
        const periodo = document.getElementById('corte-periodo').value;
        
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text('REPORTE DE CORTE DE MES', 14, 22);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text(`Negocio: ${businessName}`, 14, 32);
        doc.text(`Per√≠odo cerrado: ${periodo}`, 14, 38);
        doc.text(`Fecha de corte: ${document.getElementById('corte-fecha').value}`, 14, 44);
        doc.text(`Generado: ${new Date().toLocaleString('es-CO')}`, 14, 50);

        let yPos = 60;
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('RESUMEN DEL PER√çODO CERRADO', 14, yPos);
        
        doc.save(`Corte_Mes_${periodo}_${businessName}.pdf`);
    };

    // =========================================================================
    // EVENT LISTENERS PARA CORTE DE MES
    // =========================================================================
    document.getElementById('close-period-btn').addEventListener('click', () => {
        if (isPeriodClosed()) {
            showNotification('Per√≠odo Cerrado', 'Este per√≠odo ya ha sido cerrado.', 'error');
            return;
        }
        
        initializeCorteModal();
        document.getElementById('corte-mes-modal').style.display = 'flex';
    });

    document.getElementById('close-corte-modal').addEventListener('click', () => {
        document.getElementById('corte-mes-modal').style.display = 'none';
    });

    document.getElementById('corte-next-step1').addEventListener('click', () => {
        generateCortePreview();
        showCorteStep(2);
    });

    document.getElementById('corte-back-step2').addEventListener('click', () => {
        showCorteStep(1);
    });

    document.getElementById('corte-confirm').addEventListener('click', () => {
        executeCorte();
    });

    document.getElementById('corte-download-report').addEventListener('click', () => {
        generateCorteReport();
    });

    document.getElementById('corte-close-modal').addEventListener('click', () => {
        document.getElementById('corte-mes-modal').style.display = 'none';
        location.reload(); 
    });

    // =========================================================================
    // RESTO DE FUNCIONES (UI, FORMULARIOS, ETC.)
    // =========================================================================
    const getNumericValue = (formattedValue) => {
        if (!formattedValue || typeof formattedValue !== 'string') return 0;
        return parseFloat(formattedValue.replace(/\D/g, '')) || 0;
    };

    const changeTab = (tabName) => {
        setFormDatesToToday();
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(tabName).classList.remove('hidden');
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`button[data-tab="${tabName}"]`).classList.add('active');

        if (tabName === 'resumen') refreshUI();
        else if (tabName === 'registros') renderAllTables();
        else if (tabName === 'deudas') { renderCuentasPorCobrar(); renderCuentasPorPagar(); }
        else if (tabName === 'vales') renderVales();
    };

    const formatDateForInput = (date) => new Date(date).toISOString().split('T')[0];
    const formatInputAsCurrency = (e) => { let input = e.target; let value = input.value.replace(/\D/g, ''); if (value) { const number = parseInt(value, 10); input.value = number.toLocaleString('es-CO'); } else { input.value = ''; } };
    const addCurrencyFormatting = (container) => { container.querySelectorAll('[data-moneda]').forEach(input => { input.removeEventListener('input', formatInputAsCurrency); input.addEventListener('input', formatInputAsCurrency); formatInputAsCurrency({ target: input }); }); };
    const renderAllTables = () => { renderTable('ingresos', document.getElementById('tabla-ingresos'), ['Fecha', 'Efectivo', 'Tarjeta', 'Total', 'Notas', 'Acciones']); renderTable('compras', document.getElementById('tabla-compras'), ['Fecha', 'Proveedor', 'Descripci√≥n', 'Monto', 'Pagado con', 'Acciones']); renderTable('gastos', document.getElementById('tabla-gastos'), ['Fecha', 'Descripci√≥n', 'Categor√≠a', 'Monto', 'Acciones']); renderTable('retiros', document.getElementById('tabla-retiros'), ['Fecha', 'Retirado de', 'Descripci√≥n', 'Monto', 'Acciones']); };
    const renderTable = (type, tableEl, headers) => { const data = (allData[type] || []).filter(d => d.fecha instanceof Date).sort((a, b) => b.fecha - a.fecha); tableEl.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${headers.map(h => `<th class="px-3 sm:px-4 py-3">${h}</th>`).join('')}</tr></thead><tbody></tbody>`; const tbody = tableEl.querySelector('tbody'); if (data.length === 0) { tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">No hay registros de ${type}.</td></tr>`; return; } const rowsHTML = data.map(item => { let cellsHTML = ''; if (type === 'ingresos') cellsHTML = `<td class="px-3 sm:px-4 py-3">${item.fecha.toLocaleDateString('es-CO')}</td><td class="px-3 sm:px-4 py-3">${formatCurrency(item.monto_efectivo)}</td><td class="px-3 sm:px-4 py-3">${formatCurrency(item.monto_tarjeta)}</td><td class="px-3 sm:px-4 py-3 font-bold">${formatCurrency(item.monto)}</td><td class="px-3 sm:px-4 py-3">${item.notas || '-'}</td>`; else if (type === 'compras') cellsHTML = `<td class="px-3 sm:px-4 py-3">${item.fecha.toLocaleDateString('es-CO')}</td><td class="px-3 sm:px-4 py-3">${item.proveedor}</td><td class="px-3 sm:px-4 py-3">${item.descripcion}</td><td class="px-3 sm:px-4 py-3">${formatCurrency(item.monto)}</td><td class="px-3 sm:px-4 py-3">${item.metodo}</td>`; else if (type === 'gastos') cellsHTML = `<td class="px-3 sm:px-4 py-3">${item.fecha.toLocaleDateString('es-CO')}</td><td class="px-3 sm:px-4 py-3">${item.descripcion}</td><td class="px-3 sm:px-4 py-3">${item.categoria}</td><td class="px-3 sm:px-4 py-3">${formatCurrency(item.monto)}</td>`; else if (type === 'retiros') cellsHTML = `<td class="px-3 sm:px-4 py-3">${item.fecha.toLocaleDateString('es-CO')}</td><td class="px-3 sm:px-4 py-3">${item.metodo}</td><td class="px-3 sm:px-4 py-3">${item.descripcion}</td><td class="px-3 sm:px-4 py-3">${formatCurrency(item.monto)}</td>`; cellsHTML += `<td class="px-3 sm:px-4 py-3 flex items-center space-x-2"><button class="action-button text-red-600 delete-btn" data-type="${type}" data-id="${item.id}"><i class="fas fa-trash"></i></button></td>`; return `<tr class="bg-white border-b hover:bg-gray-50">${cellsHTML}</tr>`; }).join(''); tbody.innerHTML = rowsHTML; };
    const renderCuentasPorCobrar = () => { const table = document.getElementById('tabla-cuentas-cobrar'); const headers = ['Cliente', 'Total Deuda', 'Abonado', 'Restante', 'Acciones']; table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${headers.map(h => `<th class="px-3 sm:px-4 py-3">${h}</th>`).join('')}</tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); const data = (allData.cuentasPorCobrar || []).filter(d => d.fecha instanceof Date).sort((a,b) => b.fecha - a.fecha); if (data.length === 0) { tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">No hay cuentas por cobrar.</td></tr>`; return; } const rowsHTML = data.map(d => { const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0); const restante = d.monto - totalAbonado; const isPaid = restante <= 0; const rowClass = isPaid ? 'bg-gray-100 text-gray-500' : 'bg-white'; const textStyle = isPaid ? 'line-through' : ''; const actionButtons = isPaid ? `<button class="historial-btn action-button text-blue-600" data-type="cuentasPorCobrar" data-id="${d.id}" title="Ver Historial"><i class="fas fa-history"></i></button> <span class="px-2 py-1 text-xs font-semibold leading-tight text-green-700 bg-green-100 rounded-full">Saldado</span>` : `<button class="historial-btn action-button text-blue-600" data-type="cuentasPorCobrar" data-id="${d.id}" title="Ver Historial"><i class="fas fa-history"></i></button><button class="abono-btn action-button text-green-600" data-type="cuentasPorCobrar" data-id="${d.id}" title="Registrar Abono"><i class="fas fa-plus-circle"></i></button><button class="delete-btn action-button text-red-600" data-type="cuentasPorCobrar" data-id="${d.id}" title="Eliminar"><i class="fas fa-trash"></i></button>`; return `<tr class="${rowClass} border-b hover:bg-gray-50"><td class="px-3 sm:px-4 py-3 font-medium ${textStyle}">${d.cliente}<p class="text-xs font-normal">${d.descripcion}</p></td><td class="px-3 sm:px-4 py-3 ${textStyle}">${formatCurrency(d.monto)}</td><td class="px-3 sm:px-4 py-3 text-green-600 ${textStyle}">${formatCurrency(totalAbonado)}</td><td class="px-3 sm:px-4 py-3 font-bold ${textStyle}">${formatCurrency(restante)}</td><td class="px-3 sm:px-4 py-3 flex items-center gap-1">${actionButtons}</td></tr>`; }).join(''); tbody.innerHTML = rowsHTML; };
    const renderCuentasPorPagar = () => { const table = document.getElementById('tabla-cuentas-pagar'); const headers = ['Proveedor', 'Concepto', 'Monto', 'Estado', 'Acciones']; table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${headers.map(h => `<th class="px-3 sm:px-4 py-3">${h}</th>`).join('')}</tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); const data = (allData.cuentasPorPagar || []).filter(d => d.fecha instanceof Date).sort((a,b) => b.fecha - a.fecha); if (data.length === 0) { tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">No hay cuentas por pagar.</td></tr>`; return; } const rowsHTML = data.map(d => { const isPaid = d.estado === 'Pagada'; const rowClass = isPaid ? 'bg-gray-100 text-gray-500' : 'bg-white'; const textStyle = isPaid ? 'line-through' : ''; const statusBadge = isPaid ? `<span class="px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full">Pagada</span>` : `<span class="px-2 py-1 font-semibold leading-tight text-red-700 bg-red-100 rounded-full">Pendiente</span>`; const actionButtons = isPaid ? `<span class="text-xs text-gray-400">Completado</span>` : `<div class="flex items-center gap-2"><button class="pagar-btn bg-blue-500 text-white text-xs px-2 py-1 rounded-md hover:bg-blue-600" data-id="${d.id}">Pagar</button><button class="delete-btn action-button text-red-600" data-type="cuentasPorPagar" data-id="${d.id}"><i class="fas fa-trash"></i></button></div>`; return `<tr class="${rowClass} border-b"><td class="px-3 sm:px-4 py-3 font-medium ${textStyle}">${d.acreedor}</td><td class="px-3 sm:px-4 py-3 ${textStyle}">${d.descripcion}</td><td class="px-3 sm:px-4 py-3 ${textStyle}">${formatCurrency(d.monto)}</td><td class="px-3 sm:px-4 py-3">${statusBadge}</td><td class="px-3 sm:px-4 py-3">${actionButtons}</td></tr>`; }).join(''); tbody.innerHTML = rowsHTML; };
    const renderVales = () => { const table = document.getElementById('tabla-vales'); const headers = ['Persona', 'Total Vale', 'Abonado', 'Restante', 'Acciones']; table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${headers.map(h => `<th class="px-3 sm:px-4 py-3">${h}</th>`).join('')}</tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); const data = (allData.vales || []).filter(d => d.fecha instanceof Date).sort((a,b) => b.fecha - a.fecha); if (data.length === 0) { tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">No hay vales registrados.</td></tr>`; return; } const rowsHTML = data.map(d => { const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0); const restante = d.monto - totalAbonado; const isPaid = restante <= 0; const rowClass = isPaid ? 'bg-gray-100 text-gray-500' : 'bg-white'; const textStyle = isPaid ? 'line-through' : ''; const actionButtons = isPaid ? `<button class="historial-btn action-button text-blue-600" data-type="vales" data-id="${d.id}" title="Ver Historial"><i class="fas fa-history"></i></button> <span class="px-2 py-1 text-xs font-semibold leading-tight text-green-700 bg-green-100 rounded-full">Saldado</span>` : `<button class="historial-btn action-button text-blue-600" data-type="vales" data-id="${d.id}" title="Ver Historial"><i class="fas fa-history"></i></button><button class="abono-btn action-button text-green-600" data-type="vales" data-id="${d.id}" title="Registrar Abono"><i class="fas fa-plus-circle"></i></button><button class="delete-btn action-button text-red-600" data-type="vales" data-id="${d.id}" title="Eliminar Vale"><i class="fas fa-trash"></i></button>`; return `<tr class="${rowClass} border-b hover:bg-gray-50"><td class="px-3 sm:px-4 py-3 font-medium ${textStyle}">${d.persona}<p class="text-xs font-normal">${d.descripcion}</p></td><td class="px-3 sm:px-4 py-3 ${textStyle}">${formatCurrency(d.monto)}</td><td class="px-3 sm:px-4 py-3 text-green-600 ${textStyle}">${formatCurrency(totalAbonado)}</td><td class="px-3 sm:px-4 py-3 font-bold ${textStyle}">${formatCurrency(restante)}</td><td class="px-3 sm:px-4 py-3 flex items-center gap-1">${actionButtons}</td></tr>`; }).join(''); tbody.innerHTML = rowsHTML; };
    const getTimestampFromDateInput = (dateInputId) => { const dateValue = document.getElementById(dateInputId).value; const now = new Date(); const [year, month, day] = dateValue.split('-').map(Number); return new Date(year, month - 1, day, now.getHours(), now.getMinutes(), now.getSeconds()).toISOString(); };
    const setFormDatesToToday = () => { const today = formatDateForInput(new Date()); ['ingreso-fecha', 'gasto-fecha', 'compra-fecha', 'retiro-fecha'].forEach(id => { const el = document.getElementById(id); if (el) el.value = today; }); };
    const initializeDates = () => { setFormDatesToToday(); const now = new Date(); document.getElementById('month-filter').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; };
    const getRefFor = (type) => database.ref(`businesses/${selectedBusinessId}/${type}`);

    // Event listeners para formularios con validaci√≥n de per√≠odo cerrado
    document.getElementById('form-ingresos').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        if (!validatePeriodAccess()) return;
        const ef = getNumericValue(document.getElementById('ingreso-efectivo').value); 
        const ta = getNumericValue(document.getElementById('ingreso-tarjeta').value); 
        const newData = { fecha: getTimestampFromDateInput('ingreso-fecha'), monto: ef + ta, monto_efectivo: ef, monto_tarjeta: ta, notas: document.getElementById('ingreso-notas').value }; 
        getRefFor('ingresos').push(newData); 
        showNotification('√âxito', 'Ingreso registrado.'); 
        e.target.reset(); 
        addCurrencyFormatting(e.target); 
        changeTab('resumen'); 
    });

    document.getElementById('form-compras').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        if (!validatePeriodAccess()) return;
        const newData = { fecha: getTimestampFromDateInput('compra-fecha'), proveedor: document.getElementById('compra-proveedor').value, descripcion: document.getElementById('compra-descripcion').value, monto: getNumericValue(document.getElementById('compra-monto').value), metodo: document.getElementById('compra-metodo').value }; 
        getRefFor('compras').push(newData); 
        showNotification('√âxito', 'Compra registrada.'); 
        e.target.reset(); 
        addCurrencyFormatting(e.target); 
        changeTab('resumen'); 
    });

    document.getElementById('form-gastos').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        if (!validatePeriodAccess()) return;
        const newData = { fecha: getTimestampFromDateInput('gasto-fecha'), descripcion: document.getElementById('gasto-descripcion').value, categoria: document.getElementById('gasto-categoria').value, monto: getNumericValue(document.getElementById('gasto-monto').value) }; 
        getRefFor('gastos').push(newData); 
        showNotification('√âxito', 'Gasto registrado.'); 
        e.target.reset(); 
        addCurrencyFormatting(e.target); 
        changeTab('resumen'); 
    });

    document.getElementById('form-retiros').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        if (!validatePeriodAccess()) return;
        const newData = { fecha: getTimestampFromDateInput('retiro-fecha'), metodo: document.getElementById('retiro-metodo').value, descripcion: document.getElementById('retiro-descripcion').value, monto: getNumericValue(document.getElementById('retiro-monto').value) }; 
        getRefFor('retiros').push(newData); 
        showNotification('√âxito', 'Retiro registrado.'); 
        e.target.reset(); 
        addCurrencyFormatting(e.target); 
        changeTab('resumen'); 
    });

    document.getElementById('form-cuentas-cobrar').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        if (!validatePeriodAccess()) return;
        const newData = { fecha: new Date().toISOString(), cliente: document.getElementById('cpc-cliente').value, descripcion: document.getElementById('cpc-descripcion').value, monto: getNumericValue(document.getElementById('cpc-monto').value), abonos: {} }; 
        getRefFor('cuentasPorCobrar').push(newData); 
        showNotification('√âxito', 'Deuda por cobrar registrada.'); 
        e.target.reset(); 
        addCurrencyFormatting(e.target); 
    });

    document.getElementById('form-cuentas-pagar').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        if (!validatePeriodAccess()) return;
        const newData = { fecha: new Date().toISOString(), acreedor: document.getElementById('cpp-acreedor').value, descripcion: document.getElementById('cpp-descripcion').value, monto: getNumericValue(document.getElementById('cpp-monto').value), estado: 'Pendiente' }; 
        getRefFor('cuentasPorPagar').push(newData); 
        showNotification('√âxito', 'Cuenta por pagar registrada.'); 
        e.target.reset(); 
        addCurrencyFormatting(e.target); 
    });

    document.getElementById('form-vales').addEventListener('submit', (e) => { 
        e.preventDefault(); 
        if (!validatePeriodAccess()) return;
        const newData = { fecha: new Date().toISOString(), persona: document.getElementById('vale-persona').value, descripcion: document.getElementById('vale-descripcion').value, monto: getNumericValue(document.getElementById('vale-monto').value), abonos: {} }; 
        getRefFor('vales').push(newData); 
        showNotification('√âxito', 'Vale registrado correctamente.'); 
        e.target.reset(); 
        addCurrencyFormatting(e.target); 
    });

    const handleDelete = (type, id) => { 
        if (!validatePeriodAccess()) return;
        const item = (allData[type] || []).find(i => i.id === id); 
        if (!item) return; 
        if ((type === 'cuentasPorCobrar' || type === 'vales') && item.abonos && Object.values(item.abonos).length > 0) { 
            showNotification('Acci√≥n no permitida', 'No puede eliminar un registro que ya tiene abonos. Esto protege la integridad de sus registros de ingresos.', 'error'); 
            return; 
        } 
        showConfirm('Confirmar Eliminaci√≥n', '¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.', () => { 
            getRefFor(type).child(id).remove().then(() => showNotification('√âxito', 'Registro eliminado.')).catch((error) => showNotification('Error', 'No se pudo eliminar: ' + error, 'error')); 
        }); 
    };

    const handleAbonar = (deudaId, type) => { 
        if (!validatePeriodAccess()) return;
        document.getElementById('abono-deuda-id').value = deudaId; 
        document.getElementById('abono-type').value = type; 
        document.getElementById('abono-modal-title').textContent = type === 'vales' ? 'Registrar Abono a Vale' : 'Registrar Abono'; 
        document.getElementById('abono-modal').style.display = 'flex'; 
        addCurrencyFormatting(document.getElementById('abono-modal')); 
    };

    const handleHistorial = (deudaId, type) => { const deuda = (allData[type] || []).find(d => d.id === deudaId); if (!deuda) return; const modal = document.getElementById('historial-modal'); const personKey = type === 'vales' ? 'persona' : 'cliente'; document.getElementById('historial-modal-subtitle').textContent = `Detalle para: ${deuda[personKey]} | Total: ${formatCurrency(deuda.monto)}`; const tbody = document.getElementById('historial-abonos-body'); const abonos = (deuda.abonos || []).filter(a => a.fecha instanceof Date).sort((a,b) => b.fecha - a.fecha); if (abonos.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No se han registrado abonos.</td></tr>`; } else { tbody.innerHTML = abonos.map(abono => `<tr class="border-b"><td class="px-3 sm:px-4 py-3">${abono.fecha.toLocaleDateString('es-CO')}</td><td class="px-3 sm:px-4 py-3">${abono.fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' })}</td><td class="px-3 sm:px-4 py-3 font-medium">${formatCurrency(abono.monto)}</td><td class="px-3 sm:px-4 py-3">${abono.metodo}</td></tr>`).join(''); } modal.style.display = 'flex'; };
    
    // =========================================================================
    // ========= CAMBIO #2: REGISTRAR ABONOS COMO INGRESOS REALES =========
    // Ahora, al guardar un abono, tambi√©n se crea un registro de ingreso.
    // Esto asegura que el dinero entre al flujo de caja correctamente.
    // =========================================================================
    document.getElementById('save-abono-btn').addEventListener('click', async () => { 
        if (!validatePeriodAccess()) return;
        const deudaId = document.getElementById('abono-deuda-id').value; 
        const type = document.getElementById('abono-type').value; 
        const monto = getNumericValue(document.getElementById('abono-monto').value); 
        const metodo = document.getElementById('abono-metodo').value; 
        if (!deudaId || !type || monto <= 0) { 
            showNotification('Error', 'Monto inv√°lido o datos incompletos.', 'error'); 
            return; 
        } 
        try { 
            const nowISO = new Date().toISOString(); 
            
            // 1. Crear el registro de abono en la deuda/vale
            const abonoData = { fecha: nowISO, monto, metodo }; 
            await getRefFor(type).child(deudaId).child('abonos').push(abonoData); 

            // 2. Crear un registro de INGRESO para reflejar el dinero en caja/banco
            const deuda = (allData[type] || []).find(d => d.id === deudaId);
            const persona = type === 'vales' ? (deuda?.persona || 'Vale') : (deuda?.cliente || 'Cliente');
            const ingresoData = {
                fecha: nowISO,
                monto: monto,
                monto_efectivo: metodo === 'Efectivo' ? monto : 0,
                monto_tarjeta: metodo === 'Banco' ? monto : 0,
                notas: `Abono de: ${persona}`
            };
            await getRefFor('ingresos').push(ingresoData);
            
            showNotification('√âxito', 'Abono registrado correctamente como un ingreso.'); 
            document.getElementById('abono-modal').style.display = 'none'; 
            document.getElementById('form-abono').reset(); 
            document.getElementById('abono-monto').value = ''; 
        } catch (err) { 
            showNotification('Error', 'No se pudo completar la operaci√≥n.', 'error'); 
            console.error(err); 
        } 
    });

    const handlePagar = (deudaId) => { 
        if (!validatePeriodAccess()) return;
        const deuda = (allData.cuentasPorPagar || []).find(d => d.id === deudaId); 
        if (!deuda) return; 
        showConfirm('Confirmar Pago', `¬øC√≥mo se pag√≥ esta cuenta de ${formatCurrency(deuda.monto)} a ${deuda.acreedor}?`, (metodo) => { 
            if (metodo) { 
                const compraData = { fecha: new Date().toISOString(), proveedor: deuda.acreedor, descripcion: `Pago Cta. Pendiente: ${deuda.descripcion}`, monto: deuda.monto, metodo: metodo }; 
                getRefFor('compras').push(compraData); 
                getRefFor('cuentasPorPagar').child(deudaId).update({ estado: 'Pagada' }); 
                showNotification('√âxito', `Cuenta pagada y registrada como compra.`); 
            } 
        }, true); 
    };

    const showNotification = (title, message, type = 'success') => { const modal = document.getElementById('notification-modal'); document.getElementById('notification-title').textContent = title; document.getElementById('notification-message').textContent = message; document.getElementById('notification-icon').innerHTML = type === 'success' ? `<i class="fas fa-check-circle text-3xl sm:text-4xl text-green-500"></i>` : `<i class="fas fa-times-circle text-3xl sm:text-4xl text-red-500"></i>`; modal.style.display = 'flex'; };
    const showConfirm = (title, message, callback, showOptions = false) => { const modal = document.getElementById('confirm-modal'); document.getElementById('confirm-title').textContent = title; const msgContainer = document.getElementById('confirm-message-container'); msgContainer.innerHTML = `<p id="confirm-message" class="text-xs sm:text-sm text-gray-500">${message}</p>`; if (showOptions) { msgContainer.insertAdjacentHTML('beforeend', `<div class="mt-4"><select id="confirm-options" class="block w-full rounded-md border-gray-300 shadow-sm"><option value="Efectivo">Efectivo</option><option value="Banco">Banco</option></select></div>`); } confirmCallback = () => { const optionsEl = document.getElementById('confirm-options'); callback(showOptions ? optionsEl.value : true); }; modal.style.display = 'flex'; };
    const cleanupConfirmModal = () => { const modal = document.getElementById('confirm-modal'); const customContent = document.querySelector('#confirm-message-container > div'); if (customContent) customContent.remove(); modal.style.display = 'none'; confirmCallback = null; };
    document.getElementById('notification-close').onclick = () => document.getElementById('notification-modal').style.display = 'none';
    document.getElementById('cancel-confirm-btn').onclick = cleanupConfirmModal;
    document.getElementById('confirm-btn').addEventListener('click', () => { if (confirmCallback) { confirmCallback(); } cleanupConfirmModal(); });
    document.getElementById('cancel-edit-btn').onclick = () => document.getElementById('edit-modal').style.display = 'none';
    document.getElementById('cancel-abono-btn').onclick = () => document.getElementById('abono-modal').style.display = 'none';
    document.getElementById('cancel-historial-btn').onclick = () => document.getElementById('historial-modal').style.display = 'none';
    document.getElementById('logout-btn-main').addEventListener('click', handleLogout);
    document.getElementById('logout-btn-selector').addEventListener('click', handleLogout);
    document.getElementById('switch-business-btn').addEventListener('click', showBusinessSelector);
    document.getElementById('month-filter').addEventListener('change', refreshUI);
    document.body.addEventListener('click', (e) => { const target = e.target; const deleteBtn = target.closest('.delete-btn'); const pdfBtn = target.closest('.btn-pdf'); const tabBtn = target.closest('.tab-button'); const abonoBtn = target.closest('.abono-btn'); const pagarBtn = target.closest('.pagar-btn'); const historialBtn = target.closest('.historial-btn'); if (tabBtn) changeTab(tabBtn.dataset.tab); else if (deleteBtn) handleDelete(deleteBtn.dataset.type, deleteBtn.dataset.id); else if (pdfBtn) { const type = pdfBtn.dataset.type; if (type === 'deudas-cobrar') exportDeudasPDF('cuentasPorCobrar'); else if (type === 'deudas-pagar') exportDeudasPDF('cuentasPorPagar'); else if (type === 'vales') exportDeudasPDF('vales'); else exportToPDF(type); } else if (abonoBtn) handleAbonar(abonoBtn.dataset.id, abonoBtn.dataset.type); else if (pagarBtn) handlePagar(pagarBtn.dataset.id); else if (historialBtn) handleHistorial(historialBtn.dataset.id, historialBtn.dataset.type); });

    // =========================================================================
    // FUNCIONES DE PDF (mantenidas del c√≥digo original)
    // =========================================================================
    const reportTitles = {
        ingresos: 'Ingresos', compras: 'Compras', gastos: 'Gastos Operacionales', retiros: 'Retiros del Jefe',
        cuentasPorCobrar: 'Cuentas por Cobrar', cuentasPorPagar: 'Cuentas por Pagar', vales: 'Vales de Personal'
    };

    const drawHeader = (doc, title) => {
        const businessName = document.getElementById('app-title').textContent.replace('üìä Gesti√≥n: ', '');
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text(title, 14, 22);
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100);
        doc.text(`Negocio: ${businessName}`, 14, 30);
        doc.text(`Generado el: ${new Date().toLocaleString('es-CO')}`, 14, 36);
        return 40;
    };

    const exportToPDF = (type) => {
        const data = (allData[type] || []).filter(d => d.fecha instanceof Date).sort((a, b) => b.fecha - a.fecha);
        const title = `Reporte de ${reportTitles[type]}`;

        if (data.length === 0) {
            showNotification('Sin datos', `No hay registros para generar el reporte de ${reportTitles[type]}.`, 'error');
            return;
        }

        const doc = new jsPDF();
        let startY = drawHeader(doc, title);

        let groupingKey, headers, grandTotals = {};
        switch(type) {
            case 'ingresos':
                groupingKey = 'metodo';
                headers = [['Fecha', 'Notas', 'Monto']];
                grandTotals = { Efectivo: 0, Banco: 0 };
                break;
            case 'compras':
            case 'retiros':
                groupingKey = 'metodo';
                headers = [['Fecha', 'Descripci√≥n', 'Monto']];
                grandTotals = { Efectivo: 0, Banco: 0 };
                break;
            case 'gastos':
                groupingKey = 'categoria';
                headers = [['Fecha', 'Descripci√≥n', 'Monto']];
                break;
        }

        const groupedData = data.reduce((acc, item) => {
            let key;
            if (type === 'ingresos') {
                if (item.monto_efectivo > 0) acc['Efectivo'] = [...(acc['Efectivo'] || []), {...item, monto_grupo: item.monto_efectivo}];
                if (item.monto_tarjeta > 0) acc['Banco'] = [...(acc['Banco'] || []), {...item, monto_grupo: item.monto_tarjeta, notas: item.notas + " (Tarjeta/Banco)"}];
                return acc;
            } else {
                key = item[groupingKey];
            }
            if (!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {});
        
        for (const groupName in groupedData) {
            const groupItems = groupedData[groupName];
            const subTotal = groupItems.reduce((sum, item) => sum + (item.monto_grupo !== undefined ? item.monto_grupo : item.monto), 0);
            
            if (grandTotals[groupName] !== undefined) grandTotals[groupName] = subTotal;
            else grandTotals[groupName] = (grandTotals[groupName] || 0) + subTotal;

            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(groupName, 14, startY);
            startY += 6;
            
            const body = groupItems.map(item => {
                let row = [item.fecha.toLocaleDateString('es-CO')];
                if (type === 'ingresos') row.push(item.notas || '-', formatCurrency(item.monto_grupo));
                else row.push(item.proveedor || item.descripcion, formatCurrency(item.monto));
                return row;
            });
            
            const summaryRow = [{ content: `Subtotal ${groupName}:`, colSpan: headers[0].length - 1, styles: { halign: 'right', fontStyle: 'bold' } }, { content: formatCurrency(subTotal), styles: { fontStyle: 'bold' } }];
            body.push(summaryRow);

            doc.autoTable({ head: headers, body, startY, theme: 'grid' });
            startY = doc.lastAutoTable.finalY + 10;
        }

        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Resumen General', 14, startY);
        startY += 8;
        doc.setFontSize(12);
        
        let totalGeneral = 0;
        for (const key in grandTotals) {
            doc.setFont('helvetica', 'normal');
            doc.text(`Total ${key}:`, 16, startY);
            doc.setFont('helvetica', 'bold');
            doc.text(formatCurrency(grandTotals[key]), 70, startY);
            totalGeneral += grandTotals[key];
            startY += 7;
        }
        
        doc.setLineWidth(0.5);
        doc.line(14, startY - 3, 100, startY - 3);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('Gran Total:', 16, startY + 3);
        doc.text(formatCurrency(totalGeneral), 70, startY + 3);

        doc.save(`Reporte_Profesional_${reportTitles[type]}.pdf`);
        showNotification('√âxito', 'El reporte profesional se ha generado.');
    };

    const exportDeudasPDF = (type) => {
        const data = (allData[type] || []).filter(d => d.fecha instanceof Date).sort((a, b) => b.fecha - a.fecha);
        const title = `Reporte de ${reportTitles[type]}`;
        
        if (data.length === 0) {
            showNotification('Sin datos', `No hay registros para generar el reporte de ${reportTitles[type]}.`, 'error');
            return;
        }
        
        const doc = new jsPDF();
        let startY = drawHeader(doc, title);
        
        const personHeader = type === 'vales' ? 'Persona' : (type === 'cuentasPorPagar' ? 'Acreedor' : 'Cliente');
        const headers = [[personHeader, 'Concepto', 'Total Deuda', 'Abonado', 'Saldo']];
        
        const processedData = data.map(d => {
            const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0);
            const restante = d.monto - totalAbonado;
            let estado = d.estado || (restante <= 0 ? 'Saldado' : 'Pendiente');
            if (type === 'cuentasPorPagar' && d.estado === 'Pagada') estado = 'Pagada';
            return { ...d, totalAbonado, restante, estado };
        });

        const groupedData = processedData.reduce((acc, item) => {
            const key = item.estado;
            if (!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {});

        const grandTotals = { deuda: 0, abonado: 0, restante: 0 };
        const groupOrder = (type === 'cuentasPorPagar') ? ['Pendiente', 'Pagada'] : ['Pendiente', 'Saldado'];

        groupOrder.forEach(groupName => {
            if (!groupedData[groupName]) return;

            const groupItems = groupedData[groupName];
            const subTotals = groupItems.reduce((acc, item) => {
                acc.deuda += item.monto;
                acc.abonado += item.totalAbonado;
                acc.restante += item.restante;
                return acc;
            }, { deuda: 0, abonado: 0, restante: 0 });

            grandTotals.deuda += subTotals.deuda;
            grandTotals.abonado += subTotals.abonado;
            grandTotals.restante += subTotals.restante;
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(`Estado: ${groupName}`, 14, startY);
            startY += 6;

            const body = groupItems.map(d => [
                d[personHeader.toLowerCase()] || d.cliente || d.persona, d.descripcion,
                formatCurrency(d.monto), formatCurrency(d.totalAbonado), formatCurrency(d.restante)
            ]);

            body.push([
                { content: `Subtotal ${groupName}:`, colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } },
                { content: formatCurrency(subTotals.deuda), styles: { fontStyle: 'bold' } },
                { content: formatCurrency(subTotals.abonado), styles: { fontStyle: 'bold' } },
                { content: formatCurrency(subTotals.restante), styles: { fontStyle: 'bold' } }
            ]);

            doc.autoTable({ head: headers, body, startY, theme: 'grid' });
            startY = doc.lastAutoTable.finalY + 10;
        });
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Resumen General de Cuentas', 14, startY);
        startY += 8;
        doc.setFontSize(12);

        doc.setFont('helvetica', 'normal');
        doc.text(`Total Deuda (Original):`, 16, startY);
        doc.text(`Total Abonado:`, 16, startY + 7);
        doc.setFont('helvetica', 'bold');
        doc.text(`Total Saldo Pendiente:`, 16, startY + 14);

        doc.setFont('helvetica', 'bold');
        doc.text(formatCurrency(grandTotals.deuda), 70, startY);
        doc.text(formatCurrency(grandTotals.abonado), 70, startY + 7);
        doc.setLineWidth(0.5);
        doc.line(70, startY + 9, 100, startY + 9);
        doc.text(formatCurrency(grandTotals.restante), 70, startY + 14);
        
        doc.save(`Reporte_Profesional_${reportTitles[type]}.pdf`);
        showNotification('√âxito', 'El reporte profesional se ha generado.');
    };
});
</script>
</body>
</html>
