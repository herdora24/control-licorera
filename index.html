<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financiero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-success {
            animation: pulseSuccess 0.6s ease-in-out;
        }
        @keyframes pulseSuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Sistema Financiero</h1>
                    <p class="text-gray-600 text-sm sm:text-base">Gesti贸n integral de finanzas</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                    <select id="periodSelect" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <button id="monthClosureBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">
                        Cierre de Mes
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex flex-wrap border-b border-gray-200">
                <button class="tab-btn active px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600" data-tab="cash">
                     Efectivo
                </button>
                <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="accounts-receivable">
                     Cuentas por Cobrar
                </button>
                <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="accounts-payable">
                     Cuentas por Pagar
                </button>
                <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="vouchers">
                     Vales
                </button>
                <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="summary">
                     Resumen
                </button>
            </div>
        </div>

        <!-- Tab Contents -->
        <div id="cash-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Cash Entry Form -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"> Registro de Efectivo</h2>
                    <form id="cashForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci贸n</label>
                            <input type="text" id="cashDescription" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Efectivo</label>
                                <input type="number" id="cashAmount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Transferencia</label>
                                <input type="number" id="bankAmount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Registrar
                        </button>
                    </form>
                </div>

                <!-- Cash Summary -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"> Resumen de Efectivo</h2>
                    <div class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-green-800 font-medium">Total Efectivo:</span>
                                <span id="totalCash" class="text-green-800 font-bold text-lg">$0</span>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-blue-800 font-medium">Total Transferencias:</span>
                                <span id="totalBank" class="text-blue-800 font-bold text-lg">$0</span>
                            </div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-purple-800 font-medium">Total General:</span>
                                <span id="grandTotal" class="text-purple-800 font-bold text-xl">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cash Records -->
            <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4"> Registros de Efectivo</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Fecha</th>
                                <th class="px-4 py-2 text-left">Descripci贸n</th>
                                <th class="px-4 py-2 text-right">Efectivo</th>
                                <th class="px-4 py-2 text-right">Transferencia</th>
                                <th class="px-4 py-2 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cashRecords">
                            <!-- Records will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Accounts Receivable Tab -->
        <div id="accounts-receivable-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Form -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"> Nueva Cuenta por Cobrar</h2>
                    <form id="accountReceivableForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                            <input type="text" id="arClient" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci贸n</label>
                            <input type="text" id="arDescription" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Monto Total</label>
                            <input type="number" id="arAmount" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                            Crear Cuenta por Cobrar
                        </button>
                    </form>
                </div>

                <!-- Summary -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"> Resumen Cuentas por Cobrar</h2>
                    <div class="space-y-4">
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-yellow-800 font-medium">Total por Cobrar:</span>
                                <span id="totalReceivable" class="text-yellow-800 font-bold text-lg">$0</span>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-green-800 font-medium">Total Cobrado:</span>
                                <span id="totalCollected" class="text-green-800 font-bold text-lg">$0</span>
                            </div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-red-800 font-medium">Saldo Pendiente:</span>
                                <span id="pendingReceivable" class="text-red-800 font-bold text-lg">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounts Receivable Records -->
            <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4"> Cuentas por Cobrar</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Fecha</th>
                                <th class="px-4 py-2 text-left">Cliente</th>
                                <th class="px-4 py-2 text-left">Descripci贸n</th>
                                <th class="px-4 py-2 text-right">Monto</th>
                                <th class="px-4 py-2 text-right">Abonado</th>
                                <th class="px-4 py-2 text-right">Saldo</th>
                                <th class="px-4 py-2 text-center">Estado</th>
                                <th class="px-4 py-2 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="accountsReceivableRecords">
                            <!-- Records will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Accounts Payable Tab -->
        <div id="accounts-payable-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Form -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"> Nueva Cuenta por Pagar</h2>
                    <form id="accountPayableForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Proveedor</label>
                            <input type="text" id="apSupplier" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci贸n</label>
                            <input type="text" id="apDescription" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Monto Total</label>
                            <input type="number" id="apAmount" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                            Crear Cuenta por Pagar
                        </button>
                    </form>
                </div>

                <!-- Summary -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"> Resumen Cuentas por Pagar</h2>
                    <div class="space-y-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-red-800 font-medium">Total por Pagar:</span>
                                <span id="totalPayable" class="text-red-800 font-bold text-lg">$0</span>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-green-800 font-medium">Total Pagado:</span>
                                <span id="totalPaid" class="text-green-800 font-bold text-lg">$0</span>
                            </div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-yellow-800 font-medium">Saldo Pendiente:</span>
                                <span id="pendingPayable" class="text-yellow-800 font-bold text-lg">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounts Payable Records -->
            <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4"> Cuentas por Pagar</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Fecha</th>
                                <th class="px-4 py-2 text-left">Proveedor</th>
                                <th class="px-4 py-2 text-left">Descripci贸n</th>
                                <th class="px-4 py-2 text-right">Monto</th>
                                <th class="px-4 py-2 text-right">Pagado</th>
                                <th class="px-4 py-2 text-right">Saldo</th>
                                <th class="px-4 py-2 text-center">Estado</th>
                                <th class="px-4 py-2 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="accountsPayableRecords">
                            <!-- Records will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Vouchers Tab -->
        <div id="vouchers-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Form -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"> Nuevo Vale</h2>
                    <form id="voucherForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Empleado</label>
                            <input type="text" id="voucherEmployee" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Concepto</label>
                            <input type="text" id="voucherConcept" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Monto</label>
                            <input type="number" id="voucherAmount" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                            Crear Vale
                        </button>
                    </form>
                </div>

                <!-- Summary -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4"> Resumen de Vales</h2>
                    <div class="space-y-4">
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-purple-800 font-medium">Total Vales:</span>
                                <span id="totalVouchers" class="text-purple-800 font-bold text-lg">$0</span>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-green-800 font-medium">Total Pagado:</span>
                                <span id="totalVouchersPaid" class="text-green-800 font-bold text-lg">$0</span>
                            </div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-red-800 font-medium">Saldo Pendiente:</span>
                                <span id="pendingVouchers" class="text-red-800 font-bold text-lg">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vouchers Records -->
            <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4"> Vales Registrados</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Fecha</th>
                                <th class="px-4 py-2 text-left">Empleado</th>
                                <th class="px-4 py-2 text-left">Concepto</th>
                                <th class="px-4 py-2 text-right">Monto</th>
                                <th class="px-4 py-2 text-right">Pagado</th>
                                <th class="px-4 py-2 text-right">Saldo</th>
                                <th class="px-4 py-2 text-center">Estado</th>
                                <th class="px-4 py-2 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="vouchersRecords">
                            <!-- Records will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Summary Tab -->
        <div id="summary-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Cash Summary Card -->
                <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm">Efectivo Total</p>
                            <p id="summaryCash" class="text-2xl font-bold">$0</p>
                        </div>
                        <div class="text-green-200">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Bank Summary Card -->
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm">Transferencias</p>
                            <p id="summaryBank" class="text-2xl font-bold">$0</p>
                        </div>
                        <div class="text-blue-200">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Receivables Summary Card -->
                <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-yellow-100 text-sm">Por Cobrar</p>
                            <p id="summaryReceivables" class="text-2xl font-bold">$0</p>
                        </div>
                        <div class="text-yellow-200">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Payables Summary Card -->
                <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-red-100 text-sm">Por Pagar</p>
                            <p id="summaryPayables" class="text-2xl font-bold">$0</p>
                        </div>
                        <div class="text-red-200">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Summary -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6"> Resumen Detallado del Per铆odo</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Income Section -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-green-700 border-b border-green-200 pb-2"> Ingresos</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Efectivo en Caja:</span>
                                <span id="detailCash" class="font-medium text-green-600">$0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Transferencias:</span>
                                <span id="detailBank" class="font-medium text-blue-600">$0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Cobros Realizados:</span>
                                <span id="detailCollected" class="font-medium text-green-600">$0</span>
                            </div>
                            <div class="flex justify-between py-2 font-semibold text-green-700 border-t-2 border-green-200 pt-2">
                                <span>Total Ingresos:</span>
                                <span id="totalIncome">$0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Expenses Section -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-red-700 border-b border-red-200 pb-2"> Egresos</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Pagos Realizados:</span>
                                <span id="detailPaid" class="font-medium text-red-600">$0</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Vales Pagados:</span>
                                <span id="detailVouchersPaid" class="font-medium text-red-600">$0</span>
                            </div>
                            <div class="flex justify-between py-2 font-semibold text-red-700 border-t-2 border-red-200 pt-2">
                                <span>Total Egresos:</span>
                                <span id="totalExpenses">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Net Balance -->
                <div class="mt-6 pt-6 border-t-2 border-gray-200">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold text-gray-700">Balance Neto del Per铆odo:</span>
                            <span id="netBalance" class="text-2xl font-bold">$0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="paymentModalTitle" class="text-lg font-bold text-gray-800">Registrar Pago</h3>
                    <button id="closePaymentModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <form id="paymentForm" class="space-y-4">
                    <div id="paymentInfo" class="bg-gray-50 p-4 rounded-lg mb-4">
                        <!-- Payment info will be populated by JavaScript -->
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Efectivo</label>
                            <input type="number" id="paymentCash" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Transferencia</label>
                            <input type="number" id="paymentBank" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="flex justify-between text-sm">
                            <span>Total a pagar:</span>
                            <span id="totalPaymentAmount" class="font-medium">$0</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Registrar Pago
                        </button>
                        <button type="button" id="cancelPayment" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Month Closure Modal -->
    <div id="monthClosureModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800"> Cierre de Mes</h3>
                    <button id="closeMonthModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="monthClosureContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span id="successMessage">Operaci贸n exitosa</span>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLzKbKhwMBhgEQHZPpJBUhHhzKJhJhJhJ",
            authDomain: "financial-system-demo.firebaseapp.com",
            databaseURL: "https://financial-system-demo-default-rtdb.firebaseio.com",
            projectId: "financial-system-demo",
            storageBucket: "financial-system-demo.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456789012345678"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global Variables
        let currentPeriod = getCurrentPeriod();
        let currentPaymentId = null;
        let currentPaymentType = null;

        // Utility Functions
        function getCurrentPeriod() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showSuccess(message) {
            const toast = document.getElementById('successToast');
            const messageEl = document.getElementById('successMessage');
            messageEl.textContent = message;
            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        // Period Management
        function populatePeriodSelect() {
            const select = document.getElementById('periodSelect');
            const currentDate = new Date();
            
            // Clear existing options
            select.innerHTML = '';
            
            // Add current and previous 12 months
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const period = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const option = document.createElement('option');
                option.value = period;
                option.textContent = date.toLocaleDateString('es-CO', { year: 'numeric', month: 'long' });
                if (period === currentPeriod) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }

        // Tab Management
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.getAttribute('data-tab');
                    
                    // Update button states
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    });
                    button.classList.add('active', 'border-blue-500', 'text-blue-600');
                    button.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Update content visibility
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(`${tabName}-tab`).classList.remove('hidden');
                    
                    // Load data for the active tab
                    loadTabData(tabName);
                });
            });
        }

        function loadTabData(tabName) {
            switch(tabName) {
                case 'cash':
                    loadCashData();
                    break;
                case 'accounts-receivable':
                    loadAccountsReceivableData();
                    break;
                case 'accounts-payable':
                    loadAccountsPayableData();
                    break;
                case 'vouchers':
                    loadVouchersData();
                    break;
                case 'summary':
                    loadSummaryData();
                    break;
            }
        }

        // Cash Management
        function initializeCashForm() {
            const form = document.getElementById('cashForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const description = document.getElementById('cashDescription').value;
                const cashAmount = parseFloat(document.getElementById('cashAmount').value) || 0;
                const bankAmount = parseFloat(document.getElementById('bankAmount').value) || 0;
                
                if (cashAmount === 0 && bankAmount === 0) {
                    alert('Debe ingresar al menos un monto en efectivo o transferencia');
                    return;
                }
                
                const cashEntry = {
                    description,
                    cash: cashAmount,
                    bank: bankAmount,
                    date: new Date().toISOString(),
                    period: currentPeriod
                };
                
                try {
                    await database.ref(`cash/${currentPeriod}`).push(cashEntry);
                    form.reset();
                    loadCashData();
                    showSuccess('Registro de efectivo guardado exitosamente');
                } catch (error) {
                    console.error('Error saving cash entry:', error);
                    alert('Error al guardar el registro');
                }
            });
        }

        async function loadCashData() {
            try {
                const snapshot = await database.ref(`cash/${currentPeriod}`).once('value');
                const data = snapshot.val() || {};
                
                let totalCash = 0;
                let totalBank = 0;
                const records = [];
                
                Object.entries(data).forEach(([key, value]) => {
                    totalCash += value.cash || 0;
                    totalBank += value.bank || 0;
                    records.push({ id: key, ...value });
                });
                
                // Update summary
                document.getElementById('totalCash').textContent = formatCurrency(totalCash);
                document.getElementById('totalBank').textContent = formatCurrency(totalBank);
                document.getElementById('grandTotal').textContent = formatCurrency(totalCash + totalBank);
                
                // Update records table
                const tbody = document.getElementById('cashRecords');
                tbody.innerHTML = records.sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(record => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-sm">${formatDate(record.date)}</td>
                            <td class="px-4 py-2 text-sm">${record.description}</td>
                            <td class="px-4 py-2 text-sm text-right">${formatCurrency(record.cash || 0)}</td>
                            <td class="px-4 py-2 text-sm text-right">${formatCurrency(record.bank || 0)}</td>
                            <td class="px-4 py-2 text-center">
                                <button onclick="deleteCashRecord('${record.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                    Eliminar
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
            } catch (error) {
                console.error('Error loading cash data:', error);
            }
        }

        async function deleteCashRecord(id) {
            if (confirm('驴Est谩 seguro de eliminar este registro?')) {
                try {
                    await database.ref(`cash/${currentPeriod}/${id}`).remove();
                    loadCashData();
                    showSuccess('Registro eliminado exitosamente');
                } catch (error) {
                    console.error('Error deleting cash record:', error);
                    alert('Error al eliminar el registro');
                }
            }
        }

        // Accounts Receivable Management
        function initializeAccountsReceivableForm() {
            const form = document.getElementById('accountReceivableForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const client = document.getElementById('arClient').value;
                const description = document.getElementById('arDescription').value;
                const amount = parseFloat(document.getElementById('arAmount').value);
                
                const account = {
                    client,
                    description,
                    amount,
                    paid: 0,
                    date: new Date().toISOString(),
                    period: currentPeriod,
                    status: 'pending'
                };
                
                try {
                    await database.ref(`accountsReceivable/${currentPeriod}`).push(account);
                    form.reset();
                    loadAccountsReceivableData();
                    showSuccess('Cuenta por cobrar creada exitosamente');
                } catch (error) {
                    console.error('Error saving account receivable:', error);
                    alert('Error al guardar la cuenta por cobrar');
                }
            });
        }

        async function loadAccountsReceivableData() {
            try {
                const snapshot = await database.ref(`accountsReceivable/${currentPeriod}`).once('value');
                const data = snapshot.val() || {};
                
                let totalReceivable = 0;
                let totalCollected = 0;
                const records = [];
                
                Object.entries(data).forEach(([key, value]) => {
                    totalReceivable += value.amount || 0;
                    totalCollected += value.paid || 0;
                    records.push({ id: key, ...value });
                });
                
                const pendingReceivable = totalReceivable - totalCollected;
                
                // Update summary
                document.getElementById('totalReceivable').textContent = formatCurrency(totalReceivable);
                document.getElementById('totalCollected').textContent = formatCurrency(totalCollected);
                document.getElementById('pendingReceivable').textContent = formatCurrency(pendingReceivable);
                
                // Update records table
                const tbody = document.getElementById('accountsReceivableRecords');
                tbody.innerHTML = records.sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(record => {
                        const balance = (record.amount || 0) - (record.paid || 0);
                        const status = balance <= 0 ? 'paid' : 'pending';
                        const statusText = status === 'paid' ? 'Pagado' : 'Pendiente';
                        const statusClass = status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                        
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 text-sm">${formatDate(record.date)}</td>
                                <td class="px-4 py-2 text-sm">${record.client}</td>
                                <td class="px-4 py-2 text-sm">${record.description}</td>
                                <td class="px-4 py-2 text-sm text-right">${formatCurrency(record.amount || 0)}</td>
                                <td class="px-4 py-2 text-sm text-right">${formatCurrency(record.paid || 0)}</td>
                                <td class="px-4 py-2 text-sm text-right">${formatCurrency(balance)}</td>
                                <td class="px-4 py-2 text-center">
                                    <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${statusText}</span>
                                </td>
                                <td class="px-4 py-2 text-center">
                                    ${balance > 0 ? `
                                        <button onclick="openPaymentModal('${record.id}', 'receivable')" class="text-blue-600 hover:text-blue-800 text-sm mr-2">
                                            Cobrar
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteAccountReceivable('${record.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
            } catch (error) {
                console.error('Error loading accounts receivable data:', error);
            }
        }

        async function deleteAccountReceivable(id) {
            if (confirm('驴Est谩 seguro de eliminar esta cuenta por cobrar?')) {
                try {
                    await database.ref(`accountsReceivable/${currentPeriod}/${id}`).remove();
                    loadAccountsReceivableData();
                    showSuccess('Cuenta por cobrar eliminada exitosamente');
                } catch (error) {
                    console.error('Error deleting account receivable:', error);
                    alert('Error al eliminar la cuenta por cobrar');
                }
            }
        }

        // Accounts Payable Management
        function initializeAccountsPayableForm() {
            const form = document.getElementById('accountPayableForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const supplier = document.getElementById('apSupplier').value;
                const description = document.getElementById('apDescription').value;
                const amount = parseFloat(document.getElementById('apAmount').value);
                
                const account = {
                    supplier,
                    description,
                    amount,
                    paid: 0,
                    date: new Date().toISOString(),
                    period: currentPeriod,
                    status: 'pending'
                };
                
                try {
                    await database.ref(`accountsPayable/${currentPeriod}`).push(account);
                    form.reset();
                    loadAccountsPayableData();
                    showSuccess('Cuenta por pagar creada exitosamente');
                } catch (error) {
                    console.error('Error saving account payable:', error);
                    alert('Error al guardar la cuenta por pagar');
                }
            });
        }

        async function loadAccountsPayableData() {
            try {
                const snapshot = await database.ref(`accountsPayable/${currentPeriod}`).once('value');
                const data = snapshot.val() || {};
                
                let totalPayable = 0;
                let totalPaid = 0;
                const records = [];
                
                Object.entries(data).forEach(([key, value]) => {
                    totalPayable += value.amount || 0;
                    totalPaid += value.paid || 0;
                    records.push({ id: key, ...value });
                });
                
                const pendingPayable = totalPayable - totalPaid;
                
                // Update summary
                document.getElementById('totalPayable').textContent = formatCurrency(totalPayable);
                document.getElementById('totalPaid').textContent = formatCurrency(totalPaid);
                document.getElementById('pendingPayable').textContent = formatCurrency(pendingPayable);
                
                // Update records table
                const tbody = document.getElementById('accountsPayableRecords');
                tbody.innerHTML = records.sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(record => {
                        const balance = (record.amount || 0) - (record.paid || 0);
                        const status = balance <= 0 ? 'paid' : 'pending';
                        const statusText = status === 'paid' ? 'Pagado' : 'Pendiente';
                        const statusClass = status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 text-sm">${formatDate(record.date)}</td>
                                <td class="px-4 py-2 text-sm">${record.supplier}</td>
                                <td class="px-4 py-2 text-sm">${record.description}</td>
                                <td class="px-4 py-2 text-sm text-right">${formatCurrency(record.amount || 0)}</td>
                                <td class="px-4 py-2 text-sm text-right">${formatCurrency(record.paid || 0)}</td>
                                <td class="px-4 py-2 text-sm text-right">${formatCurrency(balance)}</td>
                                <td class="px-4 py-2 text-center">
                                    <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${statusText}</span>
                                </td>
                                <td class="px-4 py-2 text-center">
                                    ${balance > 0 ? `
                                        <button onclick="openPaymentModal('${record.id}', 'payable')" class="text-blue-600 hover:text-blue-800 text-sm mr-2">
                                            Pagar
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteAccountPayable('${record.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
            } catch (error) {
                console.error('Error loading accounts payable data:', error);
            }
        }

        async function deleteAccountPayable(id) {
            if (confirm('驴Est谩 seguro de eliminar esta cuenta por pagar?')) {
                try {
                    await database.ref(`accountsPayable/${currentPeriod}/${id}`).remove();
                    loadAccountsPayableData();
                    showSuccess('Cuenta por pagar eliminada exitosamente');
                } catch (error) {
                    console.error('Error deleting account payable:', error);
                    alert('Error al eliminar la cuenta por pagar');
                }
            }
        }

        // Vouchers Management
        function initializeVouchersForm() {
            const form = document.getElementById('voucherForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const employee = document.getElementById('voucherEmployee').value;
                const concept = document.getElementById('voucherConcept').value;
                const amount = parseFloat(document.getElementById('voucherAmount').value);
                
                const voucher = {
                    employee,
                    concept,
                    amount,
                    paid: 0,
                    date: new Date().toISOString(),
                    period: currentPeriod,
                    status: 'pending'
                };
                
                try {
                    await database.ref(`vouchers/${currentPeriod}`).push(voucher);
                    form.reset();
                    loadVouchersData();
                    showSuccess('Vale creado exitosamente');
                } catch (error) {
                    console.error('Error saving voucher:', error);
                    alert('Error al guardar el vale');
                }
            });
        }

        async function loadVouchersData() {
            try {
                const snapshot = await database.ref(`vouchers/${currentPeriod}`).once('value');
                const data = snapshot.val() || {};
                
                let totalVouchers = 0;
                let totalVouchersPaid = 0;
                const records = [];
                
                Object.entries(data).forEach(([key, value]) => {
                    totalVouchers += value.amount || 0;
                    totalVouchersPaid += value.paid || 0;
                    records.push({ id: key, ...value });
                });
                
                const pendingVouchers = totalVouchers - totalVouchersPaid;
                
                // Update summary
                document.getElementById('totalVouchers').textContent = formatCurrency(totalVouchers);
                document.getElementById('totalVouchersPaid').textContent = formatCurrency(totalVouchersPaid);
                document.getElementById('pendingVouchers').textContent = formatCurrency(pendingVouchers);
                
                // Update records table
                const tbody = document.getElementById('vouchersRecords');
                tbody.innerHTML = records.sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(record => {
                        const balance = (record.amount || 0) - (record.paid || 0);
                        const status = balance <= 0 ? 'paid' : 'pending';
                        const statusText = status === 'paid' ? 'Pagado' : 'Pendiente';
                        const statusClass = status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-purple-100 text-purple-800';
                        
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 text-sm">${formatDate(record.date)}</td>
                                <td class="px-4 py-2 text-sm">${record.employee}</td>
                                <td class="px-4 py-2 text-sm">${record.concept}</td>
                                <td class="px-4 py-2 text-sm text-right">${formatCurrency(record.amount || 0)}</td>
                                <td class="px-4 py-2 text-sm text-right">${formatCurrency(record.paid || 0)}</td>
                                <td class="px-4 py-2 text-sm text-right">${formatCurrency(balance)}</td>
                                <td class="px-4 py-2 text-center">
                                    <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${statusText}</span>
                                </td>
                                <td class="px-4 py-2 text-center">
                                    ${balance > 0 ? `
                                        <button onclick="openPaymentModal('${record.id}', 'voucher')" class="text-blue-600 hover:text-blue-800 text-sm mr-2">
                                            Pagar
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteVoucher('${record.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
            } catch (error) {
                console.error('Error loading vouchers data:', error);
            }
        }

        async function deleteVoucher(id) {
            if (confirm('驴Est谩 seguro de eliminar este vale?')) {
                try {
                    await database.ref(`vouchers/${currentPeriod}/${id}`).remove();
                    loadVouchersData();
                    showSuccess('Vale eliminado exitosamente');
                } catch (error) {
                    console.error('Error deleting voucher:', error);
                    alert('Error al eliminar el vale');
                }
            }
        }

        // Payment Modal Management
        async function openPaymentModal(id, type) {
            currentPaymentId = id;
            currentPaymentType = type;
            
            let data, title, info;
            
            try {
                if (type === 'receivable') {
                    const snapshot = await database.ref(`accountsReceivable/${currentPeriod}/${id}`).once('value');
                    data = snapshot.val();
                    title = 'Registrar Cobro';
                    info = `
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="font-medium">Cliente:</span>
                                <span>${data.client}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Descripci贸n:</span>
                                <span>${data.description}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Monto Total:</span>
                                <span>${formatCurrency(data.amount)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Ya Cobrado:</span>
                                <span>${formatCurrency(data.paid || 0)}</span>
                            </div>
                            <div class="flex justify-between font-bold text-lg border-t pt-2">
                                <span>Saldo Pendiente:</span>
                                <span class="text-red-600">${formatCurrency((data.amount || 0) - (data.paid || 0))}</span>
                            </div>
                        </div>
                    `;
                } else if (type === 'payable') {
                    const snapshot = await database.ref(`accountsPayable/${currentPeriod}/${id}`).once('value');
                    data = snapshot.val();
                    title = 'Registrar Pago';
                    info = `
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="font-medium">Proveedor:</span>
                                <span>${data.supplier}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Descripci贸n:</span>
                                <span>${data.description}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Monto Total:</span>
                                <span>${formatCurrency(data.amount)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Ya Pagado:</span>
                                <span>${formatCurrency(data.paid || 0)}</span>
                            </div>
                            <div class="flex justify-between font-bold text-lg border-t pt-2">
                                <span>Saldo Pendiente:</span>
                                <span class="text-red-600">${formatCurrency((data.amount || 0) - (data.paid || 0))}</span>
                            </div>
                        </div>
                    `;
                } else if (type === 'voucher') {
                    const snapshot = await database.ref(`vouchers/${currentPeriod}/${id}`).once('value');
                    data = snapshot.val();
                    title = 'Pagar Vale';
                    info = `
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="font-medium">Empleado:</span>
                                <span>${data.employee}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Concepto:</span>
                                <span>${data.concept}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Monto Total:</span>
                                <span>${formatCurrency(data.amount)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Ya Pagado:</span>
                                <span>${formatCurrency(data.paid || 0)}</span>
                            </div>
                            <div class="flex justify-between font-bold text-lg border-t pt-2">
                                <span>Saldo Pendiente:</span>
                                <span class="text-red-600">${formatCurrency((data.amount || 0) - (data.paid || 0))}</span>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('paymentModalTitle').textContent = title;
                document.getElementById('paymentInfo').innerHTML = info;
                document.getElementById('totalPaymentAmount').textContent = formatCurrency((data.amount || 0) - (data.paid || 0));
                
                // Clear form
                document.getElementById('paymentCash').value = '';
                document.getElementById('paymentBank').value = '';
                
                // Show modal
                document.getElementById('paymentModal').classList.remove('hidden');
                document.getElementById('paymentModal').classList.add('flex');
                
            } catch (error) {
                console.error('Error loading payment data:', error);
                alert('Error al cargar los datos del pago');
            }
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('paymentModal').classList.remove('flex');
            currentPaymentId = null;
            currentPaymentType = null;
        }

        function initializePaymentModal() {
            // Close modal events
            document.getElementById('closePaymentModal').addEventListener('click', closePaymentModal);
            document.getElementById('cancelPayment').addEventListener('click', closePaymentModal);
            
            // Form submission
            document.getElementById('paymentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const cashAmount = parseFloat(document.getElementById('paymentCash').value) || 0;
                const bankAmount = parseFloat(document.getElementById('paymentBank').value) || 0;
                const totalPayment = cashAmount + bankAmount;
                
                if (totalPayment <= 0) {
                    alert('Debe ingresar un monto v谩lido');
                    return;
                }
                
                try {
                    // Get current data
                    let dataRef, cashRef;
                    if (currentPaymentType === 'receivable') {
                        dataRef = database.ref(`accountsReceivable/${currentPeriod}/${currentPaymentId}`);
                    } else if (currentPaymentType === 'payable') {
                        dataRef = database.ref(`accountsPayable/${currentPeriod}/${currentPaymentId}`);
                    } else if (currentPaymentType === 'voucher') {
                        dataRef = database.ref(`vouchers/${currentPeriod}/${currentPaymentId}`);
                    }
                    
                    const snapshot = await dataRef.once('value');
                    const currentData = snapshot.val();
                    const currentPaid = currentData.paid || 0;
                    const remainingBalance = (currentData.amount || 0) - currentPaid;
                    
                    if (totalPayment > remainingBalance) {
                        alert(`El monto excede el saldo pendiente de ${formatCurrency(remainingBalance)}`);
                        return;
                    }
                    
                    // Update the account
                    const newPaidAmount = currentPaid + totalPayment;
                    await dataRef.update({ paid: newPaidAmount });
                    
                    // Add to cash if there's a cash payment
                    if (cashAmount > 0 || bankAmount > 0) {
                        let description;
                        if (currentPaymentType === 'receivable') {
                            description = `Cobro: ${currentData.client} - ${currentData.description}`;
                        } else if (currentPaymentType === 'payable') {
                            description = `Pago: ${currentData.supplier} - ${currentData.description}`;
                        } else if (currentPaymentType === 'voucher') {
                            description = `Pago Vale: ${currentData.employee} - ${currentData.concept}`;
                        }
                        
                        const cashEntry = {
                            description,
                            cash: currentPaymentType === 'receivable' ? cashAmount : -cashAmount,
                            bank: currentPaymentType === 'receivable' ? bankAmount : -bankAmount,
                            date: new Date().toISOString(),
                            period: currentPeriod,
                            relatedId: currentPaymentId,
                            relatedType: currentPaymentType
                        };
                        
                        await database.ref(`cash/${currentPeriod}`).push(cashEntry);
                    }
                    
                    closePaymentModal();
                    
                    // Reload appropriate data
                    if (currentPaymentType === 'receivable') {
                        loadAccountsReceivableData();
                    } else if (currentPaymentType === 'payable') {
                        loadAccountsPayableData();
                    } else if (currentPaymentType === 'voucher') {
                        loadVouchersData();
                    }
                    
                    loadCashData();
                    showSuccess('Pago registrado exitosamente');
                    
                } catch (error) {
                    console.error('Error processing payment:', error);
                    alert('Error al procesar el pago');
                }
            });
        }

        // Summary Management
        async function loadSummaryData() {
            try {
                // Load all data for the current period
                const [cashSnapshot, receivableSnapshot, payableSnapshot, vouchersSnapshot] = await Promise.all([
                    database.ref(`cash/${currentPeriod}`).once('value'),
                    database.ref(`accountsReceivable/${currentPeriod}`).once('value'),
                    database.ref(`accountsPayable/${currentPeriod}`).once('value'),
                    database.ref(`vouchers/${currentPeriod}`).once('value')
                ]);
                
                const cashData = cashSnapshot.val() || {};
                const receivableData = receivableSnapshot.val() || {};
                const payableData = payableSnapshot.val() || {};
                const vouchersData = vouchersSnapshot.val() || {};
                
                // Calculate totals
                let totalCash = 0;
                let totalBank = 0;
                Object.values(cashData).forEach(entry => {
                    totalCash += entry.cash || 0;
                    totalBank += entry.bank || 0;
                });
                
                let totalReceivable = 0;
                let totalCollected = 0;
                Object.values(receivableData).forEach(account => {
                    totalReceivable += account.amount || 0;
                    totalCollected += account.paid || 0;
                });
                
                let totalPayable = 0;
                let totalPaid = 0;
                Object.values(payableData).forEach(account => {
                    totalPayable += account.amount || 0;
                    totalPaid += account.paid || 0;
                });
                
                let totalVouchers = 0;
                let totalVouchersPaid = 0;
                Object.values(vouchersData).forEach(voucher => {
                    totalVouchers += voucher.amount || 0;
                    totalVouchersPaid += voucher.paid || 0;
                });
                
                // Update summary cards
                document.getElementById('summaryCash').textContent = formatCurrency(totalCash);
                document.getElementById('summaryBank').textContent = formatCurrency(totalBank);
                document.getElementById('summaryReceivables').textContent = formatCurrency(totalReceivable - totalCollected);
                document.getElementById('summaryPayables').textContent = formatCurrency(totalPayable - totalPaid);
                
                // Update detailed summary
                document.getElementById('detailCash').textContent = formatCurrency(totalCash);
                document.getElementById('detailBank').textContent = formatCurrency(totalBank);
                document.getElementById('detailCollected').textContent = formatCurrency(totalCollected);
                document.getElementById('detailPaid').textContent = formatCurrency(totalPaid);
                document.getElementById('detailVouchersPaid').textContent = formatCurrency(totalVouchersPaid);
                
                const totalIncome = totalCash + totalBank + totalCollected;
                const totalExpenses = totalPaid + totalVouchersPaid;
                const netBalance = totalIncome - totalExpenses;
                
                document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
                document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
                document.getElementById('netBalance').textContent = formatCurrency(netBalance);
                document.getElementById('netBalance').className = `text-2xl font-bold ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'}`;
                
            } catch (error) {
                console.error('Error loading summary data:', error);
            }
        }

        // Month Closure Management
        function initializeMonthClosure() {
            document.getElementById('monthClosureBtn').addEventListener('click', openMonthClosureModal);
            document.getElementById('closeMonthModal').addEventListener('click', closeMonthClosureModal);
        }

        async function openMonthClosureModal() {
            try {
                // Load current month data
                const [cashSnapshot, receivableSnapshot, payableSnapshot, vouchersSnapshot] = await Promise.all([
                    database.ref(`cash/${currentPeriod}`).once('value'),
                    database.ref(`accountsReceivable/${currentPeriod}`).once('value'),
                    database.ref(`accountsPayable/${currentPeriod}`).once('value'),
                    database.ref(`vouchers/${currentPeriod}`).once('value')
                ]);
                
                const cashData = cashSnapshot.val() || {};
                const receivableData = receivableSnapshot.val() || {};
                const payableData = payableSnapshot.val() || {};
                const vouchersData = vouchersSnapshot.val() || {};
                
                // Calculate totals
                let totalCash = 0;
                let totalBank = 0;
                Object.values(cashData).forEach(entry => {
                    totalCash += entry.cash || 0;
                    totalBank += entry.bank || 0;
                });
                
                // Count pending accounts
                const pendingReceivable = Object.values(receivableData).filter(account => 
                    (account.amount || 0) > (account.paid || 0)
                );
                const pendingPayable = Object.values(payableData).filter(account => 
                    (account.amount || 0) > (account.paid || 0)
                );
                const pendingVouchers = Object.values(vouchersData).filter(voucher => 
                    (voucher.amount || 0) > (voucher.paid || 0)
                );
                
                const content = `
                    <div class="space-y-6">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-medium text-yellow-800">隆Atenci贸n! Esta acci贸n no se puede deshacer</span>
                            </div>
                            <p class="text-yellow-700 text-sm mt-2">
                                El cierre de mes transferir谩 las cuentas pendientes al pr贸ximo per铆odo y resetear谩 los saldos de efectivo.
                            </p>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-blue-800 mb-2">Resumen del Mes</h3>
                                <div class="space-y-2 text-xs sm:text-sm">
                                    <div class="flex justify-between">
                                        <span>Efectivo:</span>
                                        <span class="font-medium">${formatCurrency(totalCash)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Transferencias:</span>
                                        <span class="font-medium">${formatCurrency(totalBank)}</span>
                                    </div>
                                    <div class="flex justify-between font-semibold border-t pt-2">
                                        <span>Total:</span>
                                        <span>${formatCurrency(totalCash + totalBank)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-green-800 mb-2">Pendientes a Transferir</h3>
                                <div class="space-y-2 text-xs sm:text-sm">
                                    <div class="flex justify-between">
                                        <span>Cuentas por Cobrar:</span>
                                        <span class="font-medium">${pendingReceivable.length}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Cuentas por Pagar:</span>
                                        <span class="font-medium">${pendingPayable.length}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Vales:</span>
                                        <span class="font-medium">${pendingVouchers.length}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button
                                onclick="processMonthClosure()"
                                class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm sm:text-base"
                            >
                                Cerrar Mes Actual
                            </button>
                            
                            <button
                                onclick="closeMonthClosureModal()"
                                class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm sm:text-base"
                            >
                                Cancelar
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('monthClosureContent').innerHTML = content;
                document.getElementById('monthClosureModal').classList.remove('hidden');
                document.getElementById('monthClosureModal').classList.add('flex');
                
            } catch (error) {
                console.error('Error loading month closure data:', error);
                alert('Error al cargar los datos del cierre');
            }
        }

        function closeMonthClosureModal() {
            document.getElementById('monthClosureModal').classList.add('hidden');
            document.getElementById('monthClosureModal').classList.remove('flex');
        }

        async function processMonthClosure() {
            if (!confirm('驴Est谩 completamente seguro de cerrar el mes actual? Esta acci贸n no se puede deshacer.')) {
                return;
            }
            
            try {
                // Calculate next period
                const [year, month] = currentPeriod.split('-').map(Number);
                const nextMonth = month === 12 ? 1 : month + 1;
                const nextYear = month === 12 ? year + 1 : year;
                const nextPeriod = `${nextYear}-${String(nextMonth).padStart(2, '0')}`;
                
                // Transfer pending accounts to next period
                await transferPendingAccounts(currentPeriod, nextPeriod);
                
                // Calculate and reset cash totals
                await resetCashForNewPeriod(currentPeriod, nextPeriod);
                
                // Update current period and reload data
                currentPeriod = nextPeriod;
                populatePeriodSelect();
                document.getElementById('periodSelect').value = currentPeriod;
                
                closeMonthClosureModal();
                loadTabData('cash'); // Reload current tab
                showSuccess(`Mes cerrado exitosamente. Ahora trabajando en ${nextPeriod}`);
                
            } catch (error) {
                console.error('Error processing month closure:', error);
                alert('Error al procesar el cierre de mes');
            }
        }

        async function transferPendingAccounts(fromPeriod, toPeriod) {
            try {
                // Get existing accounts in the new period to avoid duplicates
                const [existingReceivableSnapshot, existingPayableSnapshot, existingVouchersSnapshot] = await Promise.all([
                    database.ref(`accountsReceivable/${toPeriod}`).once('value'),
                    database.ref(`accountsPayable/${toPeriod}`).once('value'),
                    database.ref(`vouchers/${toPeriod}`).once('value')
                ]);
                
                const existingReceivable = existingReceivableSnapshot.val() || {};
                const existingPayable = existingPayableSnapshot.val() || {};
                const existingVouchers = existingVouchersSnapshot.val() || {};
                
                // Transfer Accounts Receivable
                const receivableSnapshot = await database.ref(`accountsReceivable/${fromPeriod}`).once('value');
                const receivableData = receivableSnapshot.val() || {};
                
                for (const [key, account] of Object.entries(receivableData)) {
                    const balance = (account.amount || 0) - (account.paid || 0);
                    if (balance > 0) {
                        // Check if already exists
                        const alreadyExists = Object.values(existingReceivable).some(existing => 
                            existing.transferredFrom === key || 
                            (existing.client === account.client && existing.description === account.description)
                        );
                        
                        if (!alreadyExists) {
                            const transferredAccount = {
                                ...account,
                                amount: balance,
                                paid: 0,
                                period: toPeriod,
                                transferredFrom: key,
                                originalPeriod: fromPeriod,
                                transferDate: new Date().toISOString()
                            };
                            await database.ref(`accountsReceivable/${toPeriod}`).push(transferredAccount);
                        }
                    }
                }
                
                // Transfer Accounts Payable
                const payableSnapshot = await database.ref(`accountsPayable/${fromPeriod}`).once('value');
                const payableData = payableSnapshot.val() || {};
                
                for (const [key, account] of Object.entries(payableData)) {
                    const balance = (account.amount || 0) - (account.paid || 0);
                    if (balance > 0) {
                        // Check if already exists
                        const alreadyExists = Object.values(existingPayable).some(existing => 
                            existing.transferredFrom === key || 
                            (existing.supplier === account.supplier && existing.description === account.description)
                        );
                        
                        if (!alreadyExists) {
                            const transferredAccount = {
                                ...account,
                                amount: balance,
                                paid: 0,
                                period: toPeriod,
                                transferredFrom: key,
                                originalPeriod: fromPeriod,
                                transferDate: new Date().toISOString()
                            };
                            await database.ref(`accountsPayable/${toPeriod}`).push(transferredAccount);
                        }
                    }
                }
                
                // Transfer Vouchers
                const vouchersSnapshot = await database.ref(`vouchers/${fromPeriod}`).once('value');
                const vouchersData = vouchersSnapshot.val() || {};
                
                for (const [key, voucher] of Object.entries(vouchersData)) {
                    const balance = (voucher.amount || 0) - (voucher.paid || 0);
                    if (balance > 0) {
                        // Check if already exists
                        const alreadyExists = Object.values(existingVouchers).some(existing => 
                            existing.transferredFrom === key || 
                            (existing.employee === voucher.employee && existing.concept === voucher.concept)
                        );
                        
                        if (!alreadyExists) {
                            const transferredVoucher = {
                                ...voucher,
                                amount: balance,
                                paid: 0,
                                period: toPeriod,
                                transferredFrom: key,
                                originalPeriod: fromPeriod,
                                transferDate: new Date().toISOString()
                            };
                            await database.ref(`vouchers/${toPeriod}`).push(transferredVoucher);
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error transferring pending accounts:', error);
                throw error;
            }
        }

        async function resetCashForNewPeriod(fromPeriod, toPeriod) {
            try {
                // Get all cash entries from the period
                const cashSnapshot = await database.ref(`cash/${fromPeriod}`).once('value');
                const cashData = cashSnapshot.val() || {};
                
                // Get all accounts data to calculate total cash from payments/collections
                const [receivableSnapshot, payableSnapshot, vouchersSnapshot] = await Promise.all([
                    database.ref(`accountsReceivable/${fromPeriod}`).once('value'),
                    database.ref(`accountsPayable/${fromPeriod}`).once('value'),
                    database.ref(`vouchers/${fromPeriod}`).once('value')
                ]);
                
                const receivableData = receivableSnapshot.val() || {};
                const payableData = payableSnapshot.val() || {};
                const vouchersData = vouchersSnapshot.val() || {};
                
                // Resetear efectivo y banco para el nuevo per铆odo
                const currentPeriodRef = database.ref(`periods/${currentPeriod}`);
                const currentPeriodSnapshot = await currentPeriodRef.once('value');
                const currentPeriodData = currentPeriodSnapshot.val() || {};
                
                // Calcular TODOS los totales del per铆odo actual (incluyendo abonos de cuentas transferidas)
                let totalCash = currentPeriodData.cash || 0;
                let totalBank = currentPeriodData.bank || 0;
                
                // Sumar abonos de cuentas por cobrar
                if (currentPeriodData.accountsReceivable) {
                  Object.values(currentPeriodData.accountsReceivable).forEach(account => {
                    if (account.payments) {
                      Object.values(account.payments).forEach(payment => {
                        if (payment.method === 'cash') totalCash += payment.amount;
                        if (payment.method === 'transfer') totalBank += payment.amount;
                      });
                    }
                  });
                }
                
                // Sumar pagos de vales
                if (currentPeriodData.vouchers) {
                  Object.values(currentPeriodData.vouchers).forEach(voucher => {
                    if (voucher.payments) {
                      Object.values(voucher.payments).forEach(payment => {
                        if (payment.method === 'cash') totalCash += payment.amount;
                        if (payment.method === 'transfer') totalBank += payment.amount;
                      });
                    }
                  });
                }
                
                // Restar pagos de cuentas por pagar
                if (currentPeriodData.accountsPayable) {
                  Object.values(currentPeriodData.accountsPayable).forEach(account => {
                    if (account.payments) {
                      Object.values(account.payments).forEach(payment => {
                        if (payment.method === 'cash') totalCash -= payment.amount;
                        if (payment.method === 'transfer') totalBank -= payment.amount;
                      });
                    }
                  });
                }
                
                // Resetear efectivo y banco en el nuevo per铆odo
                await database.ref(`periods/${newPeriod}/cash`).set(0);
                await database.ref(`periods/${newPeriod}/bank`).set(0);
                
                console.log(`Resetting cash - Total Cash: ${totalCash}, Total Bank: ${totalBank}`);
                
                // The cash totals are already calculated correctly from the cash entries
                // which include all transactions (sales, collections, payments)
                // So we don't need to do anything else - the new period starts with 0
                
            } catch (error) {
                console.error('Error resetting cash for new period:', error);
                throw error;
            }
        }

        // Period Change Handler
        function initializePeriodSelect() {
            document.getElementById('periodSelect').addEventListener('change', (e) => {
                currentPeriod = e.target.value;
                loadTabData('cash'); // Reload current tab data
            });
        }

        // Initialize Application
        function initializeApp() {
            populatePeriodSelect();
            initializeTabs();
            initializeCashForm();
            initializeAccountsReceivableForm();
            initializeAccountsPayableForm();
            initializeVouchersForm();
            initializePaymentModal();
            initializeMonthClosure();
            initializePeriodSelect();
            
            // Load initial data
            loadCashData();
        }

        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
