<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Financiero - Licorera (En la Nube)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Estilos CSS de la aplicación */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-button.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .modal { transition: opacity 0.3s ease; }
        .action-button { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 9999px; }
        .action-button:hover { background-color: #f0f0f0; }
        #login-overlay { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; } .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <div class="text-center mb-6">
                <i class="fas fa-shield-alt text-4xl text-indigo-600"></i>
                <h2 class="text-2xl font-bold text-gray-800 mt-4">Acceso Seguro</h2>
                <p class="text-gray-500 text-sm">Por favor, ingrese la contraseña.</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="password" class="sr-only">Contraseña</label>
                    <input type="password" id="password" placeholder="Contraseña" class="w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                 <p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden">Contraseña incorrecta. Intente de nuevo.</p>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Ingresar</button>
            </form>
        </div>
    </div>
    
    <div id="app-container" class="hidden">
        <div class="max-w-7xl mx-auto">
            <header class="relative text-center mb-4 no-print">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">📊 Gestión Financiera Total</h1>
                <p class="text-gray-600 mt-2">Control de Flujo de Dinero, Compras, Gastos y Deudas.</p>
                <button id="settings-btn" class="absolute top-0 right-0 action-button text-gray-500 hover:text-indigo-600 text-2xl" title="Configuración">
                    <i class="fas fa-cog"></i>
                </button>
            </header>

            <div class="border-b border-gray-200 mb-6 no-print">
                <nav id="tabs-nav" class="-mb-px flex flex-wrap space-x-6" aria-label="Tabs">
                    <button data-tab="resumen" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-chart-pie mr-2"></i>Resumen</button>
                    <button data-tab="ingresos" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-dollar-sign mr-2"></i>Ingreso</button>
                    <button data-tab="compras" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-shopping-cart mr-2"></i>Compras</button>
                    <button data-tab="gastos" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-receipt mr-2"></i>Gasto Op.</button>
                    <button data-tab="retiros" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-hand-holding-dollar mr-2"></i>Retiro Jefe</button>
                    <button data-tab="deudas" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-book mr-2"></i>Deudas</button>
                    <button data-tab="registros" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-list-ul mr-2"></i>Ver Registros</button>
                </nav>
            </div>

            <main>
                <div id="resumen" class="tab-content">
                         <div id="print-area">
                             <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                                 <h2 class="text-2xl font-semibold text-gray-700">Resumen Financiero</h2>
                                 <div class="flex items-center space-x-2 no-print">
                                     <label for="month-filter" class="text-sm font-medium text-gray-700">Filtrar por Mes:</label>
                                     <input type="month" id="month-filter" class="p-2 border border-gray-300 rounded-md">
                                 </div>
                             </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                 <div class="card p-5"><h3 class="text-gray-500 text-sm font-medium">Ingresos Totales (Mes)</h3><p id="total-ingresos" class="text-2xl font-semibold text-green-600 mt-1">$0</p></div>
                                 <div class="card p-5"><h3 class="text-gray-500 text-sm font-medium">Compras Totales (Mes)</h3><p id="total-compras" class="text-2xl font-semibold text-purple-600 mt-1">$0</p></div>
                                 <div class="card p-5"><h3 class="text-gray-500 text-sm font-medium">Gastos Op. Totales (Mes)</h3><p id="total-gastos-op" class="text-2xl font-semibold text-red-600 mt-1">$0</p></div>
                                 <div class="card p-5 bg-blue-50 border-blue-200 border"><h3 class="text-blue-800 text-sm font-medium">Efectivo en Caja (Actual)</h3><p id="efectivo-caja" class="text-2xl font-semibold text-blue-700 mt-1">$0</p></div>
                                 <div class="card p-5 bg-green-50 border-green-200 border"><h3 class="text-green-800 text-sm font-medium">Saldo en Banco (Actual)</h3><p id="saldo-banco" class="text-2xl font-semibold text-green-700 mt-1">$0</p></div>
                                 <div class="card p-5 bg-yellow-50 border-yellow-200 border"><h3 class="text-yellow-800 text-sm font-medium">Cuentas por Cobrar</h3><p id="cuentas-cobrar-total" class="text-2xl font-semibold text-yellow-700 mt-1">$0</p></div>
                                 <div class="card p-5 bg-red-50 border-red-200 border"><h3 class="text-red-800 text-sm font-medium">Cuentas por Pagar</h3><p id="cuentas-pagar-total" class="text-2xl font-semibold text-red-700 mt-1">$0</p></div>
                                 <div class="card p-5"><h3 class="text-gray-500 text-sm font-medium">Retiros del Jefe (Mes)</h3><p id="total-retiros" class="text-2xl font-semibold text-orange-500 mt-1">$0</p></div>
                                 </div>
                             <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                                 <div class="lg:col-span-2 card p-6"><h3 class="text-lg font-semibold text-gray-700 mb-4">Distribución de Gastos Operativos</h3><canvas id="gastos-chart"></canvas></div>
                                 <div class="lg:col-span-3 card p-6"><h3 class="text-lg font-semibold text-gray-700 mb-4">Últimos Movimientos</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Fecha</th><th class="px-6 py-3">Descripción</th><th class="px-6 py-3">Monto</th></tr></thead><tbody id="ultimos-movimientos-body"></tbody></table></div></div>
                             </div>
                         </div>
                </div>
                <div id="ingresos" class="tab-content hidden"><div class="max-w-xl mx-auto card p-8"><h2 class="text-2xl font-semibold">Registrar Venta</h2><form id="form-ingresos" class="space-y-6"><div><label for="ingreso-fecha" class="block text-sm font-medium">Fecha</label><input type="date" id="ingreso-fecha" class="mt-1 block w-full rounded-md" required></div><div><label for="ingreso-efectivo" class="block text-sm font-medium">Ventas en Efectivo</label><input type="text" data-moneda inputmode="numeric" id="ingreso-efectivo" value="0" class="mt-1 block w-full" required></div><div><label for="ingreso-tarjeta" class="block text-sm font-medium">Ventas Tarjeta/Transf.</label><input type="text" data-moneda inputmode="numeric" id="ingreso-tarjeta" value="0" class="mt-1 block w-full" required></div><div><label for="ingreso-notas" class="block text-sm font-medium">Notas</label><textarea id="ingreso-notas" rows="3" class="mt-1 block w-full"></textarea></div><button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold">Añadir Ingreso</button></form></div></div>
                <div id="compras" class="tab-content hidden"><div class="max-w-xl mx-auto card p-8"><h2 class="text-2xl font-semibold">Registrar Compra</h2><form id="form-compras" class="space-y-6"><div><label for="compra-fecha" class="block text-sm font-medium">Fecha</label><input type="date" id="compra-fecha" class="mt-1 block w-full" required></div><div><label for="compra-proveedor" class="block text-sm font-medium">Proveedor</label><input type="text" id="compra-proveedor" class="mt-1 block w-full" required></div><div><label for="compra-descripcion" class="block text-sm font-medium">Descripción</label><input type="text" id="compra-descripcion" class="mt-1 block w-full" required></div><div><label for="compra-monto" class="block text-sm font-medium">Monto</label><input type="text" data-moneda inputmode="numeric" id="compra-monto" class="mt-1 block w-full" required></div><div><label for="compra-metodo" class="block text-sm font-medium">Pagado con</label><select id="compra-metodo" class="mt-1 block w-full" required><option value="Efectivo">Efectivo</option><option value="Banco">Banco</option></select></div><button type="submit" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold">Añadir Compra</button></form></div></div>
                <div id="gastos" class="tab-content hidden"><div class="max-w-xl mx-auto card p-8"><h2 class="text-2xl font-semibold">Registrar Gasto Op. (del Efectivo)</h2><form id="form-gastos" class="space-y-6"><div><label for="gasto-fecha" class="block text-sm font-medium">Fecha</label><input type="date" id="gasto-fecha" class="mt-1 block w-full" required></div><div><label for="gasto-descripcion" class="block text-sm font-medium">Descripción</label><input type="text" id="gasto-descripcion" class="mt-1 block w-full" required></div><div><label for="gasto-categoria" class="block text-sm font-medium">Categoría</label><select id="gasto-categoria" class="mt-1 block w-full" required><option>Arriendo</option><option>Servicios</option><option>Nómina</option><option>Marketing</option><option>Mantenimiento</option><option>Impuestos</option><option>Insumos</option><option>Otro</option></select></div><div><label for="gasto-monto" class="block text-sm font-medium">Monto</label><input type="text" data-moneda inputmode="numeric" id="gasto-monto" class="mt-1 block w-full" required></div><button type="submit" class="w-full bg-red-600 text-white py-3 px-4 rounded-lg font-semibold">Añadir Gasto</button></form></div></div>
                <div id="retiros" class="tab-content hidden"><div class="max-w-xl mx-auto card p-8"><h2 class="text-2xl font-semibold">Registrar Retiro Jefe</h2><form id="form-retiros" class="space-y-6"><div><label for="retiro-fecha" class="block text-sm font-medium">Fecha</label><input type="date" id="retiro-fecha" class="mt-1 block w-full" required></div><div><label for="retiro-metodo" class="block text-sm font-medium">Retirar de</label><select id="retiro-metodo" class="mt-1 block w-full" required><option value="Efectivo">Efectivo (Caja)</option><option value="Banco">Banco (Transferencia)</option></select></div><div><label for="retiro-descripcion" class="block text-sm font-medium">Descripción</label><input type="text" id="retiro-descripcion" class="mt-1 block w-full" required></div><div><label for="retiro-monto" class="block text-sm font-medium">Monto</label><input type="text" data-moneda inputmode="numeric" id="retiro-monto" class="mt-1 block w-full" required></div><button type="submit" class="w-full bg-orange-500 text-white py-3 px-4 rounded-lg font-semibold">Añadir Retiro</button></form></div></div>
                <div id="deudas" class="tab-content hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6"><h2 class="text-2xl font-semibold">Cuentas por Cobrar (Fiado)</h2><div class="card p-6"><form id="form-cuentas-cobrar" class="space-y-4"><div><label for="cpc-cliente" class="block text-sm font-medium">Nombre Cliente</label><input type="text" id="cpc-cliente" class="mt-1 block w-full" required></div><div><label for="cpc-descripcion" class="block text-sm font-medium">Descripción</label><input type="text" id="cpc-descripcion" class="mt-1 block w-full" required></div><div><label for="cpc-monto" class="block text-sm font-medium">Monto</label><input type="text" data-moneda inputmode="numeric" id="cpc-monto" class="mt-1 block w-full" required></div><button type="submit" class="w-full bg-yellow-500 text-white py-2 rounded-lg font-semibold">Añadir Deuda</button></form></div><div class="card p-4 overflow-x-auto"><table class="w-full text-sm" id="tabla-cuentas-cobrar"></table></div></div>
                    <div class="space-y-6"><h2 class="text-2xl font-semibold">Cuentas por Pagar</h2><div class="card p-6"><form id="form-cuentas-pagar" class="space-y-4"><div><label for="cpp-acreedor" class="block text-sm font-medium">Proveedor/Acreedor</label><input type="text" id="cpp-acreedor" class="mt-1 block w-full" required></div><div><label for="cpp-descripcion" class="block text-sm font-medium">Concepto</label><input type="text" id="cpp-descripcion" class="mt-1 block w-full" required></div><div><label for="cpp-monto" class="block text-sm font-medium">Monto</label><input type="text" data-moneda inputmode="numeric" id="cpp-monto" class="mt-1 block w-full" required></div><button type="submit" class="w-full bg-red-500 text-white py-2 rounded-lg font-semibold">Añadir Cuenta por Pagar</button></form></div><div class="card p-4 overflow-x-auto"><table class="w-full text-sm" id="tabla-cuentas-pagar"></table></div></div>
                </div>
                <div id="registros" class="tab-content hidden space-y-8">
                    <div><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">Todos los Ingresos</h2><button data-type="ingresos" class="btn-pdf bg-gray-700 text-white px-4 py-2 rounded-lg text-sm"><i class="fas fa-file-pdf mr-2"></i>PDF</button></div><div class="card p-4 overflow-x-auto"><table class="w-full text-sm" id="tabla-ingresos"></table></div></div>
                    <div><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">Todas las Compras</h2><button data-type="compras" class="btn-pdf bg-gray-700 text-white px-4 py-2 rounded-lg text-sm"><i class="fas fa-file-pdf mr-2"></i>PDF</button></div><div class="card p-4 overflow-x-auto"><table class="w-full text-sm" id="tabla-compras"></table></div></div>
                    <div><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">Todos los Gastos Op.</h2><button data-type="gastos" class="btn-pdf bg-gray-700 text-white px-4 py-2 rounded-lg text-sm"><i class="fas fa-file-pdf mr-2"></i>PDF</button></div><div class="card p-4 overflow-x-auto"><table class="w-full text-sm" id="tabla-gastos"></table></div></div>
                    <div><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">Todos los Retiros</h2><button data-type="retiros" class="btn-pdf bg-gray-700 text-white px-4 py-2 rounded-lg text-sm"><i class="fas fa-file-pdf mr-2"></i>PDF</button></div><div class="card p-4 overflow-x-auto"><table class="w-full text-sm" id="tabla-retiros"></table></div></div>

                    <div class="pt-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold">Reportes de Deudas</h2>
                        </div>
                        <div class="card p-6 space-y-4">
                            <div class="flex justify-between items-center border-b pb-4">
                                <div>
                                    <p class="font-medium text-gray-800">Resumen de Cuentas por Cobrar</p>
                                    <p class="text-sm text-gray-500">Genera un PDF con el detalle de lo que te deben los clientes.</p>
                                </div>
                                <button data-type="deudas-cobrar" class="btn-pdf bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm flex-shrink-0"><i class="fas fa-download mr-2"></i>Descargar PDF</button>
                            </div>
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-medium text-gray-800">Resumen de Cuentas por Pagar</p>
                                    <p class="text-sm text-gray-500">Genera un PDF con el detalle de tus deudas a proveedores.</p>
                                </div>
                                <button data-type="deudas-pagar" class="btn-pdf bg-red-500 text-white px-4 py-2 rounded-lg text-sm flex-shrink-0"><i class="fas fa-download mr-2"></i>Descargar PDF</button>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>
    
    <div id="abono-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center p-4"><div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-md bg-white"><h3 class="text-2xl font-semibold mb-6">Registrar Abono</h3><form id="form-abono" class="space-y-4"><input type="hidden" id="abono-deuda-id"><div><label class="block text-sm font-medium">Monto a Abonar</label><input type="text" data-moneda inputmode="numeric" id="abono-monto" class="mt-1 block w-full" required></div><div><label class="block text-sm font-medium">Recibido en</label><select id="abono-metodo" class="mt-1 block w-full" required><option value="Efectivo">Efectivo</option><option value="Banco">Banco</option></select></div></form><div class="flex justify-end items-center mt-6 space-x-4"><button id="cancel-abono-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button id="save-abono-btn" class="px-4 py-2 bg-green-600 text-white rounded-md">Registrar Abono</button></div></div></div>
    <div id="notification-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center"><div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div id="notification-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full"></div><h3 id="notification-title" class="text-lg leading-6 font-medium text-gray-900"></h3><div class="mt-2 px-7 py-3"><p id="notification-message" class="text-sm text-gray-500"></p></div><div class="items-center px-4 py-3"><button id="notification-close" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full">Cerrar</button></div></div></div></div>
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center"><div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i></div><h3 id="confirm-title" class="text-lg leading-6 font-medium text-gray-900 mt-4"></h3><div id="confirm-message-container" class="mt-2 px-7 py-3"><p id="confirm-message" class="text-sm text-gray-500"></p></div><div class="flex justify-center items-center px-4 py-3 space-x-4"><button id="cancel-confirm-btn" class="px-4 py-2 bg-gray-200 rounded-md w-full">Cancelar</button><button id="confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md w-full">Confirmar</button></div></div></div></div>
    <div id="edit-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center overflow-y-auto p-4"><div class="relative mx-auto p-8 border w-full max-w-xl shadow-lg rounded-md bg-white"><h3 id="edit-modal-title" class="text-2xl font-semibold mb-6"></h3><form id="edit-form" class="space-y-4"></form><div class="flex justify-end items-center mt-6 space-x-4"><button id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button><button id="save-edit-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Guardar Cambios</button></div></div></div>

    <div id="password-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center p-4">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 class="text-2xl font-semibold mb-6 text-gray-800">Establecer Nueva Contraseña</h3>
            <form id="form-password" class="space-y-4">
                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                    <div class="relative mt-1">
                        <input type="password" id="new-password" class="block w-full rounded-md border-gray-300 shadow-sm pr-10" required>
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer toggle-password">
                            <i class="fas fa-eye text-gray-400"></i>
                        </span>
                    </div>
                </div>
                <div>
                    <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contraseña</label>
                    <div class="relative mt-1">
                        <input type="password" id="confirm-password" class="block w-full rounded-md border-gray-300 shadow-sm pr-10" required>
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer toggle-password">
                             <i class="fas fa-eye text-gray-400"></i>
                        </span>
                    </div>
                </div>
                <p id="password-error" class="text-red-500 text-sm hidden"></p>
            </form>
            <div class="flex justify-end items-center mt-6 space-x-4">
                <button id="cancel-password-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="save-password-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <div id="historial-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 items-center justify-center p-4">
        <div class="relative mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-2xl font-semibold mb-2" id="historial-modal-title">Historial de Abonos</h3>
                    <p class="text-gray-600" id="historial-modal-subtitle"></p>
                </div>
                <button id="cancel-historial-btn" class="p-2 -mt-4 -mr-4"><i class="fas fa-times text-gray-500"></i></button>
            </div>
            <div class="mt-6 overflow-y-auto max-h-96">
                <table class="w-full text-sm">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-4 py-3">Fecha</th>
                            <th class="px-4 py-3">Hora</th>
                            <th class="px-4 py-3">Monto Abonado</th>
                            <th class="px-4 py-3">Recibido en</th>
                        </tr>
                    </thead>
                    <tbody id="historial-abonos-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // =========================================================================
        // CONFIGURACIÓN DE FIREBASE
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCm5BGh7cWX4A5fXx8zCN33ztuLvseRhAU",
            authDomain: "control-licorera.firebaseapp.com",
            databaseURL: "https://control-licorera-default-rtdb.firebaseio.com",
            projectId: "control-licorera",
            storageBucket: "control-licorera.appspot.com",
            messagingSenderId: "430925820415",
            appId: "1:430925820415:web:e1c06bc73b6863a5c3f7ca",
            measurementId: "G-86ZY48XKV4"
        };
        // =========================================================================

        // --- INICIALIZACIÓN DE FIREBASE ---
        let database;
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();

        // --- REFERENCIAS A LA BASE DE DATOS ---
        const dataRefs = {
            ingresos: database.ref('ingresos'),
            compras: database.ref('compras'),
            gastos: database.ref('gastos'),
            retiros: database.ref('retiros'),
            cuentasPorCobrar: database.ref('cuentasPorCobrar'),
            cuentasPorPagar: database.ref('cuentasPorPagar'),
            password: database.ref('config/password') 
        };
        
        // --- ESTADO GLOBAL Y CONFIGURACIÓN ---
        const { jsPDF } = window.jspdf;
        let gastosChart = null;
        let allData = { ingresos: [], compras: [], gastos: [], retiros: [], cuentasPorCobrar: [], cuentasPorPagar: [] };
        let confirmCallback = null;

        // --- MANEJO DE DATOS (CON FIREBASE) ---
        const firebaseObjectToArray = (snapshot) => {
            const data = [];
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const item = childSnapshot.val();
                    item.fecha = new Date(item.fecha); 
                    if(item.abonos) {
                       item.abonos = Object.values(item.abonos).map(abono => ({...abono, fecha: new Date(abono.fecha)}));
                    }
                    data.push({ id: childSnapshot.key, ...item });
                });
            }
            return data;
        };
        
        // --- MANEJO DE UI Y RENDERIZADO ---
        const changeTab = (tabName) => {
            setFormDatesToToday();
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[data-tab="${tabName}"]`).classList.add('active');

            if (tabName === 'registros') {
                renderAllTables();
            }
            if (tabName === 'deudas') {
                renderCuentasPorCobrar();
                renderCuentasPorPagar();
            }
        };
        const formatCurrency = (value) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value || 0);
        const formatDateForInput = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const formatInputAsCurrency = (e) => {
            let input = e.target;
            let value = input.value.replace(/\D/g, ''); 
            if (value) {
                const number = parseInt(value, 10);
                input.value = number.toLocaleString('es-CO');
            } else {
                input.value = '';
            }
        };
        const getNumericValue = (formattedValue) => {
            if (!formattedValue) return 0;
            return parseFloat(formattedValue.replace(/\./g, '')); 
        };
        const addCurrencyFormatting = (container) => {
            container.querySelectorAll('[data-moneda]').forEach(input => {
                input.addEventListener('input', formatInputAsCurrency);
            });
        };
        
        const refreshUI = () => { 
            filterAndRenderDashboard(); 
            const activeTabName = document.querySelector('.tab-button.active')?.dataset.tab;
            if (activeTabName === 'registros') {
                renderAllTables();
            }
            if (activeTabName === 'deudas') {
                renderCuentasPorCobrar();
                renderCuentasPorPagar();
            }
        };
        
        const filterAndRenderDashboard = () => {
             let filterValue = document.getElementById('month-filter').value;
             if (!filterValue) {
                const now = new Date();
                filterValue = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                document.getElementById('month-filter').value = filterValue;
             }
             
             const [year, month] = filterValue.split('-').map(Number);
             const filteredData = {};
             ['ingresos', 'compras', 'gastos', 'retiros'].forEach(key => {
                 if (allData[key]) {
                    filteredData[key] = allData[key].filter(d => d.fecha.getFullYear() === year && (d.fecha.getMonth() + 1) === month);
                 } else {
                    filteredData[key] = [];
                 }
             });
             updateDashboard(filteredData.ingresos, filteredData.compras, filteredData.gastos, filteredData.retiros, allData.cuentasPorCobrar, allData.cuentasPorPagar);
        };

        const updateDashboard = (ingresos, compras, gastos, retiros, cpc, cpp) => {
            const totalIngresosMes = ingresos.reduce((sum, item) => sum + item.monto, 0);
            const totalComprasMes = compras.reduce((sum, item) => sum + item.monto, 0);
            const totalGastosOpMes = gastos.reduce((sum, item) => sum + item.monto, 0);
            const totalRetirosMes = retiros.reduce((sum, item) => sum + item.monto, 0);
            
            const totalIngresosEfectivo = (allData.ingresos || []).reduce((sum, i) => sum + i.monto_efectivo, 0);
            const totalIngresosBanco = (allData.ingresos || []).reduce((sum, i) => sum + i.monto_tarjeta, 0);
            const abonosEfectivo = (allData.cuentasPorCobrar || []).flatMap(d => d.abonos || []).filter(a => a.metodo === 'Efectivo').reduce((sum, a) => sum + a.monto, 0);
            const abonosBanco = (allData.cuentasPorCobrar || []).flatMap(d => d.abonos || []).filter(a => a.metodo === 'Banco').reduce((sum, a) => sum + a.monto, 0);
            const totalComprasEfectivo = (allData.compras || []).filter(c => c.metodo === 'Efectivo').reduce((sum, c) => sum + c.monto, 0);
            const totalComprasBanco = (allData.compras || []).filter(c => c.metodo === 'Banco').reduce((sum, c) => sum + c.monto, 0);
            const totalGastosOp = (allData.gastos || []).reduce((sum, g) => sum + g.monto, 0);
            const totalRetirosEfectivo = (allData.retiros || []).filter(r => r.metodo === 'Efectivo').reduce((sum, r) => sum + r.monto, 0);
            const totalRetirosBanco = (allData.retiros || []).filter(r => r.metodo === 'Banco').reduce((sum, r) => sum + r.monto, 0);
            
            const efectivoEnCaja = (totalIngresosEfectivo + abonosEfectivo) - totalComprasEfectivo - totalGastosOp - totalRetirosEfectivo;
            const saldoEnBanco = (totalIngresosBanco + abonosBanco) - totalComprasBanco - totalRetirosBanco;
            
            const totalCPC = (cpc || []).reduce((sum, d) => sum + (d.monto - ((d.abonos || []).reduce((s, a) => s + a.monto, 0))), 0);
            const totalCPP = (cpp || []).filter(d => d.estado !== 'Pagada').reduce((sum, d) => sum + d.monto, 0);
            
            document.getElementById('total-ingresos').textContent = formatCurrency(totalIngresosMes);
            document.getElementById('total-compras').textContent = formatCurrency(totalComprasMes);
            document.getElementById('total-gastos-op').textContent = formatCurrency(totalGastosOpMes);
            document.getElementById('total-retiros').textContent = formatCurrency(totalRetirosMes);
            document.getElementById('efectivo-caja').textContent = formatCurrency(efectivoEnCaja);
            document.getElementById('saldo-banco').textContent = formatCurrency(saldoEnBanco);
            document.getElementById('cuentas-cobrar-total').textContent = formatCurrency(totalCPC);
            document.getElementById('cuentas-pagar-total').textContent = formatCurrency(totalCPP);

            const allMovements = [...(allData.ingresos || []), ...(allData.compras || []), ...(allData.gastos || []), ...(allData.retiros || [])].sort((a,b) => b.fecha - a.fecha).slice(0,10);
            const tbody = document.getElementById('ultimos-movimientos-body');
            tbody.innerHTML = allMovements.length === 0 ? `<tr><td colspan="3" class="text-center py-4 text-gray-500">No hay movimientos.</td></tr>` : '';
            allMovements.forEach(mov => {
                const tr = document.createElement('tr'); tr.className = 'bg-white border-b';
                const type = mov.monto_efectivo !== undefined ? 'ingreso' : (mov.proveedor !== undefined ? 'compra' : (mov.categoria !== undefined ? 'gasto' : 'retiro'));
                const desc = mov.descripcion || mov.proveedor || `Venta del día`;
                const montoClass = type === 'ingreso' ? 'text-green-600' : (type === 'compra' ? 'text-purple-600' : (type === 'gasto' ? 'text-red-600' : 'text-orange-500'));
                tr.innerHTML = `<td class="px-6 py-4">${mov.fecha.toLocaleDateString()}</td><td class="px-6 py-4">${desc}</td><td class="px-6 py-4 font-medium ${montoClass}">${formatCurrency(mov.monto)}</td>`;
                tbody.appendChild(tr);
            });
            updateGastosChart(ingresos);
        };
        const updateGastosChart = (gastos) => {
             const ctx = document.getElementById('gastos-chart').getContext('2d');
             if (gastosChart) gastosChart.destroy();
             const dataPorCategoria = gastos.reduce((acc, gasto) => { acc[gasto.categoria] = (acc[gasto.categoria] || 0) + gasto.monto; return acc; }, {});
             if (Object.keys(dataPorCategoria).length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.save(); ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = '#6b7280'; ctx.font = "16px 'Inter'"; ctx.fillText("No hay gastos para mostrar.", ctx.canvas.width / 2, ctx.canvas.height / 2); ctx.restore(); return; }
             gastosChart = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(dataPorCategoria), datasets: [{ data: Object.values(dataPorCategoria), backgroundColor: ['#ef4444', '#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#f59e0b', '#ec4899', '#6366f1', '#84cc16'], hoverOffset: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'top' }}} });
        };
        
        const renderAllTables = () => {
            renderTable('ingresos', document.getElementById('tabla-ingresos'), ['Fecha', 'Efectivo', 'Tarjeta', 'Total', 'Notas', 'Acciones']);
            renderTable('compras', document.getElementById('tabla-compras'), ['Fecha', 'Proveedor', 'Descripción', 'Monto', 'Pagado con', 'Acciones']);
            renderTable('gastos', document.getElementById('tabla-gastos'), ['Fecha', 'Descripción', 'Categoría', 'Monto', 'Acciones']);
            renderTable('retiros', document.getElementById('tabla-retiros'), ['Fecha', 'Retirado de', 'Descripción', 'Monto', 'Acciones']);
        };
        
        const renderTable = (type, tableEl, headers) => {
            const data = allData[type].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            tableEl.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${headers.map(h => `<th class="px-4 py-3">${h}</th>`).join('')}</tr></thead><tbody></tbody>`;
            const tbody = tableEl.querySelector('tbody');
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">No hay registros de ${type}.</td></tr>`;
                return;
            }
            const rowsHTML = data.map(item => {
                let cellsHTML = '';
                if (type === 'ingresos') cellsHTML = `<td class="px-4 py-3">${item.fecha.toLocaleDateString()}</td><td class="px-4 py-3">${formatCurrency(item.monto_efectivo)}</td><td class="px-4 py-3">${formatCurrency(item.monto_tarjeta)}</td><td class="px-4 py-3 font-bold">${formatCurrency(item.monto)}</td><td class="px-4 py-3">${item.notas || '-'}</td>`;
                else if (type === 'compras') cellsHTML = `<td class="px-4 py-3">${item.fecha.toLocaleDateString()}</td><td class="px-4 py-3">${item.proveedor}</td><td class="px-4 py-3">${item.descripcion}</td><td class="px-4 py-3">${formatCurrency(item.monto)}</td><td class="px-4 py-3">${item.metodo}</td>`;
                else if (type === 'gastos') cellsHTML = `<td class="px-4 py-3">${item.fecha.toLocaleDateString()}</td><td class="px-4 py-3">${item.descripcion}</td><td class="px-4 py-3">${item.categoria}</td><td class="px-4 py-3">${formatCurrency(item.monto)}</td>`;
                else if (type === 'retiros') cellsHTML = `<td class="px-4 py-3">${item.fecha.toLocaleDateString()}</td><td class="px-4 py-3">${item.metodo}</td><td class="px-4 py-3">${item.descripcion}</td><td class="px-4 py-3">${formatCurrency(item.monto)}</td>`;
                cellsHTML += `<td class="px-4 py-3 flex items-center space-x-2"><button class="action-button text-blue-600 edit-btn" data-type="${type}" data-id="${item.id}"><i class="fas fa-pencil-alt"></i></button><button class="action-button text-red-600 delete-btn" data-type="${type}" data-id="${item.id}"><i class="fas fa-trash"></i></button></td>`;
                return `<tr class="bg-white border-b hover:bg-gray-50">${cellsHTML}</tr>`;
            }).join('');
            tbody.innerHTML = rowsHTML;
        };

        const renderCuentasPorCobrar = () => {
            const table = document.getElementById('tabla-cuentas-cobrar');
            const headers = ['Cliente', 'Total Deuda', 'Abonado', 'Restante', 'Acciones'];
            table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${headers.map(h => `<th class="px-4 py-3">${h}</th>`).join('')}</tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            const data = allData.cuentasPorCobrar.sort((a,b) => a.cliente.localeCompare(b.cliente));
            
            const pendingDebts = data.filter(d => {
                const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0);
                return d.monto - totalAbonado > 0;
            });

            if (pendingDebts.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">No hay cuentas pendientes por cobrar.</td></tr>`; 
                return;
            }

            const rowsHTML = pendingDebts.map(d => {
                const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0);
                const restante = d.monto - totalAbonado;
                
                return `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium">${d.cliente}<p class="text-xs text-gray-500 font-normal">${d.descripcion}</p></td>
                    <td class="px-4 py-3">${formatCurrency(d.monto)}</td>
                    <td class="px-4 py-3 text-green-600">${formatCurrency(totalAbonado)}</td>
                    <td class="px-4 py-3 font-bold">${formatCurrency(restante)}</td>
                    <td class="px-4 py-3 flex items-center gap-1">
                        <button class="historial-btn bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-md hover:bg-blue-200" data-id="${d.id}">Historial</button>
                        <button class="abono-btn bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600" data-id="${d.id}">Abonar</button>
                        <button class="delete-btn action-button text-red-600" data-type="cuentasPorCobrar" data-id="${d.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
            tbody.innerHTML = rowsHTML;
        };
        
        const renderCuentasPorPagar = () => {
            const table = document.getElementById('tabla-cuentas-pagar');
            const headers = ['Proveedor', 'Concepto', 'Monto', 'Estado', 'Acciones'];
            table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${headers.map(h => `<th class="px-4 py-3">${h}</th>`).join('')}</tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            const data = allData.cuentasPorPagar.sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

            if (data.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-4 text-gray-500">No hay cuentas por pagar.</td></tr>`; 
                return;
            }

            const rowsHTML = data.map(d => {
                const isPaid = d.estado === 'Pagada';
                const rowClass = isPaid ? 'bg-gray-100 text-gray-500' : 'bg-white';
                const textStyle = isPaid ? 'line-through' : '';
                const statusBadge = isPaid 
                    ? `<span class="px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full">Pagada</span>`
                    : `<span class="px-2 py-1 font-semibold leading-tight text-red-700 bg-red-100 rounded-full">Pendiente</span>`;
                const actionButtons = isPaid 
                    ? `<span class="text-xs text-gray-400">Completado</span>` 
                    : `<div class="flex items-center gap-2">
                        <button class="pagar-btn bg-blue-500 text-white text-xs px-2 py-1 rounded-md hover:bg-blue-600" data-id="${d.id}">Pagar</button>
                        <button class="delete-btn action-button text-red-600" data-type="cuentasPorPagar" data-id="${d.id}"><i class="fas fa-trash"></i></button>
                       </div>`;

                return `<tr class="${rowClass} border-b">
                    <td class="px-4 py-3 font-medium ${textStyle}">${d.acreedor}</td>
                    <td class="px-4 py-3 ${textStyle}">${d.descripcion}</td>
                    <td class="px-4 py-3 ${textStyle}">${formatCurrency(d.monto)}</td>
                    <td class="px-4 py-3">${statusBadge}</td>
                    <td class="px-4 py-3">${actionButtons}</td>
                </tr>`;
            }).join('');
            tbody.innerHTML = rowsHTML;
        };
        
        // --- MANEJO DE FORMULARIOS (ESCRIBEN EN FIREBASE) ---
        // ========== INICIO DE LA MODIFICACIÓN: Función para corregir la hora ==========
        const getTimestampFromDateInput = (dateInputId) => {
            const dateValue = document.getElementById(dateInputId).value;
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            
            const [year, month, day] = dateValue.split('-').map(Number);
            // Crea la fecha en la zona horaria local del usuario
            const localDate = new Date(year, month - 1, day, hours, minutes, seconds);
            return localDate.toISOString();
        };
        // ========== FIN DE LA MODIFICACIÓN ==========

        const setFormDatesToToday = () => {
            const today = formatDateForInput(new Date());
            ['ingreso-fecha', 'gasto-fecha', 'compra-fecha', 'retiro-fecha'].forEach(id => { 
                const el = document.getElementById(id);
                if (el) el.value = today;
            });
        };
        const initializeDates = () => {
            setFormDatesToToday();
            const now = new Date();
            document.getElementById('month-filter').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        };

        document.getElementById('form-ingresos').addEventListener('submit', (e) => { e.preventDefault(); const ef = getNumericValue(document.getElementById('ingreso-efectivo').value); const ta = getNumericValue(document.getElementById('ingreso-tarjeta').value); const newData = { fecha: getTimestampFromDateInput('ingreso-fecha'), monto: ef + ta, monto_efectivo: ef, monto_tarjeta: ta, notas: document.getElementById('ingreso-notas').value }; dataRefs.ingresos.push(newData); showNotification('Éxito', 'Ingreso registrado.'); e.target.reset(); addCurrencyFormatting(e.target); changeTab('resumen'); });
        document.getElementById('form-compras').addEventListener('submit', (e) => { e.preventDefault(); const newData = { fecha: getTimestampFromDateInput('compra-fecha'), proveedor: document.getElementById('compra-proveedor').value, descripcion: document.getElementById('compra-descripcion').value, monto: getNumericValue(document.getElementById('compra-monto').value), metodo: document.getElementById('compra-metodo').value }; dataRefs.compras.push(newData); showNotification('Éxito', 'Compra registrada.'); e.target.reset(); addCurrencyFormatting(e.target); changeTab('resumen'); });
        document.getElementById('form-gastos').addEventListener('submit', (e) => { e.preventDefault(); const newData = { fecha: getTimestampFromDateInput('gasto-fecha'), descripcion: document.getElementById('gasto-descripcion').value, categoria: document.getElementById('gasto-categoria').value, monto: getNumericValue(document.getElementById('gasto-monto').value) }; dataRefs.gastos.push(newData); showNotification('Éxito', 'Gasto registrado.'); e.target.reset(); addCurrencyFormatting(e.target); changeTab('resumen'); });
        document.getElementById('form-retiros').addEventListener('submit', (e) => { e.preventDefault(); const newData = { fecha: getTimestampFromDateInput('retiro-fecha'), metodo: document.getElementById('retiro-metodo').value, descripcion: document.getElementById('retiro-descripcion').value, monto: getNumericValue(document.getElementById('retiro-monto').value) }; dataRefs.retiros.push(newData); showNotification('Éxito', 'Retiro registrado.'); e.target.reset(); addCurrencyFormatting(e.target); changeTab('resumen'); });
        
        document.getElementById('form-cuentas-cobrar').addEventListener('submit', (e) => {
            e.preventDefault();
            const newData = { fecha: new Date().toISOString(), cliente: document.getElementById('cpc-cliente').value, descripcion: document.getElementById('cpc-descripcion').value, monto: getNumericValue(document.getElementById('cpc-monto').value), abonos: {} };
            dataRefs.cuentasPorCobrar.push(newData);
            showNotification('Éxito', 'Deuda por cobrar registrada.');
            e.target.reset();
            addCurrencyFormatting(e.target);
        });

        document.getElementById('form-cuentas-pagar').addEventListener('submit', (e) => {
            e.preventDefault();
            const newData = { fecha: new Date().toISOString(), acreedor: document.getElementById('cpp-acreedor').value, descripcion: document.getElementById('cpp-descripcion').value, monto: getNumericValue(document.getElementById('cpp-monto').value), estado: 'Pendiente' };
            dataRefs.cuentasPorPagar.push(newData);
            showNotification('Éxito', 'Cuenta por pagar registrada.');
            e.target.reset();
            addCurrencyFormatting(e.target);
        });

        // --- LÓGICA DE EDICIÓN, ELIMINACIÓN Y DEUDAS (CON FIREBASE) ---
        const handleDelete = (type, id) => {
            showConfirm('Confirmar Eliminación', '¿Estás seguro? Esta acción no se puede deshacer.', () => {
                dataRefs[type].child(id).remove()
                    .then(() => {
                        showNotification('Éxito', 'Registro eliminado.');
                    })
                    .catch((error) => showNotification('Error', 'No se pudo eliminar: ' + error, 'error'));
            });
        };

        const handleAbonar = (deudaId) => {
            document.getElementById('abono-deuda-id').value = deudaId;
            const modal = document.getElementById('abono-modal');
            modal.style.display = 'flex';
            addCurrencyFormatting(modal); 
        };

        const handleHistorial = (deudaId) => {
            const deuda = allData.cuentasPorCobrar.find(d => d.id === deudaId);
            if (!deuda) return;

            const modal = document.getElementById('historial-modal');
            const subtitle = document.getElementById('historial-modal-subtitle');
            const tbody = document.getElementById('historial-abonos-body');

            subtitle.textContent = `Cliente: ${deuda.cliente} | Deuda Total: ${formatCurrency(deuda.monto)}`;
            
            const abonos = (deuda.abonos || []).sort((a,b) => b.fecha - a.fecha);

            if (abonos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No se han registrado abonos para esta deuda.</td></tr>`;
            } else {
                tbody.innerHTML = abonos.map(abono => {
                    return `<tr class="border-b">
                        <td class="px-4 py-3">${abono.fecha.toLocaleDateString('es-CO')}</td>
                        <td class="px-4 py-3">${abono.fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' })}</td>
                        <td class="px-4 py-3 font-medium">${formatCurrency(abono.monto)}</td>
                        <td class="px-4 py-3">${abono.metodo}</td>
                    </tr>`;
                }).join('');
            }
            modal.style.display = 'flex';
        };

        document.getElementById('save-abono-btn').addEventListener('click', () => {
            const deudaId = document.getElementById('abono-deuda-id').value;
            const monto = getNumericValue(document.getElementById('abono-monto').value);
            const metodo = document.getElementById('abono-metodo').value;
            
            if (deudaId && monto > 0) {
                const abonoData = { fecha: new Date().toISOString(), monto, metodo };
                dataRefs.cuentasPorCobrar.child(deudaId).child('abonos').push(abonoData)
                    .then(() => {
                        showNotification('Éxito', 'Abono registrado.');
                        document.getElementById('abono-modal').style.display = 'none';
                        document.getElementById('form-abono').reset();
                    })
                    .catch(err => {
                        showNotification('Error', 'No se pudo registrar el abono.', 'error');
                    });
            } else {
                showNotification('Error', 'Monto inválido.', 'error');
            }
        });

        const handlePagar = (deudaId) => {
            const deuda = allData.cuentasPorPagar.find(d => d.id === deudaId);
            if (!deuda) return;
            showConfirm('Confirmar Pago', `¿Cómo se pagó esta cuenta de ${formatCurrency(deuda.monto)} a ${deuda.acreedor}?`, (metodo) => {
                if (metodo) {
                    const compraData = {
                        fecha: new Date().toISOString(),
                        proveedor: deuda.acreedor,
                        descripcion: `Pago Cta. Pendiente: ${deuda.descripcion}`,
                        monto: deuda.monto,
                        metodo: metodo
                    };
                    dataRefs.compras.push(compraData);
                    dataRefs.cuentasPorPagar.child(deudaId).update({ estado: 'Pagada' });
                    showNotification('Éxito', `Cuenta pagada y registrada como compra.`);
                }
            }, true);
        };
        
        const handleEdit = (type, id) => {
            if (type.startsWith('cuentas')) {
                showNotification('Info', 'La edición de deudas no está disponible. Elimine y vuelva a crear si es necesario.');
                return;
            }
            const item = allData[type].find(i => i.id === id);
            if (!item) return;
            
            const modal = document.getElementById('edit-modal');
            const form = document.getElementById('edit-form');
            const title = document.getElementById('edit-modal-title');
            form.innerHTML = '';

            let formContent = `<input type="hidden" id="edit-id" value="${item.id}"><input type="hidden" id="edit-type" value="${type}"><div><label class="block text-sm font-medium">Fecha</label><input type="date" id="edit-fecha" value="${formatDateForInput(item.fecha)}" class="mt-1 block w-full rounded-md" required></div>`;

            if (type === 'ingresos') {
                title.textContent = 'Editar Ingreso';
                formContent += `<div><label>Efectivo</label><input type="text" data-moneda inputmode="numeric" id="edit-efectivo" value="${item.monto_efectivo.toLocaleString('es-CO')}" class="mt-1 block w-full"></div><div><label>Tarjeta/Transf.</label><input type="text" data-moneda inputmode="numeric" id="edit-tarjeta" value="${item.monto_tarjeta.toLocaleString('es-CO')}" class="mt-1 block w-full"></div><div><label>Notas</label><textarea id="edit-notas" class="mt-1 block w-full">${item.notas || ''}</textarea></div>`;
            } else if (type === 'compras') {
                title.textContent = 'Editar Compra';
                formContent += `<div><label>Proveedor</label><input type="text" id="edit-proveedor" value="${item.proveedor}" class="mt-1 block w-full"></div><div><label>Descripción</label><input type="text" id="edit-descripcion" value="${item.descripcion}" class="mt-1 block w-full"></div><div><label>Monto</label><input type="text" data-moneda inputmode="numeric" id="edit-monto" value="${item.monto.toLocaleString('es-CO')}" class="mt-1 block w-full"></div><div><label>Pagado con</label><select id="edit-metodo" class="mt-1 block w-full"><option value="Efectivo" ${item.metodo === 'Efectivo' ? 'selected' : ''}>Efectivo</option><option value="Banco" ${item.metodo === 'Banco' ? 'selected' : ''}>Banco</option></select></div>`;
            } else if (type === 'gastos') {
                title.textContent = 'Editar Gasto';
                const cat = ['Arriendo', 'Servicios', 'Nómina', 'Marketing', 'Mantenimiento', 'Impuestos', 'Insumos', 'Otro'];
                const opt = cat.map(c => `<option value="${c}" ${item.categoria === c ? 'selected' : ''}>${c}</option>`).join('');
                formContent += `<div><label>Descripción</label><input type="text" id="edit-descripcion" value="${item.descripcion}" class="mt-1 block w-full"></div><div><label>Categoría</label><select id="edit-categoria" class="mt-1 block w-full">${opt}</select></div><div><label>Monto</label><input type="text" data-moneda inputmode="numeric" id="edit-monto" value="${item.monto.toLocaleString('es-CO')}" class="mt-1 block w-full"></div>`;
            } else if (type === 'retiros') {
                title.textContent = 'Editar Retiro';
                formContent += `<div><label>Retirado de</label><select id="edit-metodo" class="mt-1 block w-full"><option value="Efectivo" ${item.metodo === 'Efectivo' ? 'selected' : ''}>Efectivo</option><option value="Banco" ${item.metodo === 'Banco' ? 'selected' : ''}>Banco</option></select></div><div><label>Descripción</label><input type="text" id="edit-descripcion" value="${item.descripcion}" class="mt-1 block w-full"></div><div><label>Monto</label><input type="text" data-moneda inputmode="numeric" id="edit-monto" value="${item.monto.toLocaleString('es-CO')}" class="mt-1 block w-full"></div>`;
            }

            form.innerHTML = formContent;
            addCurrencyFormatting(form); 
            modal.style.display = 'flex';
        };

        document.getElementById('save-edit-btn').addEventListener('click', () => {
            const form = document.getElementById('edit-form');
            const type = form.querySelector('#edit-type').value;
            const id = form.querySelector('#edit-id').value;
            
            const newItem = {
                fecha: getTimestampFromDateInput('edit-fecha')
            };

            if (type === 'ingresos') {
                const ef = getNumericValue(document.getElementById('edit-efectivo').value);
                const ta = getNumericValue(document.getElementById('edit-tarjeta').value);
                newItem.monto_efectivo = ef;
                newItem.monto_tarjeta = ta;
                newItem.monto = ef + ta;
                newItem.notas = document.getElementById('edit-notas').value;
            } else if (type === 'compras') {
                newItem.proveedor = document.getElementById('edit-proveedor').value;
                newItem.descripcion = document.getElementById('edit-descripcion').value;
                newItem.monto = getNumericValue(document.getElementById('edit-monto').value);
                newItem.metodo = document.getElementById('edit-metodo').value;
            } else if (type === 'gastos') {
                newItem.descripcion = document.getElementById('edit-descripcion').value;
                newItem.categoria = document.getElementById('edit-categoria').value;
                newItem.monto = getNumericValue(document.getElementById('edit-monto').value);
            } else if (type === 'retiros') {
                newItem.metodo = document.getElementById('edit-metodo').value;
                newItem.descripcion = document.getElementById('edit-descripcion').value;
                newItem.monto = getNumericValue(document.getElementById('edit-monto').value);
            }

            dataRefs[type].child(id).update(newItem)
                .then(() => {
                    document.getElementById('edit-modal').style.display = 'none';
                    showNotification('Éxito', 'Registro actualizado.');
                })
                .catch(err => {
                    showNotification('Error', `No se pudo actualizar el registro: ${err.message}`, 'error');
                });
        });
        
        // --- MANEJO DE MODALES ---
        const showNotification = (title, message, type = 'success') => {
             const modal = document.getElementById('notification-modal'); document.getElementById('notification-title').textContent = title; document.getElementById('notification-message').textContent = message; document.getElementById('notification-icon').innerHTML = type === 'success' ? `<i class="fas fa-check-circle text-4xl text-green-500"></i>` : `<i class="fas fa-times-circle text-4xl text-red-500"></i>`; modal.style.display = 'flex';
        };
        const showConfirm = (title, message, callback, showOptions = false) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').textContent = title;
            const msgContainer = document.getElementById('confirm-message-container');
            msgContainer.innerHTML = `<p id="confirm-message" class="text-sm text-gray-500">${message}</p>`;
            if (showOptions) {
                const customContent = `<div class="mt-4"><select id="confirm-options" class="block w-full rounded-md border-gray-300 shadow-sm"><option value="Efectivo">Efectivo</option><option value="Banco">Banco</option></select></div>`;
                msgContainer.insertAdjacentHTML('beforeend', customContent);
            }
            confirmCallback = () => {
                const optionsEl = document.getElementById('confirm-options');
                callback(showOptions ? optionsEl.value : true);
            };
            modal.style.display = 'flex';
        };
        const cleanupConfirmModal = () => {
             const modal = document.getElementById('confirm-modal');
             const customContent = document.querySelector('#confirm-message-container > div');
             if (customContent) customContent.remove();
             modal.style.display = 'none';
             confirmCallback = null;
        };
        document.getElementById('notification-close').onclick = () => document.getElementById('notification-modal').style.display = 'none';
        document.getElementById('cancel-confirm-btn').onclick = cleanupConfirmModal;
        document.getElementById('confirm-btn').addEventListener('click', () => { if (confirmCallback) { confirmCallback(); } cleanupConfirmModal(); });
        document.getElementById('cancel-edit-btn').onclick = () => document.getElementById('edit-modal').style.display = 'none';
        document.getElementById('cancel-abono-btn').onclick = () => document.getElementById('abono-modal').style.display = 'none';
        document.getElementById('cancel-password-btn').onclick = () => document.getElementById('password-modal').style.display = 'none';
        document.getElementById('cancel-historial-btn').onclick = () => document.getElementById('historial-modal').style.display = 'none';

        // --- EXPORTAR A PDF ---
        const exportToPDF = (type) => {
            const doc = new jsPDF();
            const data = [...allData[type]].sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            if(data.length === 0){ showNotification('Info', 'No hay datos para exportar.', 'error'); return; }
            
            const title = `Informe de ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            doc.setFontSize(18); doc.text(title, 14, 22);
            doc.setFontSize(11); doc.setTextColor(100); doc.text(`Generado el: ${new Date().toLocaleDateString('es-CO')}`, 14, 28);
            let startY = 35;

            if (type === 'ingresos') {
                const ingresosEfectivo = data.filter(i => i.monto_efectivo > 0);
                const ingresosTarjeta = data.filter(i => i.monto_tarjeta > 0);
                const totalEfectivo = ingresosEfectivo.reduce((sum, i) => sum + i.monto_efectivo, 0);
                const totalTarjeta = ingresosTarjeta.reduce((sum, i) => sum + i.monto_tarjeta, 0);

                doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text('Ingresos en Efectivo', 14, startY);
                const headEfectivo = [['Fecha', 'Notas', 'Monto']];
                const bodyEfectivo = ingresosEfectivo.map(i => [i.fecha.toLocaleDateString(), i.notas || '-', formatCurrency(i.monto_efectivo)]);
                doc.autoTable({ head: headEfectivo, body: bodyEfectivo, startY: startY + 2 });
                
                startY = doc.autoTable.previous.finalY + 5;
                doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text('Total Efectivo:', 14, startY);
                doc.text(formatCurrency(totalEfectivo), 200, startY, { align: 'right' });
                startY += 15;

                if (startY > 250) { doc.addPage(); startY = 20; }

                doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text('Ingresos por Tarjeta/Transferencia', 14, startY);
                const headTarjeta = [['Fecha', 'Notas', 'Monto']];
                const bodyTarjeta = ingresosTarjeta.map(i => [i.fecha.toLocaleDateString(), i.notas || '-', formatCurrency(i.monto_tarjeta)]);
                doc.autoTable({ head: headTarjeta, body: bodyTarjeta, startY: startY + 2 });

                startY = doc.autoTable.previous.finalY + 5;
                doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text('Total Tarjeta/Transf.:', 14, startY);
                doc.text(formatCurrency(totalTarjeta), 200, startY, { align: 'right' });
                startY += 15;
                
                if (startY > 250) { doc.addPage(); startY = 20; }

                doc.setLineWidth(0.5); doc.line(14, startY, 200, startY); startY += 10;
                doc.setFontSize(14); doc.setFont(undefined, 'bold');
                doc.text('CONSOLIDADO GLOBAL', 14, startY);
                doc.setFontSize(12); doc.setFont(undefined, 'normal');
                doc.text(`Total Efectivo:`, 14, startY + 7);
                doc.text(formatCurrency(totalEfectivo), 200, startY + 7, { align: 'right' });
                doc.text(`Total Tarjeta/Transf.:`, 14, startY + 14);
                doc.text(formatCurrency(totalTarjeta), 200, startY + 14, { align: 'right' });
                doc.setFont(undefined, 'bold');
                doc.text(`Venta Global:`, 14, startY + 21);
                doc.text(formatCurrency(totalEfectivo + totalTarjeta), 200, startY + 21, { align: 'right' });

            } else if (type === 'retiros') {
                const head = [['Fecha', 'Hora', 'Retirado de', 'Descripción', 'Monto']];
                const body = data.map(r => [
                    r.fecha.toLocaleDateString('es-CO'),
                    r.fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' }),
                    r.metodo,
                    r.descripcion,
                    formatCurrency(r.monto)
                ]);
                doc.autoTable({ head, body, startY: 35 });

                const grandTotal = data.reduce((sum, r) => sum + r.monto, 0);
                let finalY = doc.autoTable.previous.finalY;

                doc.setLineWidth(0.5);
                doc.line(14, finalY + 8, 200, finalY + 8);
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Gran Total de Retiros:', 14, finalY + 15);
                doc.text(formatCurrency(grandTotal), 200, finalY + 15, { align: 'right' });
            
            } else { // Gastos y Compras
                const groupKey = type === 'gastos' ? 'categoria' : 'proveedor';
                const groupedData = data.reduce((acc, item) => {
                    const key = item[groupKey];
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(item);
                    return acc;
                }, {});

                let grandTotal = 0;
                for (const groupName in groupedData) {
                    if (startY > 250) { doc.addPage(); startY = 20; }
                    const items = groupedData[groupName];
                    const subTotal = items.reduce((sum, item) => sum + item.monto, 0);
                    grandTotal += subTotal;
                    doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text(groupName, 14, startY);
                    const head = type === 'gastos' ? [['Fecha', 'Descripción', 'Monto']] : [['Fecha', 'Descripción', 'Pagado con', 'Monto']];
                    const body = items.map(item => type === 'gastos' ? [item.fecha.toLocaleDateString(), item.descripcion, formatCurrency(item.monto)] : [item.fecha.toLocaleDateString(), item.descripcion, item.metodo, formatCurrency(item.monto)]);
                    doc.autoTable({ head: head, body: body, startY: startY + 2, theme: 'striped', headStyles: { fillColor: [52, 73, 94] } });
                    startY = doc.autoTable.previous.finalY + 2;
                    doc.setFontSize(10); doc.setFont(undefined, 'bold');
                    doc.text(`Subtotal ${groupName}: ${formatCurrency(subTotal)}`, 196, startY, { align: 'right' });
                    startY += 10;
                }
                
                doc.setLineWidth(0.5); doc.line(14, startY, 200, startY); startY += 8;
                doc.setFontSize(16); doc.setFont(undefined, 'bold');
                doc.text('GRAN TOTAL:', 14, startY);
                doc.text(formatCurrency(grandTotal), 200, startY, { align: 'right' });
            }
            doc.save(`Informe_${type}_${formatDateForInput(new Date())}.pdf`);
        };

        const exportDeudasPDF = (type) => {
            const doc = new jsPDF();
            const genDate = `Generado el: ${new Date().toLocaleDateString('es-CO')}`;

            if (type === 'cuentasPorCobrar') {
                const data = allData.cuentasPorCobrar;
                if(data.length === 0){ showNotification('Info', 'No hay datos para exportar.', 'error'); return; }

                doc.setFontSize(18); doc.text('Reporte de Cuentas por Cobrar', 14, 22);
                doc.setFontSize(11); doc.setTextColor(100); doc.text(genDate, 14, 28);

                let grandTotalDeuda = 0;
                let grandTotalAbonado = 0;
                let grandTotalSaldo = 0;
                
                const head = [['Cliente', 'Descripción', 'Deuda Total', 'Total Abonado', 'Saldo Pendiente']];
                const body = data.map(d => {
                    const totalAbonado = (d.abonos || []).reduce((sum, a) => sum + a.monto, 0);
                    const saldo = d.monto - totalAbonado;
                    grandTotalDeuda += d.monto;
                    grandTotalAbonado += totalAbonado;
                    grandTotalSaldo += saldo;
                    return [d.cliente, d.descripcion, formatCurrency(d.monto), formatCurrency(totalAbonado), formatCurrency(saldo)];
                });

                doc.autoTable({ head, body, startY: 35 });
                let finalY = doc.autoTable.previous.finalY;

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('GRANDES TOTALES', 14, finalY + 15);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Total de Abonos Recibidos:`, 14, finalY + 22);
                doc.text(formatCurrency(grandTotalAbonado), 200, finalY + 22, { align: 'right' });
                doc.text(`Saldo Total por Cobrar:`, 14, finalY + 29);
                doc.setFont(undefined, 'bold');
                doc.text(formatCurrency(grandTotalSaldo), 200, finalY + 29, { align: 'right' });

                doc.save(`Reporte_Cuentas_por_Cobrar_${formatDateForInput(new Date())}.pdf`);

            } else if (type === 'cuentasPorPagar') {
                const data = allData.cuentasPorPagar;
                if(data.length === 0){ showNotification('Info', 'No hay datos para exportar.', 'error'); return; }
                
                doc.setFontSize(18); doc.text('Reporte de Cuentas por Pagar', 14, 22);
                doc.setFontSize(11); doc.setTextColor(100); doc.text(genDate, 14, 28);
                
                const head = [['Proveedor', 'Concepto', 'Monto Total', 'Estado']];
                const body = data.map(d => [d.acreedor, d.descripcion, formatCurrency(d.monto), d.estado]);
                doc.autoTable({ head, body, startY: 35 });

                const now = new Date();
                const pagosDeDeudasEsteMes = allData.compras.filter(compra => 
                    compra.descripcion.startsWith('Pago Cta. Pendiente:') &&
                    compra.fecha.getFullYear() === now.getFullYear() &&
                    compra.fecha.getMonth() === now.getMonth()
                );
                const grandTotalPagadoEsteMes = pagosDeDeudasEsteMes.reduce((sum, c) => sum + c.monto, 0);
                const grandTotalDeudaPendiente = data.filter(d => d.estado !== 'Pagada').reduce((sum, d) => sum + d.monto, 0);
                
                let finalY = doc.autoTable.previous.finalY;

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('GRANDES TOTALES', 14, finalY + 15);

                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Total Pagado de Deudas (Este Mes):`, 14, finalY + 22);
                doc.text(formatCurrency(grandTotalPagadoEsteMes), 200, finalY + 22, { align: 'right' });
                doc.text(`Total de Dinero Pendiente por Pagar:`, 14, finalY + 29);
                doc.setFont(undefined, 'bold');
                doc.text(formatCurrency(grandTotalDeudaPendiente), 200, finalY + 29, { align: 'right' });

                doc.save(`Reporte_Cuentas_por_Pagar_${formatDateForInput(new Date())}.pdf`);
            }
        };

        // --- INICIALIZACIÓN Y EVENT LISTENERS GLOBALES ---
        const initApp = () => {
            document.getElementById('app-container').classList.remove('hidden');
            initializeDates();
            addCurrencyFormatting(document.getElementById('app-container'));
            
            Object.keys(dataRefs).forEach(key => {
                if (key === 'password') return; 
                dataRefs[key].on('value', snapshot => {
                    allData[key] = firebaseObjectToArray(snapshot);
                    refreshUI();
                });
            });

            const togglePasswordVisibility = (e) => {
                const icon = e.currentTarget.querySelector('i');
                const input = e.currentTarget.previousElementSibling;
                if (input.type === "password") {
                    input.type = "text";
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = "password";
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            };

            document.querySelectorAll('.toggle-password').forEach(el => {
                el.addEventListener('click', togglePasswordVisibility);
            });

            document.getElementById('month-filter').addEventListener('change', filterAndRenderDashboard);
            document.body.addEventListener('click', (e) => {
                const target = e.target;
                const editBtn = target.closest('.edit-btn');
                const deleteBtn = target.closest('.delete-btn');
                const pdfBtn = target.closest('.btn-pdf');
                const tabBtn = target.closest('.tab-button');
                const abonoBtn = target.closest('.abono-btn');
                const pagarBtn = target.closest('.pagar-btn');
                const settingsBtn = target.closest('#settings-btn');
                const historialBtn = target.closest('.historial-btn');
                
                if (tabBtn) changeTab(tabBtn.dataset.tab);
                else if (editBtn) handleEdit(editBtn.dataset.type, editBtn.dataset.id);
                else if (deleteBtn) handleDelete(deleteBtn.dataset.type, deleteBtn.dataset.id);
                else if (pdfBtn) {
                    const type = pdfBtn.dataset.type;
                    if (type === 'deudas-cobrar') {
                        exportDeudasPDF('cuentasPorCobrar');
                    } else if (type === 'deudas-pagar') {
                        exportDeudasPDF('cuentasPorPagar');
                    } else {
                        exportToPDF(type);
                    }
                }
                else if (abonoBtn) handleAbonar(abonoBtn.dataset.id);
                else if (pagarBtn) handlePagar(pagarBtn.dataset.id);
                else if (historialBtn) handleHistorial(historialBtn.dataset.id);
                else if (settingsBtn) {
                    document.getElementById('form-password').reset();
                    document.getElementById('password-error').classList.add('hidden');
                    document.getElementById('password-modal').style.display = 'flex';
                }
            });
        };

        // --- LÓGICA PARA CAMBIAR CONTRASEÑA ---
        document.getElementById('save-password-btn').addEventListener('click', () => {
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            const errorEl = document.getElementById('password-error');
            
            errorEl.classList.add('hidden');

            if (!newPass || !confirmPass) {
                errorEl.textContent = 'Ambos campos son obligatorios.';
                errorEl.classList.remove('hidden');
                return;
            }
            if (newPass !== confirmPass) {
                errorEl.textContent = 'Las contraseñas no coinciden.';
                errorEl.classList.remove('hidden');
                return;
            }
            if (newPass.length < 4) {
                errorEl.textContent = 'La nueva contraseña debe tener al menos 4 caracteres.';
                errorEl.classList.remove('hidden');
                return;
            }

            dataRefs.password.set(newPass)
                .then(() => {
                    showNotification('Éxito', 'La contraseña se ha cambiado correctamente.');
                    document.getElementById('password-modal').style.display = 'none';
                })
                .catch(err => {
                    showNotification('Error', 'No se pudo guardar la nueva contraseña.', 'error');
                });
        });

        // --- LÓGICA DE LOGIN ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const passwordInput = document.getElementById('password');
            const errorEl = document.getElementById('login-error');
            
            dataRefs.password.once('value', (snapshot) => {
                const correctPassword = snapshot.val();
                if (correctPassword === null) {
                    errorEl.innerHTML = 'Error de configuración: No se encontró la contraseña en la base de datos. Por favor, configúrela en Firebase en la ruta `config/password`.';
                    errorEl.classList.remove('hidden');
                    return;
                }
                if (passwordInput.value === correctPassword) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    document.getElementById('login-overlay').classList.add('hidden');
                    initApp();
                } else {
                    errorEl.textContent = 'Contraseña incorrecta. Intente de nuevo.';
                    errorEl.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }).catch(error => {
                errorEl.innerHTML = 'Error al conectar con la base de datos. Verifique la conexión y la configuración de Firebase.';
                errorEl.classList.remove('hidden');
            });
        });
        
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            document.getElementById('login-overlay').classList.add('hidden');
            initApp();
        } else {
            document.getElementById('login-overlay').classList.remove('hidden');
        }
    });
    </script>
</body>
</html>
